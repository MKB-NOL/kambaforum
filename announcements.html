<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KAMBA Forum - Announcements</title>
  
  <!-- Favicon -->
  <link rel="icon" type="image/x-icon" href="favicon.ico" />

  <!-- Open Graph Meta Tags -->
  <meta property="og:title" content="KAMBA Forum - Announcements" />
  <meta property="og:description" content="Official announcements from KAMBA Forum" />
  <meta property="og:image" content="https://i.ibb.co/TRXscBP/KAMBA-Logo-2.png" />
  <meta property="og:url" content="https://kamba-forum.com/announcements" />
  <meta property="og:type" content="website" />

  <!-- Twitter Card Meta Tags -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="KAMBA Forum - Announcements" />
  <meta name="twitter:description" content="Official announcements from KAMBA Forum" />
  <meta name="twitter:image" content="https://i.ibb.co/TRXscBP/KAMBA-Logo-2.png" />

  <style>
    /* Base styles (same as hello.html) */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Poppins', sans-serif;
    }
    body, html {
      height: 100%;
      background-color: #36393f;
      color: #dcddde;
      display: flex;
      flex-direction: column;
    }
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
    
    header {
      background-color: #2f3136;
      padding: 1rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: white;
      border-bottom: 1px solid #202225;
    }
    header h1 {
      margin: 0;
      font-size: 1.5rem;
    }
    #main-content {
      display: flex;
      flex: 1;
      overflow: hidden;
    }
    
    /* Left sidebar (same as hello.html) */
    #left-sidebar {
      width: 250px;
      background-color: #2f3136;
      border-right: 1px solid #202225;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
    }
    .sidebar-section {
      margin-bottom: 1.5rem;
    }
    .sidebar-title {
      color: #b9bbbe;
      font-size: 0.8rem;
      text-transform: uppercase;
      margin-bottom: 0.5rem;
      padding-left: 0.5rem;
    }
    .sidebar-item {
      display: flex;
      align-items: center;
      padding: 0.5rem;
      border-radius: 4px;
      cursor: pointer;
      margin-bottom: 0.3rem;
      transition: background-color 0.2s;
    }
    .sidebar-item:hover {
      background-color: #3a3d44;
    }
    .sidebar-item.active {
      background-color: #40444b;
    }
    .sidebar-item .dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-right: 0.8rem;
      background-color: #b9bbbe;
    }
    .sidebar-item.active .dot {
      background-color: #5865f2;
    }
    .sidebar-item .icon {
      margin-right: 0.8rem;
      font-size: 1.1rem;
      width: 20px;
      text-align: center;
    }
    
    /* Announcements-specific styles */
    #announcements-container {
      flex: 1;
      padding: 1rem;
      overflow-y: auto;
      background-color: #36393f;
    }
    
    .announcement-card {
      background-color: #2f3136;
      border-radius: 8px;
      margin-bottom: 1rem;
      overflow: hidden;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
    }
    
    .announcement-header {
      padding: 1rem;
      background-color: #292b2f;
      border-bottom: 1px solid #202225;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .announcement-title {
      font-size: 1.2rem;
      font-weight: 600;
      color: white;
      margin-bottom: 0.5rem;
    }
    
    .announcement-meta {
      display: flex;
      align-items: center;
      font-size: 0.8rem;
      color: #b9bbbe;
    }
    
    .announcement-author {
      font-weight: 600;
      color: #5865f2;
      margin-right: 0.5rem;
    }
    
    .announcement-time {
      margin-right: 0.5rem;
    }
    
    .announcement-content {
      padding: 1rem;
      line-height: 1.6;
    }
    
    .announcement-content p {
      margin-bottom: 1rem;
    }
    
    .announcement-content a {
      color: #5865f2;
      text-decoration: none;
    }
    
    .announcement-content a:hover {
      text-decoration: underline;
    }
    
    .announcement-actions {
      padding: 0.5rem 1rem;
      background-color: #292b2f;
      border-top: 1px solid #202225;
      display: flex;
      gap: 1rem;
    }
    
    .announcement-action {
      color: #b9bbbe;
      font-size: 0.9rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.3rem;
    }
    
    .announcement-action:hover {
      color: white;
    }
    
    .announcement-action i {
      font-size: 1rem;
    }
    
    /* Right sidebar (same as hello.html) */
    #right-sidebar {
      width: 80px;
      background-color: #2f3136;
      border-left: 1px solid #202225;
      padding: 1rem 0.5rem;
      overflow-y: auto;
      transition: width 0.3s ease;
      resize: horizontal;
      min-width: 80px;
      max-width: 300px;
    }
    
    /* Create announcement modal */
    #create-announcement-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.7);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    
    #create-announcement-content {
      background-color: #2f3136;
      padding: 1.5rem;
      border-radius: 8px;
      width: 90%;
      max-width: 600px;
    }
    
    .modal-title {
      margin-bottom: 1rem;
      color: white;
    }
    
    .form-group {
      margin-bottom: 1rem;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      color: #b9bbbe;
    }
    
    .form-group input,
    .form-group textarea {
      width: 100%;
      padding: 0.8rem;
      border-radius: 4px;
      border: none;
      background-color: #40444b;
      color: white;
    }
    
    .form-group textarea {
      min-height: 150px;
      resize: vertical;
    }
    
    .modal-buttons {
      display: flex;
      justify-content: flex-end;
      gap: 0.5rem;
      margin-top: 1rem;
    }
    
    .modal-btn {
      padding: 0.5rem 1rem;
      border-radius: 4px;
      border: none;
      cursor: pointer;
    }
    
    .modal-btn.cancel {
      background-color: #72767d;
      color: white;
    }
    
    .modal-btn.submit {
      background-color: #5865f2;
      color: white;
    }
    
    /* Status colors */
    .username.green { color: #43b581; }
    .username.blue { color: #5865f2; }
    .username.violet { color: #9b59b6; }
    .username.red { color: #f04747; }
    
    /* Scrollbar styling */
    ::-webkit-scrollbar {
      width: 8px;
    }
    ::-webkit-scrollbar-thumb {
      background-color: #5865f2;
      border-radius: 5px;
    }
  </style>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>

<!-- Create Announcement Modal -->
<div id="create-announcement-modal">
  <div id="create-announcement-content">
    <h3 class="modal-title">Create Announcement</h3>
    <div class="form-group">
      <label for="announcement-title">Title</label>
      <input type="text" id="announcement-title" placeholder="Enter announcement title" required>
    </div>
    <div class="form-group">
      <label for="announcement-content">Content</label>
      <textarea id="announcement-content" placeholder="Write your announcement here (Markdown supported)" required></textarea>
    </div>
    <div class="modal-buttons">
      <button class="modal-btn cancel" id="cancel-announcement">Cancel</button>
      <button class="modal-btn submit" id="submit-announcement">Post Announcement</button>
    </div>
  </div>
</div>

<!-- Edit Announcement Modal -->
<div id="edit-announcement-modal" class="modal">
  <div class="modal-content">
    <h3 class="modal-title">Edit Announcement</h3>
    <div class="form-group">
      <label for="edit-announcement-title">Title</label>
      <input type="text" id="edit-announcement-title" required>
    </div>
    <div class="form-group">
      <label for="edit-announcement-content">Content</label>
      <textarea id="edit-announcement-content" required></textarea>
    </div>
    <div class="modal-buttons">
      <button class="modal-btn cancel" id="cancel-edit-announcement">Cancel</button>
      <button class="modal-btn submit" id="save-edit-announcement">Save Changes</button>
    </div>
  </div>
</div>

<header>
  <h1>KAMBA Forum - Announcements</h1>
  <button id="new-announcement-btn" style="background-color: #5865f2; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">
    <i class="fas fa-plus"></i> New Announcement
  </button>
</header>

<div id="main-content">
  <!-- Left Sidebar (same as hello.html) -->
  <div id="left-sidebar">
    <div class="sidebar-item" id="home-btn">
      <div class="icon"><i class="fas fa-home"></i></div>
      <span>Home</span>
    </div>
    
    <div class="sidebar-item" id="profile-btn">
      <div class="icon"><i class="fas fa-user"></i></div>
      <span>Profile</span>
    </div>
    
    <div class="sidebar-item" id="create-btn">
      <div class="icon"><i class="fas fa-plus"></i></div>
      <span>Create</span>
    </div>
    
    <div class="sidebar-item" id="notifications-btn">
      <div class="icon"><i class="fas fa-bell"></i></div>
      <span>Notifications</span>
    </div>
    
    <div class="sidebar-section">
      <div class="sidebar-title">Channels</div>
      <div class="sidebar-item" data-channel="general" onclick="window.location.href='hello.html'">
        <div class="dot"></div>
        <span>#General</span>
      </div>
      <div class="sidebar-item active" data-channel="announcements">
        <div class="dot"></div>
        <span>#Announcements</span>
      </div>
      <div class="sidebar-item" data-channel="communities" onclick="window.location.href='communities.html'">
        <div class="dot"></div>
        <span>#Communities</span>
      </div>
      <div class="sidebar-item" data-channel="posts" onclick="window.location.href='posts.html'">
        <div class="dot"></div>
        <span>#Posts</span>
      </div>
      <div class="sidebar-item" data-channel="projects" onclick="window.location.href='projects.html'">
        <div class="dot"></div>
        <span>#Projects</span>
      </div>
    </div>
    
    <!-- User Profile Section -->
    <div id="user-profile">
      <div id="profile-pic"></div>
      <div id="profile-name"></div>
      <div id="profile-status">
        <div id="status-dot"></div>
        <span id="status-text"></span>
      </div>
    </div>
  </div>
  
  <!-- Main Announcements Area -->
  <div id="announcements-container">
    <!-- Announcements will be loaded here -->
  </div>

  <!-- Right Sidebar -->
  <div id="right-sidebar">
    <div class="right-sidebar-title">GROUPS</div>
    <!-- Groups will be added dynamically -->
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
  import {
    getAuth,
    onAuthStateChanged,
  } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
  import {
    getFirestore,
    collection,
    query,
    orderBy,
    onSnapshot,
    addDoc,
    doc,
    getDoc,
    updateDoc,
    deleteDoc,
    serverTimestamp,
  } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
  import { marked } from "https://cdn.jsdelivr.net/npm/marked/lib/marked.esm.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCW2RJIku0JLJZTUu0YA9yKO8zjtX29fAo",
    authDomain: "muah-feed.firebaseapp.com",
    databaseURL: "https://muah-feed-default-rtdb.firebaseio.com",
    projectId: "muah-feed",
    storageBucket: "muah-feed.firebasestorage.app",
    messagingSenderId: "442314397706",
    appId: "1:442314397706:web:a69e3958257fb13b3667f3",
    measurementId: "G-S86S229F1T",
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // DOM Elements
  const announcementsContainer = document.getElementById("announcements-container");
  const newAnnouncementBtn = document.getElementById("new-announcement-btn");
  const createAnnouncementModal = document.getElementById("create-announcement-modal");
  const cancelAnnouncementBtn = document.getElementById("cancel-announcement");
  const submitAnnouncementBtn = document.getElementById("submit-announcement");
  const announcementTitleInput = document.getElementById("announcement-title");
  const announcementContentInput = document.getElementById("announcement-content");
  const editAnnouncementModal = document.getElementById("edit-announcement-modal");
  const editAnnouncementTitle = document.getElementById("edit-announcement-title");
  const editAnnouncementContent = document.getElementById("edit-announcement-content");
  const cancelEditAnnouncementBtn = document.getElementById("cancel-edit-announcement");
  const saveEditAnnouncementBtn = document.getElementById("save-edit-announcement");
  const profilePic = document.getElementById("profile-pic");
  const profileName = document.getElementById("profile-name");
  const statusDot = document.getElementById("status-dot");
  const statusText = document.getElementById("status-text");

  // App State
  let currentUser = null;
  let currentUserData = null;
  let currentEditingAnnouncementId = null;

  // Initialize the app
  function init() {
    setupEventListeners();
    checkAuthState();
  }

  // Set up all event listeners
  function setupEventListeners() {
    // New announcement button
    newAnnouncementBtn.addEventListener("click", () => {
      // Check if user is admin (only admins can create announcements)
      if (currentUserData?.isAdmin) {
        createAnnouncementModal.style.display = "flex";
        announcementTitleInput.focus();
      } else {
        alert("Only administrators can create announcements.");
      }
    });

    // Create announcement modal
    cancelAnnouncementBtn.addEventListener("click", () => {
      createAnnouncementModal.style.display = "none";
      announcementTitleInput.value = "";
      announcementContentInput.value = "";
    });

    submitAnnouncementBtn.addEventListener("click", createAnnouncement);

    // Edit announcement modal
    cancelEditAnnouncementBtn.addEventListener("click", () => {
      editAnnouncementModal.style.display = "none";
      currentEditingAnnouncementId = null;
    });

    saveEditAnnouncementBtn.addEventListener("click", saveEditedAnnouncement);

    // Navigation buttons
    document.getElementById("home-btn").addEventListener("click", () => {
      window.location.href = "hello.html";
    });
    
    document.getElementById("profile-btn").addEventListener("click", () => {
      window.location.href = "settings.html";
    });
    
    document.getElementById("create-btn").addEventListener("click", () => {
      window.location.href = "hello.html#create"; // Redirect to main create page
    });
    
    document.getElementById("notifications-btn").addEventListener("click", () => {
      alert("Notifications feature will be implemented in the next update");
    });
  }

  // Create a new announcement
  async function createAnnouncement() {
    const title = announcementTitleInput.value.trim();
    const content = announcementContentInput.value.trim();

    if (!title || !content) {
      alert("Please fill in both title and content");
      return;
    }

    try {
      await addDoc(collection(db, "Kamba_announcements"), {
        title,
        content,
        authorId: currentUser.uid,
        authorEmail: currentUser.email,
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp(),
        isPinned: false,
        views: 0
      });

      // Clear inputs and close modal
      announcementTitleInput.value = "";
      announcementContentInput.value = "";
      createAnnouncementModal.style.display = "none";
    } catch (error) {
      console.error("Error creating announcement:", error);
      alert("Failed to create announcement");
    }
  }

  // Load announcements from Firestore
  function loadAnnouncements() {
    announcementsContainer.innerHTML = "<div style='text-align: center; padding: 2rem;'>Loading announcements...</div>";

    const announcementsQuery = query(
      collection(db, "Kamba_announcements"),
      orderBy("isPinned", "desc"),
      orderBy("createdAt", "desc")
    );

    const unsubscribe = onSnapshot(announcementsQuery, async (snapshot) => {
      announcementsContainer.innerHTML = "";

      if (snapshot.empty) {
        announcementsContainer.innerHTML = "<div style='text-align: center; padding: 2rem; color: #b9bbbe;'>No announcements yet</div>";
        return;
      }

      // Preload author data
      const authorIds = new Set();
      snapshot.forEach(doc => {
        authorIds.add(doc.data().authorId);
      });

      const authorDataMap = new Map();
      const authorPromises = Array.from(authorIds).map(async (uid) => {
        const userDoc = await getDoc(doc(db, "Kamba_users", uid));
        if (userDoc.exists()) {
          authorDataMap.set(uid, userDoc.data());
        }
      });

      await Promise.all(authorPromises);

      // Render announcements
      snapshot.forEach(doc => {
        const announcement = doc.data();
        const authorData = authorDataMap.get(announcement.authorId) || {};
        
        const announcementElement = document.createElement("div");
        announcementElement.className = "announcement-card";
        if (announcement.isPinned) {
          announcementElement.style.borderLeft = "4px solid #faa61a";
        }

        announcementElement.innerHTML = `
          <div class="announcement-header">
            <div>
              <h3 class="announcement-title">${announcement.title}</h3>
              <div class="announcement-meta">
                <span class="announcement-author">${simplifyEmail(announcement.authorEmail)}</span>
                <span class="announcement-time">${formatTime(announcement.createdAt?.toDate() || new Date())}</span>
                ${announcement.isPinned ? '<span><i class="fas fa-thumbtack"></i> Pinned</span>' : ''}
              </div>
            </div>
            ${currentUserData?.isAdmin ? `
              <div class="announcement-admin-actions">
                <button class="edit-announcement" data-id="${doc.id}" title="Edit"><i class="fas fa-edit"></i></button>
                <button class="delete-announcement" data-id="${doc.id}" title="Delete"><i class="fas fa-trash"></i></button>
              </div>
            ` : ''}
          </div>
          <div class="announcement-content">${marked.parse(announcement.content)}</div>
          <div class="announcement-actions">
            <div class="announcement-action">
              <i class="fas fa-eye"></i> <span>${announcement.views || 0} views</span>
            </div>
          </div>
        `;

        announcementsContainer.appendChild(announcementElement);

        // Add event listeners for admin actions
        if (currentUserData?.isAdmin) {
          announcementElement.querySelector(".edit-announcement")?.addEventListener("click", (e) => {
            e.stopPropagation();
            editAnnouncement(doc.id, announcement);
          });

          announcementElement.querySelector(".delete-announcement")?.addEventListener("click", (e) => {
            e.stopPropagation();
            deleteAnnouncement(doc.id);
          });
        }
      });
    });

    return unsubscribe;
  }

  // Edit an announcement
  function editAnnouncement(id, announcementData) {
    currentEditingAnnouncementId = id;
    editAnnouncementTitle.value = announcementData.title;
    editAnnouncementContent.value = announcementData.content;
    editAnnouncementModal.style.display = "flex";
    editAnnouncementTitle.focus();
  }

  // Save edited announcement
  async function saveEditedAnnouncement() {
    const title = editAnnouncementTitle.value.trim();
    const content = editAnnouncementContent.value.trim();

    if (!title || !content) {
      alert("Please fill in both title and content");
      return;
    }

    try {
      await updateDoc(doc(db, "Kamba_announcements", currentEditingAnnouncementId), {
        title,
        content,
        updatedAt: serverTimestamp()
      });

      editAnnouncementModal.style.display = "none";
      currentEditingAnnouncementId = null;
    } catch (error) {
      console.error("Error updating announcement:", error);
      alert("Failed to update announcement");
    }
  }

  // Delete an announcement
  async function deleteAnnouncement(id) {
    if (!confirm("Are you sure you want to delete this announcement?")) return;

    try {
      await deleteDoc(doc(db, "Kamba_announcements", id));
    } catch (error) {
      console.error("Error deleting announcement:", error);
      alert("Failed to delete announcement");
    }
  }

  // Format timestamp
  function formatTime(date) {
    if (!date) return "";
    return date.toLocaleString([], {
      year: 'numeric',
      month: 'short',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });
  }

  // Helper: remove @gmail.com and similar domains
  function simplifyEmail(email) {
    if (!email) return "unknown";
    return email.split("@")[0];
  }

  // Update user profile section
  function updateUserProfile(userData) {
    if (!userData) return;
    
    // Set profile picture
    if (userData.profilePic) {
      profilePic.style.backgroundImage = `url(${userData.profilePic})`;
      profilePic.textContent = "";
    } else {
      const displayName = simplifyEmail(userData.email);
      profilePic.textContent = displayName.charAt(0).toUpperCase();
      profilePic.style.backgroundImage = "none";
      
      // Set random color for profile pic
      const colors = ['#5865f2', '#57f287', '#f04747', '#eb459e', '#ed4245', '#faa61a'];
      const randomColor = colors[Math.floor(Math.random() * colors.length)];
      profilePic.style.backgroundColor = randomColor;
    }
    
    // Set username
    profileName.textContent = simplifyEmail(userData.email);
    
    // Set status based on sparks
    let status, statusColor;
    if (userData.isAdmin) {
      status = "Admin";
      statusColor = "red";
    } else {
      const sparks = userData.sparks || 0;
      if (sparks >= 1000) {
        status = "Violet";
        statusColor = "violet";
      } else if (sparks >= 100) {
        status = "Blue";
        statusColor = "blue";
      } else {
        status = "Green";
        statusColor = "green";
      }
    }
    
    statusDot.className = "status-dot " + statusColor;
    statusText.textContent = status;
  }

  // Check authentication state
  function checkAuthState() {
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = "sign.html";
        return;
      }
      currentUser = user;

      // Load user data from Firestore
      const userDocRef = doc(db, "Kamba_users", user.uid);
      const userDocSnap = await getDoc(userDocRef);
      
      if (!userDocSnap.exists()) {
        window.location.href = "sign.html";
        return;
      }
      
      currentUserData = userDocSnap.data();
      updateUserProfile(currentUserData);
      loadAnnouncements();
      
      // Show new announcement button only for admins
      if (currentUserData.isAdmin) {
        newAnnouncementBtn.style.display = "block";
      } else {
        newAnnouncementBtn.style.display = "none";
      }
    });
  }

  // Initialize the app
  init();
</script>
</body>
</html>
