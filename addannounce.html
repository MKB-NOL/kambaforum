<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>KAMBA Forum - Manage Announcements</title>
<!-- Favicon -->
<link rel="icon" type="image/x-icon" href="favicon.ico" />

<!-- Open Graph Meta Tags -->
<meta property="og:title" content="KAMBA Forum - Manage Announcements" />
<meta property="og:description" content="Create, edit, and delete announcements for KAMBA Forum to share with the community." />
<meta property="og:image" content="https://i.ibb.co/TRXscBP/KAMBA-Logo-2.png" />
<meta property="og:url" content="https://kamba-forum.com/addannounce" />
<meta property="og:type" content="website" />

<!-- Twitter Card Meta Tags -->
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:title" content="KAMBA Forum - Manage Announcements" />
<meta name="twitter:description" content="Create, edit, and delete announcements for KAMBA Forum to share with the community." />
<meta name="twitter:image" content="https://i.ibb.co/TRXscBP/KAMBA-Logo-2.png" />

<style>
  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
    font-family: 'Poppins', sans-serif;
  }
  body, html {
    height: 100%;
    background-color: #36393f;
    color: #dcddde;
    display: flex;
    flex-direction: column;
  }
  @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
  
  header {
    background-color: #2f3136;
    padding: 1rem 2rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    color: white;
    border-bottom: 1px solid #202225;
  }
  header h1 {
    margin: 0;
    font-size: 1.5rem;
  }
  #main-content {
    flex: 1;
    padding: 2rem;
    display: flex;
    flex-direction: column;
    align-items: center;
    overflow-y: auto;
  }
  .form-container {
    background-color: #2f3136;
    padding: 2rem;
    border-radius: 8px;
    width: 100%;
    max-width: 600px;
    margin-bottom: 2rem;
  }
  .form-row {
    margin-bottom: 1.2rem;
  }
  .form-row label {
    display: block;
    margin-bottom: 0.5rem;
    color: #b9bbbe;
    font-weight: 500;
  }
  .form-row input,
  .form-row textarea {
    width: 100%;
    padding: 0.8rem;
    border-radius: 4px;
    border: none;
    background-color: #40444b;
    color: white;
    font-size: 1rem;
  }
  .form-row textarea {
    min-height: 150px;
    resize: vertical;
  }
  .form-row input:focus,
  .form-row textarea:focus {
    outline: 2px solid #5865f2;
  }
  .required-field::after {
    content: " *";
    color: #f04747;
  }
  .form-actions {
    display: flex;
    justify-content: flex-end;
    gap: 1rem;
    margin-top: 1.5rem;
  }
  .form-btn {
    padding: 0.7rem 1.5rem;
    border-radius: 4px;
    border: none;
    cursor: pointer;
    font-weight: bold;
  }
  .form-btn.cancel {
    background-color: #72767d;
    color: white;
  }
  .form-btn.submit {
    background-color: #5865f2;
    color: white;
  }
  .form-btn.submit:hover {
    background-color: #4752c4;
  }
  .form-btn.cancel:hover {
    background-color: #5f6368;
  }
  .preview-area {
    border: 1px solid #40444b;
    border-radius: 4px;
    padding: 1rem;
    min-height: 100px;
    background-color: #2f3136;
    margin-top: 0.5rem;
  }
  .preview-area a {
    color: #5865f2;
    text-decoration: none;
  }
  .preview-area a:hover {
    text-decoration: underline;
  }
  .announcements-container {
    width: 100%;
    max-width: 600px;
  }
  .announcement {
    background-color: #2f3136;
    padding: 1rem;
    border-radius: 8px;
    margin-bottom: 1rem;
    position: relative;
    word-break: break-word;
    border-left: 4px solid #f04747;
  }
  .announcement:hover {
    background-color: #34373c;
  }
  .announcement-header {
    display: flex;
    align-items: center;
    margin-bottom: 0.5rem;
  }
  .announcement-title {
    font-size: 1.2rem;
    font-weight: 600;
    color: white;
    margin-bottom: 0.5rem;
  }
  .username {
    font-weight: 700;
    cursor: default;
  }
  .announcement-time {
    font-size: 0.7rem;
    color: #b9bbbe;
    margin-left: 0.8rem;
  }
  .announcement-text {
    white-space: pre-wrap;
    margin-bottom: 0.5rem;
    line-height: 1.4;
  }
  .announcement-text a {
    color: #5865f2;
    text-decoration: none;
  }
  .announcement-text a:hover {
    text-decoration: underline;
  }
  .announcement-actions {
    display: flex;
    gap: 1rem;
    margin-top: 0.5rem;
  }
  .announcement-action {
    font-size: 0.8rem;
    color: #b9bbbe;
    cursor: pointer;
  }
  .announcement-action:hover {
    color: white;
    text-decoration: underline;
  }
  .announcement-badge {
    font-size: 0.7rem;
    padding: 0.2rem 0.4rem;
    border-radius: 4px;
    margin-left: 0.5rem;
    background-color: #f04747;
    color: white;
  }
  .modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.7);
    z-index: 1000;
    justify-content: center;
    align-items: center;
  }
  .modal-content {
    background-color: #2f3136;
    padding: 1.5rem;
    border-radius: 8px;
    width: 80%;
    max-width: 500px;
  }
  .modal-title {
    margin-bottom: 1rem;
    color: white;
  }
  .modal-input {
    width: 100%;
    padding: 0.8rem;
    margin-bottom: 1rem;
    border-radius: 4px;
    border: none;
    background-color: #40444b;
    color: white;
  }
  .modal-buttons {
    display: flex;
    justify-content: flex-end;
    gap: 0.5rem;
  }
  .modal-btn {
    padding: 0.5rem 1rem;
    border-radius: 4px;
    border: none;
    cursor: pointer;
  }
  .modal-btn.cancel {
    background-color: #72767d;
    color: white;
  }
  .modal-btn.save {
    background-color: #5865f2;
    color: white;
  }
  .username.red { color: #f04747; }
  ::-webkit-scrollbar {
    width: 8px;
  }
  ::-webkit-scrollbar-thumb {
    background-color: #5865f2;
    border-radius: 5px;
  }
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>

<header>
  <h1>KAMBA Forum - Manage Announcements</h1>
</header>

<div id="main-content">
  <div class="form-container">
    <div class="form-row">
      <label class="required-field">Announcement Title</label>
      <input type="text" id="announcement-title" placeholder="Enter announcement title" autocomplete="off" />
    </div>
    
    <div class="form-row">
      <label class="required-field">Announcement Content</label>
      <textarea id="announcement-content" placeholder="Write your announcement here"></textarea>
      <div class="preview-area" id="content-preview"></div>
    </div>
    
    <div class="form-actions">
      <button class="form-btn cancel" id="cancel-btn">Cancel</button>
      <button class="form-btn submit" id="submit-btn">Post Announcement</button>
    </div>
  </div>

  <div class="announcements-container" id="announcements-container"></div>
</div>

<!-- Edit Announcement Modal -->
<div id="edit-announcement-modal" class="modal">
  <div class="modal-content">
    <h3 class="modal-title">Edit Announcement</h3>
    <input type="text" id="edit-announcement-title" class="modal-input" placeholder="Announcement Title" />
    <textarea id="edit-announcement-input" class="modal-input" rows="4"></textarea>
    <div class="modal-buttons">
      <button class="modal-btn cancel" id="cancel-edit-btn">Cancel</button>
      <button class="modal-btn save" id="save-edit-btn">Save</button>
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
  import {
    getAuth,
    onAuthStateChanged,
  } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
  import {
    getFirestore,
    doc,
    getDoc,
    addDoc,
    collection,
    query,
    orderBy,
    onSnapshot,
    updateDoc,
    deleteDoc,
  } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCW2RJIku0JLJZTUu0YA9yKO8zjtX29fAo",
    authDomain: "muah-feed.firebaseapp.com",
    databaseURL: "https://muah-feed-default-rtdb.firebaseio.com",
    projectId: "muah-feed",
    storageBucket: "muah-feed.firebasestorage.app",
    messagingSenderId: "442314397706",
    appId: "1:442314397706:web:a69e3958257fb13b3667f3",
    measurementId: "G-S86S229F1T",
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // DOM Elements
  const announcementTitle = document.getElementById("announcement-title");
  const announcementContent = document.getElementById("announcement-content");
  const contentPreview = document.getElementById("content-preview");
  const cancelBtn = document.getElementById("cancel-btn");
  const submitBtn = document.getElementById("submit-btn");
  const announcementsContainer = document.getElementById("announcements-container");
  const editAnnouncementModal = document.getElementById("edit-announcement-modal");
  const editAnnouncementTitle = document.getElementById("edit-announcement-title");
  const editAnnouncementInput = document.getElementById("edit-announcement-input");
  const cancelEditBtn = document.getElementById("cancel-edit-btn");
  const saveEditBtn = document.getElementById("save-edit-btn");

  // App State
  let currentUser = null;
  let currentUserData = null;
  let announcementBeingEdited = null;

  // Initialize
  function init() {
    setupEventListeners();
    checkAuthState();
  }

  // Event Listeners
  function setupEventListeners() {
    cancelBtn.addEventListener("click", () => {
      window.location.href = "announcements.html";
    });

    submitBtn.addEventListener("click", submitAnnouncement);

    announcementContent.addEventListener("input", updatePreview);

    cancelEditBtn.addEventListener("click", () => {
      editAnnouncementModal.style.display = "none";
    });

    saveEditBtn.addEventListener("click", saveEditedAnnouncement);
  }

  // Update preview
  function updatePreview() {
    const text = announcementContent.value;
    contentPreview.innerHTML = linkify(text);
  }

  // Convert URLs to clickable links
  function linkify(text) {
    const urlRegex = /(https?:\/\/[^\s<]+[^\s<.,:;"')\]\}])/g;
    return text.replace(urlRegex, '<a href="$1" target="_blank">$1</a>');
  }

  // Submit announcement
  async function submitAnnouncement() {
    const title = announcementTitle.value.trim();
    const content = announcementContent.value.trim();

    if (!title || !content) {
      alert("Both title and content are required");
      return;
    }

    if (currentUserData?.status !== "red") {
      alert("Only admins can create announcements");
      return;
    }

    try {
      await addDoc(collection(db, "Kamba_announcements"), {
        userId: currentUser.uid,
        senderEmail: currentUser.email,
        sender: simplifyEmail(currentUser.email),
        title: title,
        message: content,
        timestamp: Date.now(),
      });

      announcementTitle.value = "";
      announcementContent.value = "";
      contentPreview.innerHTML = "";
    } catch (error) {
      console.error("Error creating announcement:", error);
      alert("Failed to create announcement");
    }
  }

  // Render an announcement
  function renderAnnouncement(id, data) {
    const div = document.createElement("div");
    div.className = "announcement";
    div.dataset.id = id;

    const headerDiv = document.createElement("div");
    headerDiv.className = "announcement-header";

    const usernameSpan = document.createElement("span");
    usernameSpan.className = "username red";
    usernameSpan.textContent = data.sender;
    headerDiv.appendChild(usernameSpan);

    const badge = document.createElement("span");
    badge.className = "announcement-badge";
    badge.textContent = "ANNOUNCEMENT";
    headerDiv.appendChild(badge);

    const timeSpan = document.createElement("span");
    timeSpan.className = "announcement-time";
    timeSpan.textContent = formatTime(data.timestamp);
    headerDiv.appendChild(timeSpan);

    div.appendChild(headerDiv);

    const titleDiv = document.createElement("div");
    titleDiv.className = "announcement-title";
    titleDiv.textContent = data.title;
    div.appendChild(titleDiv);

    const textDiv = document.createElement("div");
    textDiv.className = "announcement-text";
    textDiv.innerHTML = linkify(data.message);
    div.appendChild(textDiv);

    if (currentUserData?.status === "red") {
      const actionsDiv = document.createElement("div");
      actionsDiv.className = "announcement-actions";

      const editBtn = document.createElement("span");
      editBtn.className = "announcement-action";
      editBtn.textContent = "Edit";
      editBtn.addEventListener("click", () => editAnnouncement(id, data.title, data.message));
      actionsDiv.appendChild(editBtn);

      const deleteBtn = document.createElement("span");
      deleteBtn.className = "announcement-action";
      deleteBtn.textContent = "Delete";
      deleteBtn.addEventListener("click", () => deleteAnnouncement(id));
      actionsDiv.appendChild(deleteBtn);

      div.appendChild(actionsDiv);
    }

    return div;
  }

  // Format timestamp
  function formatTime(timestamp) {
    if (!timestamp) return "";
    const date = new Date(timestamp);
    return date.toLocaleString([], { 
      month: 'short', 
      day: 'numeric', 
      hour: '2-digit', 
      minute: '2-digit' 
    });
  }

  // Edit announcement
  function editAnnouncement(announcementId, title, text) {
    announcementBeingEdited = announcementId;
    editAnnouncementTitle.value = title;
    editAnnouncementInput.value = text;
    editAnnouncementModal.style.display = "flex";
    editAnnouncementTitle.focus();
  }

  // Save edited announcement
  async function saveEditedAnnouncement() {
    if (!announcementBeingEdited) return;

    const newTitle = editAnnouncementTitle.value.trim();
    const newText = editAnnouncementInput.value.trim();

    if (!newTitle || !newText) {
      alert("Both title and announcement text are required");
      return;
    }

    try {
      const announcementRef = doc(db, "Kamba_announcements", announcementBeingEdited);
      await updateDoc(announcementRef, {
        title: newTitle,
        message: newText,
        edited: true
      });

      editAnnouncementModal.style.display = "none";
      announcementBeingEdited = null;
    } catch (error) {
      console.error("Error editing announcement:", error);
      alert("Failed to edit announcement");
    }
  }

  // Delete announcement
  async function deleteAnnouncement(announcementId) {
    if (!confirm("Are you sure you want to delete this announcement?")) return;

    try {
      await deleteDoc(doc(db, "Kamba_announcements", announcementId));
    } catch (error) {
      console.error("Error deleting announcement:", error);
      alert("Failed to delete announcement");
    }
  }

  // Load announcements
  function loadAnnouncements() {
    const announcementsQuery = query(
      collection(db, "Kamba_announcements"),
      orderBy("timestamp", "desc")
    );

    onSnapshot(announcementsQuery, (querySnapshot) => {
      announcementsContainer.innerHTML = "";

      querySnapshot.forEach((docSnap) => {
        const data = docSnap.data();
        const announcementData = {
          sender: simplifyEmail(data.senderEmail),
          title: data.title,
          message: data.message,
          timestamp: data.timestamp
        };
        const announcementDiv = renderAnnouncement(docSnap.id, announcementData);
        announcementsContainer.appendChild(announcementDiv);
      });
    });
  }

  // Simplify email
  function simplifyEmail(email) {
    if (!email) return "unknown";
    return email.split("@")[0];
  }

  // Check auth state
  function checkAuthState() {
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = "sign.html";
        return;
      }
      currentUser = user;

      const userDocRef = doc(db, "Kamba_users", user.uid);
      const userDocSnap = await getDoc(userDocRef);

      if (!userDocSnap.exists()) {
        window.location.href = "sign.html";
        return;
      }

      currentUserData = userDocSnap.data();
      if (currentUserData.status !== "red") {
        alert("Access denied: Only admins can manage announcements");
        window.location.href = "announcements.html";
        return;
      }

      loadAnnouncements();
    });
  }

  // Initialize
  init();
</script>
</body>
</html>
