<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>KAMBA Forum - Add Announcement</title>
<!-- Favicon -->
<link rel="icon" type="image/x-icon" href="favicon.ico" />

<!-- Open Graph Meta Tags -->
<meta property="og:title" content="KAMBA Forum - Add Announcement" />
<meta property="og:description" content="Create new announcements for KAMBA Forum to share with the community." />
<meta property="og:image" content="https://i.ibb.co/TRXscBP/KAMBA-Logo-2.png" />
<meta property="og:url" content="https://kamba-forum.com/addannounce" />
<meta property="og:type" content="website" />

<!-- Twitter Card Meta Tags -->
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:title" content="KAMBA Forum - Add Announcement" />
<meta name="twitter:description" content="Create new announcements for KAMBA Forum to share with the community." />
<meta name="twitter:image" content="https://i.ibb.co/TRXscBP/KAMBA-Logo-2.png" />

<style>
  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
    font-family: 'Poppins', sans-serif;
  }
  body, html {
    height: 100%;
    background-color: #36393f;
    color: #dcddde;
    display: flex;
    flex-direction: column;
  }
  @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
  
  header {
    background-color: #2f3136;
    padding: 1rem 2rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    color: white;
    border-bottom: 1px solid #202225;
  }
  header h1 {
    margin: 0;
    font-size: 1.5rem;
  }
  #main-content {
    flex: 1;
    padding: 2rem;
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  .form-container {
    background-color: #2f3136;
    padding: 2rem;
    border-radius: 8px;
    width: 100%;
    max-width: 600px;
  }
  .form-row {
    margin-bottom: 1.2rem;
  }
  .form-row label {
    display: block;
    margin-bottom: 0.5rem;
    color: #b9bbbe;
    font-weight: 500;
  }
  .form-row input,
  .form-row textarea {
    width: 100%;
    padding: 0.8rem;
    border-radius: 4px;
    border: none;
    background-color: #40444b;
    color: white;
    font-size: 1rem;
  }
  .form-row textarea {
    min-height: 150px;
    resize: vertical;
  }
  .form-row input:focus,
  .form-row textarea:focus {
    outline: 2px solid #5865f2;
  }
  .required-field::after {
    content: " *";
    color: #f04747;
  }
  .form-actions {
    display: flex;
    justify-content: flex-end;
    gap: 1rem;
    margin-top: 1.5rem;
  }
  .form-btn {
    padding: 0.7rem 1.5rem;
    border-radius: 4px;
    border: none;
    cursor: pointer;
    font-weight: bold;
  }
  .form-btn.cancel {
    background-color: #72767d;
    color: white;
  }
  .form-btn.submit {
    background-color: #5865f2;
    color: white;
  }
  .form-btn.submit:hover {
    background-color: #4752c4;
  }
  .form-btn.cancel:hover {
    background-color: #5f6368;
  }
  .preview-area {
    border: 1px solid #40444b;
    border-radius: 4px;
    padding: 1rem;
    min-height: 100px;
    background-color: #2f3136;
    margin-top: 0.5rem;
  }
  .preview-area a {
    color: #5865f2;
    text-decoration: none;
  }
  .preview-area a:hover {
    text-decoration: underline;
  }
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>

<header>
  <h1>KAMBA Forum - Add Announcement</h1>
</header>

<div id="main-content">
  <div class="form-container">
    <div class="form-row">
      <label class="required-field">Announcement Title</label>
      <input type="text" id="announcement-title" placeholder="Enter announcement title" autocomplete="off" />
    </div>
    
    <div class="form-row">
      <label class="required-field">Announcement Content</label>
      <textarea id="announcement-content" placeholder="Write your announcement here"></textarea>
      <div class="preview-area" id="content-preview"></div>
    </div>
    
    <div class="form-actions">
      <button class="form-btn cancel" id="cancel-btn">Cancel</button>
      <button class="form-btn submit" id="submit-btn">Post Announcement</button>
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
  import {
    getAuth,
    onAuthStateChanged,
  } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
  import {
    getFirestore,
    doc,
    getDoc,
    addDoc,
    collection,
  } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCW2RJIku0JLJZTUu0YA9yKO8zjtX29fAo",
    authDomain: "muah-feed.firebaseapp.com",
    databaseURL: "https://muah-feed-default-rtdb.firebaseio.com",
    projectId: "muah-feed",
    storageBucket: "muah-feed.firebasestorage.app",
    messagingSenderId: "442314397706",
    appId: "1:442314397706:web:a69e3958257fb13b3667f3",
    measurementId: "G-S86S229F1T",
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // DOM Elements
  const announcementTitle = document.getElementById("announcement-title");
  const announcementContent = document.getElementById("announcement-content");
  const contentPreview = document.getElementById("content-preview");
  const cancelBtn = document.getElementById("cancel-btn");
  const submitBtn = document.getElementById("submit-btn");

  // App State
  let currentUser = null;
  let currentUserData = null;

  // Initialize
  function init() {
    setupEventListeners();
    checkAuthState();
  }

  // Event Listeners
  function setupEventListeners() {
    cancelBtn.addEventListener("click", () => {
      window.location.href = "announcements.html";
    });

    submitBtn.addEventListener("click", submitAnnouncement);

    announcementContent.addEventListener("input", updatePreview);
  }

  // Update preview
  function updatePreview() {
    const text = announcementContent.value;
    contentPreview.innerHTML = linkify(text);
  }

  // Convert URLs to clickable links
  function linkify(text) {
    const urlRegex = /(https?:\/\/[^\s<]+[^\s<.,:;"')\]\}])/g;
    return text.replace(urlRegex, '<a href="$1" target="_blank">$1</a>');
  }

  // Submit announcement
  async function submitAnnouncement() {
    const title = announcementTitle.value.trim();
    const content = announcementContent.value.trim();

    if (!title || !content) {
      alert("Both title and content are required");
      return;
    }

    if (getUserStatus(currentUserData) !== "red") {
      alert("Only admins can create announcements");
      return;
    }

    try {
      await addDoc(collection(db, "Kamba_announcements"), {
        userId: currentUser.uid,
        senderEmail: currentUser.email,
        sender: simplifyEmail(currentUser.email),
        title: title,
        message: content,
        timestamp: Date.now(),
      });

      window.location.href = "announcements.html";
    } catch (error) {
      console.error("Error creating announcement:", error);
      alert("Failed to create announcement");
    }
  }

  // Simplify email
  function simplifyEmail(email) {
    if (!email) return "unknown";
    return email.split("@")[0];
  }

  // Get user status
  function getUserStatus(userData) {
    if (!userData) return "green";
    if (userData.isAdmin) return "red";
    const sparks = userData.sparks || 0;
    if (sparks >= 1000) return "violet";
    if (sparks >= 100) return "blue";
    return "green";
  }

  // Check auth state
  function checkAuthState() {
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = "sign.html";
        return;
      }
      currentUser = user;

      const userDocRef = doc(db, "Kamba_users", user.uid);
      const userDocSnap = await getDoc(userDocRef);

      if (!userDocSnap.exists()) {
        window.location.href = "sign.html";
        return;
      }

      currentUserData = userDocSnap.data();
    });
  }

  // Initialize
  init();
</script>
</body>
</html>
