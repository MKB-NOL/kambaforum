<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KAMBA Forum - Chat</title>
  <style>
    /* Basic reset and Discord-like style */
    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; padding: 0; }
    body {
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      background-color: #36393f;
      color: #dcddde;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    header {
      background-color: #2f3136;
      padding: 1rem 1.25rem;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:1rem;
      color:white;
    }
    header h1 { margin: 0; font-size:1.25rem; }
    .header-actions { display:flex; gap:0.5rem; align-items:center; }

    button.primary {
      background-color: #5865f2;
      border: none;
      color: white;
      padding: 0.45rem 0.9rem;
      font-weight: 700;
      border-radius: 6px;
      cursor: pointer;
    }
    button.secondary {
      background-color: transparent;
      border: 1px solid rgba(255,255,255,0.06);
      color: #dcddde;
      padding: 0.45rem 0.75rem;
      border-radius: 6px;
      cursor: pointer;
    }
    button.primary:hover { background-color: #4752c4; }
    button#signout-btn { background-color:#f04747; color:white; border:none; padding:0.5rem 0.9rem; border-radius:6px; cursor:pointer; }
    button#signout-btn:hover { background-color:#c03939; }

    /* Chat area */
    #chat-wrap {
      display:flex;
      flex-direction:column;
      flex:1;
      min-height:0; /* allow overflow */
    }

    #chat-container {
      flex:1;
      overflow-y:auto;
      padding: 1rem;
      display:flex;
      flex-direction:column;
      gap:0.75rem;
      background-color: #2f3136;
      scroll-behavior: smooth;
    }
    #chat-container[aria-live] { /* accessible live region hint */ }

    .message {
      background-color: #202225;
      padding: 0.7rem 0.9rem;
      border-radius: 8px;
      max-width: 70%;
      word-break: break-word;
      align-self: flex-start;
      position: relative;
      box-shadow: 0 1px 0 rgba(0,0,0,0.4);
      display:flex;
      flex-direction:column;
      gap:0.35rem;
    }
    .message.mine { align-self: flex-end; background: linear-gradient(180deg,#2d8a6f,#2e7b63); color: #fff; }
    .username { font-weight:700; font-size:0.95rem; cursor: default; }
    .meta-row { display:flex; gap:0.5rem; align-items:center; font-size:0.78rem; color:#b9bbbe; }
    .message-text { white-space: pre-wrap; font-size:0.95rem; }
    .reply-to {
      font-size: 0.82rem;
      color:#d1d3d5;
      padding-left:0.5rem;
      border-left: 3px solid rgba(88,101,242,0.9);
      cursor:pointer;
      background: rgba(255,255,255,0.02);
      border-radius:6px;
      padding:0.45rem 0.5rem;
      max-width:100%;
    }

    .reply-btn { font-size: 0.8rem; color:#5865f2; cursor:pointer; user-select:none; }
    .reply-btn:hover { text-decoration: underline; }

    /* Input area */
    #message-input-area {
      background-color: #40444b;
      padding: 0.6rem;
      display:flex;
      gap:0.5rem;
      align-items:center;
      border-top: 1px solid rgba(0,0,0,0.4);
    }
    #message-input {
      flex:1;
      padding: 0.6rem 0.8rem;
      border-radius: 8px;
      border: none;
      font-size: 1rem;
      color: #fff;
      background-color: #2f3136;
    }
    #message-input:focus { outline: 2px solid #5865f2; }

    #send-btn { background-color:#5865f2; border:none; color:white; padding:0.55rem 1rem; font-weight:700; border-radius:8px; cursor:pointer; }
    #send-btn:hover { background-color:#4752c4; }

    #cancel-reply { display:none; background:transparent; border:none; color:#ffb0b0; cursor:pointer; }

    #emoji-btn {
      background: transparent;
      border:none;
      font-size:1.3rem;
      color:#b9bbbe;
      cursor:pointer;
    }

    #emoji-picker {
      position: absolute;
      bottom: 3.6rem;
      right: 1.1rem;
      background: #202225;
      padding:0.45rem;
      border-radius:8px;
      display:none;
      box-shadow: 0 6px 18px rgba(0,0,0,0.6);
      z-index:1000;
      display:flex;
      gap:0.4rem;
    }
    #emoji-picker span { font-size:1.45rem; cursor:pointer; user-select:none; padding:6px; border-radius:6px; }
    #emoji-picker span:hover { transform:scale(1.2); }

    #no-song-notification {
      background-color: #f04747;
      color: white;
      text-align:center;
      padding:0.6rem;
      font-weight:600;
      cursor:pointer;
      display:none;
    }

    /* Status color classes for username */
    .username.green { color: #43b581; }
    .username.blue { color: #5865f2; }
    .username.violet { color: #9b59b6; }
    .username.red { color: #f04747; }

    /* small timestamp text */
    .ts { font-size:0.72rem; color:#9aa0a6; margin-left:auto; }

    /* scrollbar */
    #chat-container::-webkit-scrollbar { width:8px; }
    #chat-container::-webkit-scrollbar-thumb { background-color: #5865f2; border-radius:5px; }
  </style>
</head>
<body>
  <header>
    <h1>KAMBA Forum</h1>
    <div class="header-actions">
      <button id="open-settings" class="secondary">Settings</button>
      <button id="signout-btn">Sign Out</button>
    </div>
  </header>

  <div id="chat-wrap">
    <div id="chat-container" aria-live="polite" aria-atomic="false"></div>

    <div id="no-song-notification" role="button" tabindex="0" title="Set your song in settings">
      No song set. Click here to set your song in Settings.
    </div>

    <div id="message-input-area">
      <button id="emoji-btn" title="Emoji picker" aria-haspopup="list">üòÄ</button>
      <div id="emoji-picker" role="list" aria-label="Emoji picker">
        <span role="listitem" tabindex="0">üòÄ</span>
        <span role="listitem" tabindex="0">üòÇ</span>
        <span role="listitem" tabindex="0">üòé</span>
        <span role="listitem" tabindex="0">‚ù§Ô∏è</span>
        <span role="listitem" tabindex="0">üî•</span>
      </div>

      <input id="message-input" type="text" placeholder="Type a message..." autocomplete="off" />
      <button id="cancel-reply" title="Cancel reply">Cancel</button>
      <button id="send-btn">Send</button>
    </div>
  </div>

  <audio id="background-audio" loop crossorigin="anonymous"></audio>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import {
      getAuth,
      signOut,
      onAuthStateChanged,
    } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import {
      getFirestore,
      collection,
      query,
      orderBy,
      onSnapshot,
      addDoc,
      doc,
      getDoc,
      updateDoc,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    // --------- config - keep your project's config here ----------
    const firebaseConfig = {
      apiKey: "AIzaSyCW2RJIku0JLJZTUu0YA9yKO8zjtX29fAo",
      authDomain: "muah-feed.firebaseapp.com",
      databaseURL: "https://muah-feed-default-rtdb.firebaseio.com",
      projectId: "muah-feed",
      storageBucket: "muah-feed.firebasestorage.app",
      messagingSenderId: "442314397706",
      appId: "1:442314397706:web:a69e3958257fb13b3667f3",
      measurementId: "G-S86S229F1T",
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // DOM
    const chatContainer = document.getElementById("chat-container");
    const messageInput = document.getElementById("message-input");
    const sendBtn = document.getElementById("send-btn");
    const signoutBtn = document.getElementById("signout-btn");
    const emojiBtn = document.getElementById("emoji-btn");
    const emojiPicker = document.getElementById("emoji-picker");
    const noSongNotification = document.getElementById("no-song-notification");
    const cancelReplyBtn = document.getElementById("cancel-reply");
    const openSettingsBtn = document.getElementById("open-settings");
    const backgroundAudio = document.getElementById("background-audio");

    let currentUser = null;
    let currentUserData = null;
    let replyToMessageId = null;
    let replyToMessageText = null;

    // Emoji picker toggle and keyboard friendly
    emojiBtn.addEventListener("click", (e) => {
      e.stopPropagation();
      emojiPicker.style.display = emojiPicker.style.display === "flex" ? "none" : "flex";
    });

    // Add emoji to input
    emojiPicker.querySelectorAll("span").forEach(span => {
      span.addEventListener("click", () => {
        messageInput.value += span.textContent;
        messageInput.focus();
        emojiPicker.style.display = "none";
      });
      // keyboard support
      span.addEventListener("keydown", (e) => {
        if (e.key === "Enter" || e.key === " ") {
          e.preventDefault();
          span.click();
        }
      });
    });

    // Close emoji picker when clicking outside
    document.addEventListener("click", (e) => {
      if (!emojiPicker.contains(e.target) && e.target !== emojiBtn) {
        emojiPicker.style.display = "none";
      }
    });

    // Open settings
    openSettingsBtn.addEventListener("click", () => location.href = "settings.html");
    noSongNotification.addEventListener("click", () => location.href = "settings.html");

    // Sign out
    signoutBtn.addEventListener("click", async () => {
      try {
        await signOut(auth);
        location.href = "sign.html";
      } catch (err) {
        console.error("Sign out error:", err);
        alert("Failed to sign out.");
      }
    });

    // simplify email -> username
    function simplifyEmail(email = "") {
      return (email.split("@")[0] || "unknown").replace(/\.[0-9]+$/,'');
    }

    function getStatusClass(status) {
      switch (status) {
        case "green": return "green";
        case "blue": return "blue";
        case "violet": return "violet";
        case "red": return "red";
        default: return "green";
      }
    }

    // Format firebase timestamp (or number)
    function formatTimestamp(ts) {
      if (!ts) return "";
      let d;
      // Firestore Timestamp has toDate()
      if (typeof ts.toDate === "function") {
        d = ts.toDate();
      } else if (typeof ts === "number") {
        d = new Date(ts);
      } else {
        d = new Date(ts);
      }
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      const hh = String(d.getHours()).padStart(2,"0");
      const min = String(d.getMinutes()).padStart(2,"0");
      return `${mm}/${dd} ${hh}:${min}`;
    }

    // Render a single message element
    function renderMessage(id, msgData) {
      const div = document.createElement("div");
      div.className = "message";
      if (msgData.isMine) div.classList.add("mine");
      div.dataset.id = id;

      // top meta row: username + time
      const meta = document.createElement("div");
      meta.className = "meta-row";

      const usernameSpan = document.createElement("span");
      usernameSpan.className = "username " + getStatusClass(msgData.status || "green");
      usernameSpan.textContent = msgData.sender || "unknown";
      meta.appendChild(usernameSpan);

      // timestamp
      const tsSpan = document.createElement("span");
      tsSpan.className = "ts";
      tsSpan.textContent = formatTimestamp(msgData.timestamp) || "";
      meta.appendChild(tsSpan);

      div.appendChild(meta);

      // reply block (clickable to jump to message)
      if (msgData.replyToText) {
        const replyDiv = document.createElement("div");
        replyDiv.className = "reply-to";
        replyDiv.textContent = "Replying to: " + msgData.replyToText;
        replyDiv.dataset.replyToId = msgData.replyToId || "";
        replyDiv.addEventListener("click", () => {
          const targetId = replyDiv.dataset.replyToId;
          if (!targetId) return;
          const target = chatContainer.querySelector(`[data-id="${targetId}"]`);
          if (target) target.scrollIntoView({ behavior: "smooth", block: "center" });
        });
        div.appendChild(replyDiv);
      }

      const textDiv = document.createElement("div");
      textDiv.className = "message-text";
      // safe rendering (textContent avoids XSS)
      textDiv.textContent = msgData.message || "";
      div.appendChild(textDiv);

      // actions row
      const actions = document.createElement("div");
      actions.style.display = "flex";
      actions.style.gap = "0.6rem";
      actions.style.alignItems = "center";
      actions.style.marginTop = "0.35rem";

      const replyBtn = document.createElement("div");
      replyBtn.className = "reply-btn";
      replyBtn.textContent = "Reply";
      replyBtn.addEventListener("click", () => {
        replyToMessageId = id;
        replyToMessageText = msgData.message || "";
        messageInput.focus();
        messageInput.placeholder = "Replying: " + replyToMessageText.slice(0, 40) + "... (press Send)";
        cancelReplyBtn.style.display = "inline";
      });
      actions.appendChild(replyBtn);

      div.appendChild(actions);
      return div;
    }

    // Listen for auth changes
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        location.href = "sign.html";
        return;
      }
      currentUser = user;

      // load current user data doc
      try {
        const userDocRef = doc(db, "Kamba_users", user.uid);
        const userSnap = await getDoc(userDocRef);
        if (!userSnap.exists()) {
          alert("User data not found. Contact admin.");
          return;
        }
        currentUserData = userSnap.data();

        // background audio
        if (currentUserData.song && currentUserData.song.trim() !== "") {
          backgroundAudio.src = currentUserData.song;
          backgroundAudio.volume = (currentUserData.volume ?? 0.5);
          backgroundAudio.play().catch(() => { /* autoplay block is fine */ });
          noSongNotification.style.display = "none";
        } else {
          noSongNotification.style.display = "block";
        }

        // start listening to messages
        setupMessagesListener();
      } catch (err) {
        console.error("Auth state processing error:", err);
        alert("Error loading user data.");
      }
    });

    // Real-time listener
    function setupMessagesListener() {
      const messagesQuery = query(collection(db, "Kamba_messages"), orderBy("timestamp", "asc"));

      onSnapshot(messagesQuery, async (querySnapshot) => {
        // gather userIds to preload statuses/display names
        const userIds = new Set();
        const messagesArray = [];
        querySnapshot.forEach(docSnap => {
          const d = docSnap.data();
          messagesArray.push({ id: docSnap.id, data: d });
          if (d && d.userId) userIds.add(d.userId);
        });

        // preload user docs
        const userDocsPromises = Array.from(userIds).map(uid => getDoc(doc(db, "Kamba_users", uid)));
        const userDocs = await Promise.all(userDocsPromises);
        const userDataMap = new Map();
        userDocs.forEach(snap => { if (snap.exists()) userDataMap.set(snap.id, snap.data()); });

        // render messages (clear then append)
        chatContainer.innerHTML = "";
        for (const msg of messagesArray) {
          const d = msg.data || {};
          const senderUid = d.userId;
          const userData = userDataMap.get(senderUid);
          const displayName = (userData && userData.displayName) ? userData.displayName : simplifyEmail(d.senderEmail || d.sender || "unknown");
          const status = userData ? (userData.status || "green") : "green";

          const messageData = {
            sender: displayName,
            status: status,
            message: d.message || "",
            replyToText: d.replyToText || null,
            replyToId: d.replyTo || null,
            timestamp: d.timestamp || null,
            isMine: currentUser && (currentUser.uid === senderUid),
          };
          const el = renderMessage(msg.id, messageData);
          chatContainer.appendChild(el);
        }

        // auto scroll to bottom
        chatContainer.scrollTop = chatContainer.scrollHeight;
      }, (err) => {
        console.error("Messages snapshot error:", err);
      });
    }

    // send message handler
    sendBtn.addEventListener("click", sendMessage);
    messageInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      } else if (e.key === "Escape") {
        clearReply();
      }
    });

    cancelReplyBtn.addEventListener("click", () => { clearReply(); });

    function clearReply() {
      replyToMessageId = null;
      replyToMessageText = null;
      messageInput.placeholder = "Type a message...";
      cancelReplyBtn.style.display = "none";
    }

    async function sendMessage() {
      const text = messageInput.value.trim();
      if (!text) return;

      if (!currentUser) {
        alert("You must be signed in to send messages.");
        return;
      }

      try {
        const senderEmail = currentUser.email;
        const userId = currentUser.uid;
        const userDocRef = doc(db, "Kamba_users", userId);
        const userDocSnap = await getDoc(userDocRef);
        if (!userDocSnap.exists()) {
          alert("User profile missing. Contact admin.");
          return;
        }
        const userData = userDocSnap.data();

        // Add the message with server timestamp for consistent ordering
        await addDoc(collection(db, "Kamba_messages"), {
          userId: userId,
          senderEmail: senderEmail,
          sender: simplifyEmail(senderEmail),
          message: text,
          replyTo: replyToMessageId || null,
          replyToText: replyToMessageText || null,
          timestamp: serverTimestamp()
        });

        // Reset input & reply state
        messageInput.value = "";
        messageInput.placeholder = "Type a message...";
        clearReply();

        // Update sparks and status
        let newSparks = (userData.sparks || 0) + 1;
        let newStatus = userData.status || "green";
        if (newSparks >= 1000) newStatus = "violet";
        else if (newSparks >= 100) newStatus = "blue";
        else newStatus = "green";

        await updateDoc(userDocRef, { sparks: newSparks, status: newStatus });
      } catch (err) {
        console.error("Error sending message:", err);
        alert("Error sending message: " + (err.message || err));
      }
    }

    // small touch: allow pressing Enter on emoji button to open picker
    emojiBtn.addEventListener("keydown", (e) => {
      if (e.key === "Enter" || e.key === " ") {
        e.preventDefault();
        emojiBtn.click();
      }
    });

    // close emoji picker on escape too
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") {
        emojiPicker.style.display = "none";
      }
    });

    // Accessibility: ensure audio won't break page if CORS or other issues
    backgroundAudio.addEventListener("error", (e) => {
      console.warn("Audio playback error:", e);
    });
  </script>
</body>
</html>
