<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>KAMBA Forum - Chat</title>
<style>
  /* Reset */
  *, *::before, *::after {
    box-sizing: border-box;
  }
  body, html {
    margin: 0; padding: 0;
    height: 100vh;
    font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    background: #36393f;
    color: #dcddde;
    display: flex;
    overflow: hidden;
  }
  /* === Sidebar 1: Groups (thin vertical bar) === */
  #groups-sidebar {
    width: 60px;
    background: #2f3136;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding-top: 10px;
    user-select: none;
    position: relative;
    transition: width 0.3s ease;
  }
  #groups-sidebar.collapsed {
    width: 10px;
  }
  #groups-sidebar h2 {
    font-size: 0;
    margin: 0 0 10px 0;
  }
  #groups-list {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 12px;
    width: 100%;
    align-items: center;
    overflow-y: auto;
  }
  .group-icon {
    width: 38px;
    height: 38px;
    border-radius: 50%;
    background-color: #5865f2;
    color: white;
    font-weight: 700;
    font-size: 18px;
    display: flex;
    justify-content: center;
    align-items: center;
    cursor: pointer;
    position: relative;
  }
  .group-icon:hover {
    filter: brightness(1.2);
  }
  #groups-toggle-btn {
    position: absolute;
    bottom: 12px;
    cursor: pointer;
    color: #72767d;
    font-size: 20px;
    user-select: none;
    transition: color 0.2s ease;
  }
  #groups-toggle-btn:hover {
    color: #5865f2;
  }
  /* === Sidebar 2: Main Sidebar === */
  #main-sidebar {
    width: 280px;
    background: #2f3136;
    display: flex;
    flex-direction: column;
    padding: 15px 20px;
    transition: margin-left 0.3s ease;
    overflow-y: auto;
    user-select: none;
  }
  #main-sidebar.collapsed {
    margin-left: -280px;
  }
  #main-sidebar header {
    font-weight: 700;
    font-size: 1.3rem;
    margin-bottom: 10px;
    color: #fff;
  }
  #sidebar-hide-btn {
    align-self: flex-end;
    cursor: pointer;
    font-size: 20px;
    color: #72767d;
    margin-bottom: 12px;
    user-select: none;
    transition: color 0.2s ease;
  }
  #sidebar-hide-btn:hover {
    color: #5865f2;
  }
  /* Search bar */
  #search-bar {
    display: flex;
    margin-bottom: 12px;
  }
  #search-input {
    flex: 1;
    padding: 8px 12px;
    border-radius: 6px 0 0 6px;
    border: none;
    font-size: 1rem;
    background-color: #202225;
    color: #dcddde;
  }
  #search-input::placeholder {
    color: #72767d;
  }
  #search-clear-btn {
    background-color: #5865f2;
    border: none;
    color: white;
    cursor: pointer;
    padding: 8px 12px;
    border-radius: 0 6px 6px 0;
    font-weight: 700;
  }
  #search-clear-btn:hover {
    background-color: #4752c4;
  }
  /* Search results container */
  #search-results {
    max-height: 250px;
    overflow-y: auto;
    background-color: #202225;
    border-radius: 6px;
    margin-bottom: 15px;
  }
  .search-result-item {
    padding: 8px 10px;
    border-bottom: 1px solid #5865f2;
    cursor: pointer;
  }
  .search-result-item:hover {
    background-color: #5865f2;
    color: white;
  }
  /* Sections in sidebar */
  .sidebar-section {
    margin-bottom: 20px;
  }
  .sidebar-section h3 {
    font-weight: 700;
    margin-bottom: 8px;
    color: #b9bbbe;
    font-size: 1.1rem;
  }
  .list-item {
    background: #202225;
    padding: 8px 12px;
    border-radius: 6px;
    cursor: pointer;
    margin-bottom: 6px;
    color: #dcddde;
    user-select: none;
  }
  .list-item:hover {
    background: #5865f2;
    color: white;
  }
  /* === Chat container and header === */
  #chat-section {
    flex: 1;
    display: flex;
    flex-direction: column;
    position: relative;
  }
  header#chat-header {
    background-color: #2f3136;
    padding: 1rem 2rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    color: white;
  }
  header#chat-header h1 {
    margin: 0;
    font-size: 1.5rem;
  }
  #profile-icon {
    width: 38px;
    height: 38px;
    border-radius: 50%;
    background-color: gray;
    cursor: pointer;
    display: flex;
    justify-content: center;
    align-items: center;
    font-weight: 700;
    font-size: 1.1rem;
    user-select: none;
    transition: background-color 0.3s ease;
  }
  #profile-icon:hover {
    filter: brightness(1.2);
  }
  /* === Chat messages area === */
  #chat-container {
    flex: 1;
    overflow-y: auto;
    padding: 1rem 2rem;
    background-color: #2f3136;
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }
  /* Modern chat bubble styling with Snapchat vibes */
  .message {
    max-width: 70%;
    padding: 12px 16px;
    border-radius: 20px;
    position: relative;
    background: linear-gradient(145deg, #40444b, #2f3136);
    box-shadow:
      3px 3px 6px #24272b,
      -3px -3px 6px #4c5157;
    word-wrap: break-word;
  }
  .message.sent {
    margin-left: auto;
    background: linear-gradient(145deg, #5865f2, #4752c4);
    box-shadow:
      3px 3px 8px #3a43a1,
      -3px -3px 8px #6f7de9;
    color: white;
  }
  .username {
    font-weight: 700;
    margin-bottom: 0.2rem;
    user-select: none;
  }
  .username.green { color: #43b581; }
  .username.blue { color: #5865f2; }
  .username.violet { color: #9b59b6; }
  .username.red { color: #f04747; }
  .message-text {
    white-space: pre-wrap;
  }
  .reply-to {
    font-size: 0.75rem;
    color: #b9bbbe;
    margin-bottom: 0.3rem;
    padding-left: 0.7rem;
    border-left: 2px solid #5865f2;
  }
  .reply-btn {
    font-size: 0.7rem;
    color: #5865f2;
    cursor: pointer;
    margin-top: 0.3rem;
    user-select: none;
  }
  .reply-btn:hover {
    text-decoration: underline;
  }
  /* Image thumbnails */
  .chat-image {
    max-width: 140px;
    max-height: 140px;
    border-radius: 16px;
    margin-top: 8px;
    cursor: pointer;
    position: relative;
  }
  .img-save-icon {
    position: absolute;
    right: 6px;
    bottom: 6px;
    background: rgba(0,0,0,0.6);
    border-radius: 50%;
    padding: 4px;
    cursor: pointer;
    color: white;
    font-size: 16px;
    user-select: none;
  }
  /* Fullscreen image viewer */
  #fullscreen-img-viewer {
    display: none;
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background-color: rgba(0,0,0,0.9);
    justify-content: center;
    align-items: center;
    z-index: 10000;
    cursor: zoom-out;
  }
  #fullscreen-img-viewer img {
    max-width: 90vw;
    max-height: 90vh;
    border-radius: 16px;
  }
  /* Link preview card */
  .link-preview {
    margin-top: 6px;
    border: 1px solid #5865f2;
    border-radius: 16px;
    padding: 12px;
    display: flex;
    gap: 14px;
    background-color: #2f3136;
  }
  .link-preview img {
    width: 100px;
    height: 100px;
    object-fit: cover;
    border-radius: 16px;
  }
  .link-preview-content {
    flex: 1;
    color: #dcddde;
  }
  .link-preview-title {
    font-weight: 700;
    margin-bottom: 6px;
    font-size: 1.1rem;
  }
  .link-preview-description {
    font-size: 0.9rem;
    opacity: 0.7;
  }
  /* Message input area */
  #message-input-area {
    background-color: #40444b;
    padding: 1rem 1.5rem;
    display: flex;
    align-items: center;
    gap: 0.7rem;
    position: relative;
    border-radius: 20px;
    margin: 0 2rem 1.5rem 2rem;
  }
  #message-input {
    flex: 1;
    padding: 12px 16px;
    border-radius: 20px;
    border: none;
    font-size: 1rem;
    color: white;
    background-color: #2f3136;
    resize: none;
    min-height: 38px;
    max-height: 90px;
    overflow-y: auto;
    box-shadow:
      inset 3px 3px 6px #24272b,
      inset -3px -3px 6px #4c5157;
  }
  #message-input:focus {
    outline: 2px solid #5865f2;
  }
  #send-btn {
    background-color: #5865f2;
    border: none;
    color: white;
    padding: 10px 18px;
    font-weight: 700;
    border-radius: 20px;
    cursor: pointer;
    transition: background-color 0.2s ease;
    user-select: none;
  }
  #send-btn:hover {
    background-color: #4752c4;
  }
  #emoji-btn, #image-upload-label {
    background: transparent;
    border: none;
    font-size: 1.6rem;
    cursor: pointer;
    color: #b9bbbe;
    user-select: none;
    transition: color 0.15s ease;
  }
  #emoji-btn:hover, #image-upload-label:hover {
    color: #5865f2;
  }
  #emoji-picker {
    position: absolute;
    bottom: 4.8rem;
    right: 4.5rem;
    background-color: #202225;
    border-radius: 12px;
    padding: 0.7rem 1rem;
    display: none;
    box-shadow: 0 0 14px rgba(0,0,0,0.85);
    z-index: 1000;
  }
  #emoji-picker span {
    font-size: 1.7rem;
    margin: 0 8px;
    cursor: pointer;
    user-select: none;
    transition: transform 0.15s ease;
  }
  #emoji-picker span:hover {
    transform: scale(1.3);
  }
  /* No song notification */
  #no-song-notification {
    background-color: #f04747;
    color: white;
    text-align: center;
    padding: 0.7rem 1rem;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 15px;
  }
  #no-song-notification button {
    background: #202225;
    border: none;
    color: #f04747;
    font-weight: 700;
    padding: 6px 12px;
    border-radius: 6px;
    cursor: pointer;
    user-select: none;
  }
  #no-song-notification button:hover {
    background: #f04747;
    color: white;
  }
  /* Scrollbars */
  #chat-container::-webkit-scrollbar,
  #groups-list::-webkit-scrollbar,
  #main-sidebar::-webkit-scrollbar,
  #search-results::-webkit-scrollbar {
    width: 8px;
  }
  #chat-container::-webkit-scrollbar-thumb,
  #groups-list::-webkit-scrollbar-thumb,
  #main-sidebar::-webkit-scrollbar-thumb,
  #search-results::-webkit-scrollbar-thumb {
    background-color: #5865f2;
    border-radius: 5px;
  }
  /* Responsive */
  @media (max-width: 900px) {
    #groups-sidebar {
      display: none;
    }
    #main-sidebar {
      position: fixed;
      left: 0;
      top: 0;
      bottom: 0;
      z-index: 15000;
      width: 280px;
      transform: translateX(-100%);
      transition: transform 0.3s ease;
      background-color: #2f3136;
    }
    #main-sidebar.visible {
      transform: translateX(0);
    }
    #sidebar-hide-btn {
      display: none;
    }
    #chat-section {
      padding: 0 10px 0 10px;
    }
  }
</style>
</head>
<body>

<!-- Left thin sidebar: Groups -->
<div id="groups-sidebar" aria-label="Groups Sidebar">
  <div id="groups-list" tabindex="0" role="list" aria-label="Your groups">
    <!-- Dynamically loaded group icons -->
  </div>
  <div id="groups-toggle-btn" title="Toggle groups sidebar" role="button" tabindex="0">⇔</div>
</div>

<!-- Left main sidebar -->
<nav id="main-sidebar" aria-label="Main Sidebar">
  <div id="sidebar-hide-btn" role="button" tabindex="0" title="Hide sidebar">✕</div>
  <header>KAMBA Menu</header>

  <div id="search-bar" role="search">
    <input type="search" id="search-input" placeholder="Search users, projects, groups..." aria-label="Search" />
    <button id="search-clear-btn" aria-label="Clear search">✕</button>
  </div>
  <div id="search-results" role="list" aria-live="polite" aria-relevant="additions"></div>

  <section class="sidebar-section" aria-label="Announcements">
    <h3>Announcements</h3>
    <div id="announcements-list" role="list" tabindex="0">
      <!-- Loaded announcements -->
    </div>
  </section>

  <section class="sidebar-section" aria-label="Sub-Communities">
    <h3>Sub-Communities</h3>
    <div id="subcommunities-list" role="list" tabindex="0">
      <!-- Loaded sub-communities -->
    </div>
  </section>

  <section class="sidebar-section" aria-label="My Projects">
    <h3>My Projects</h3>
    <div id="my-projects-list" role="list" tabindex="0">
      <!-- Loaded projects -->
    </div>
  </section>
</nav>

<!-- Main chat section -->
<div id="chat-section" role="main" aria-label="Chat Area">
  <header id="chat-header">
    <h1>KAMBA Forum</h1>
    <div id="profile-icon" title="Profile" role="button" tabindex="0" aria-label="Profile"></div>
  </header>

  <!-- No song notification -->
  <div id="no-song-notification" role="alert" aria-live="assertive" style="display:none;">
    No song set. Click here to set your song in <strong>Settings</strong>.
    <button id="dismiss-no-song-btn" aria-label="Dismiss notification for 10 hours">Dismiss</button>
  </div>

  <!-- Chat messages container -->
  <div id="chat-container" aria-live="polite" aria-relevant="additions"></div>

  <!-- Message input area -->
  <div id="message-input-area">
    <button id="emoji-btn" title="Show emojis" aria-label="Show emojis">😊</button>
    <textarea id="message-input" placeholder="Type a message..." rows="1" aria-multiline="true" aria-label="Message input"></textarea>
    <label for="image-upload-input" id="image-upload-label" title="Upload images" aria-label="Upload images">📷</label>
    <input type="file" id="image-upload-input" accept="image/*" multiple style="display:none" aria-hidden="true" />
    <button id="send-btn" aria-label="Send message">Send</button>
  </div>
</div>

<!-- Fullscreen image viewer -->
<div id="fullscreen-img-viewer" role="dialog" aria-modal="true" tabindex="-1">
  <img src="" alt="Full screen preview image" />
</div>

<script type="module">
// Firebase and Firestore imports (same as your existing config)
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
import {
  getFirestore, collection, query, orderBy, onSnapshot, addDoc,
  doc, getDoc, updateDoc, where, limit, startAt, endAt
} from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

// Initialize Firebase
const firebaseConfig = {
  apiKey: "AIzaSyCW2RJIku0JLJZTUu0YA9yKO8zjtX29fAo",
  authDomain: "muah-feed.firebaseapp.com",
  databaseURL: "https://muah-feed-default-rtdb.firebaseio.com",
  projectId: "muah-feed",
  storageBucket: "muah-feed.firebasestorage.app",
  messagingSenderId: "442314397706",
  appId: "1:442314397706:web:a69e3958257fb13b3667f3",
  measurementId: "G-S86S229F1T"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// DOM elements
const chatContainer = document.getElementById("chat-container");
const messageInput = document.getElementById("message-input");
const sendBtn = document.getElementById("send-btn");
const imageUploadInput = document.getElementById("image-upload-input");
const emojiBtn = document.getElementById("emoji-btn");
const emojiPicker = document.createElement("div");
emojiPicker.id = "emoji-picker";
document.body.appendChild(emojiPicker);
const noSongNotification = document.getElementById("no-song-notification");
const dismissNoSongBtn = document.getElementById("dismiss-no-song-btn");
const profileIcon = document.getElementById("profile-icon");
const fullscreenViewer = document.getElementById("fullscreen-img-viewer");
const fullscreenImg = fullscreenViewer.querySelector("img");
const groupsSidebar = document.getElementById("groups-sidebar");
const groupsList = document.getElementById("groups-list");
const groupsToggleBtn = document.getElementById("groups-toggle-btn");
const mainSidebar = document.getElementById("main-sidebar");
const sidebarHideBtn = document.getElementById("sidebar-hide-btn");
const searchInput = document.getElementById("search-input");
const searchClearBtn = document.getElementById("search-clear-btn");
const searchResults = document.getElementById("search-results");
const announcementsList = document.getElementById("announcements-list");
const subcommunitiesList = document.getElementById("subcommunities-list");
const myProjectsList = document.getElementById("my-projects-list");

// User state
let currentUser = null;
let currentUserData = null;
let replyToMessageId = null;
let replyToMessageText = null;

// Emoji list example (5 emojis, you can expand)
const emojis = ["😊", "😂", "🔥", "💬", "❤️"];

// Helper: debounce function for search
function debounce(func, wait) {
  let timeout;
  return function (...args) {
    clearTimeout(timeout);
    timeout = setTimeout(() => func.apply(this, args), wait);
  };
}

// Helper: simplify email to username (remove domain)
function simplifyEmail(email) {
  if (!email) return "unknown";
  return email.split("@")[0];
}

// ========== Emoji Picker Setup ==========
function setupEmojiPicker() {
  emojis.forEach(emoji => {
    const span = document.createElement("span");
    span.textContent = emoji;
    span.title = emoji;
    span.addEventListener("click", () => {
      messageInput.value += emoji;
      messageInput.focus();
      emojiPicker.style.display = "none";
      resizeTextarea();
    });
    emojiPicker.appendChild(span);
  });
}
setupEmojiPicker();

emojiBtn.addEventListener("click", () => {
  emojiPicker.style.display = emojiPicker.style.display === "block" ? "none" : "block";
});

// Resize textarea height dynamically
function resizeTextarea() {
  messageInput.style.height = "auto";
  messageInput.style.height = messageInput.scrollHeight + 2 + "px";
}
messageInput.addEventListener("input", resizeTextarea);
resizeTextarea();

// ========== Fullscreen image viewer ==========
function openFullscreenImage(url) {
  fullscreenImg.src = url;
  fullscreenViewer.style.display = "flex";
  fullscreenViewer.focus();
}
fullscreenViewer.addEventListener("click", () => {
  fullscreenViewer.style.display = "none";
  fullscreenImg.src = "";
});

// ========== Image Upload with imgbb ==========
async function uploadImages(files) {
  let totalSize = 0;
  for (const file of files) totalSize += file.size;
  if (totalSize > 6 * 1024 * 1024) {
    alert("Total images size must not exceed 6 MB.");
    return null;
  }
  const uploadedUrls = [];
  for (const file of files) {
    const formData = new FormData();
    formData.append("image", file);
    try {
      const res = await fetch("https://api.imgbb.com/1/upload?key=0f248e70fc4e7dffde307dd772823379", {
        method: "POST",
        body: formData,
      });
      const json = await res.json();
      if (json.success) uploadedUrls.push(json.data.display_url);
      else {
        alert("Image upload failed: " + (json.error?.message || "Unknown error"));
        return null;
      }
    } catch (err) {
      alert("Image upload error: " + err.message);
      return null;
    }
  }
  return uploadedUrls;
}

// ========== Chat message rendering ==========
function renderMessage(id, msgData) {
  const div = document.createElement("div");
  div.classList.add("message");
  div.dataset.messageId = id;

  // Username with color class based on status
  const usernameSpan = document.createElement("div");
  usernameSpan.className = `username ${msgData.status || "green"}`;
  usernameSpan.textContent = msgData.sender;
  div.appendChild(usernameSpan);

  // Reply text if any
  if (msgData.replyToText) {
    const replyDiv = document.createElement("div");
    replyDiv.className = "reply-to";
    replyDiv.textContent = "Replying to: " + msgData.replyToText;
    div.appendChild(replyDiv);
  }

  // Message text with URLs linked and previews
  const textDiv = document.createElement("div");
  textDiv.className = "message-text";
  textDiv.innerHTML = linkifyAndPreview(msgData.message);
  div.appendChild(textDiv);

  // Images thumbnails if any
  if (msgData.images && msgData.images.length) {
    msgData.images.forEach((imgUrl) => {
      const imgWrapper = document.createElement("div");
      imgWrapper.style.position = "relative";
      imgWrapper.style.display = "inline-block";

      const img = document.createElement("img");
      img.src = imgUrl;
      img.alt = "Shared image";
      img.className = "chat-image";
      imgWrapper.appendChild(img);

      // Save icon on image
      const saveIcon = document.createElement("div");
      saveIcon.className = "img-save-icon";
      saveIcon.title = "Open image full screen";
      saveIcon.textContent = "💾";
      saveIcon.addEventListener("click", (e) => {
        e.stopPropagation();
        openFullscreenImage(imgUrl);
      });
      imgWrapper.appendChild(saveIcon);

      img.addEventListener("click", () => openFullscreenImage(imgUrl));

      div.appendChild(imgWrapper);
    });
  }

  // Reply button
  const replyBtn = document.createElement("div");
  replyBtn.className = "reply-btn";
  replyBtn.textContent = "Reply";
  replyBtn.addEventListener("click", () => {
    replyToMessageId = id;
    replyToMessageText = msgData.message;
    messageInput.focus();
    messageInput.placeholder = "Replying: " + replyToMessageText.slice(0, 30) + "... (click send)";
    resizeTextarea();
  });
  div.appendChild(replyBtn);

  return div;
}

// Linkify and preview first URL (images, YouTube)
function linkifyAndPreview(text) {
  const urlRegex = /https?:\/\/[^\s]+/g;
  let result = text.replace(urlRegex, url => {
    return `<a href="${url}" target="_blank" rel="noopener noreferrer">${url}</a>`;
  });

  const urls = text.match(urlRegex);
  if (!urls) return result;

  const firstUrl = urls[0];
  let previewHtml = "";

  if (firstUrl.match(/\.(jpeg|jpg|gif|png|webp|bmp)$/i)) {
    previewHtml = `<div class="link-preview"><img src="${firstUrl}" alt="Image preview"/><div class="link-preview-content"><div class="link-preview-title">Image</div></div></div>`;
  }
  else if (firstUrl.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([\w-]+)/)) {
    const match = firstUrl.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([\w-]+)/);
    const videoId = match[1];
    previewHtml = `
    <div class="link-preview">
      <img src="https://img.youtube.com/vi/${videoId}/hqdefault.jpg" alt="YouTube thumbnail"/>
      <div class="link-preview-content">
        <div class="link-preview-title">YouTube Video</div>
        <div class="link-preview-description">Click link to watch video</div>
      </div>
    </div>`;
  }

  return previewHtml ? result + previewHtml : result;
}

// Setup Firestore listener for chat messages
function setupMessagesListener() {
  const messagesQuery = query(
    collection(db, "Kamba_messages"),
    orderBy("timestamp", "asc")
  );

  onSnapshot(messagesQuery, async (querySnapshot) => {
    chatContainer.innerHTML = "";

    // Collect unique user IDs
    const userIds = new Set();
    querySnapshot.forEach(doc => userIds.add(doc.data().userId));

    // Fetch user data in bulk
    const userDataMap = new Map();
    const userDocsPromises = [];
    userIds.forEach(uid => userDocsPromises.push(getDoc(doc(db, "Kamba_users", uid))));
    const userDocs = await Promise.all(userDocsPromises);
    userDocs.forEach(docSnap => {
      if (docSnap.exists()) userDataMap.set(docSnap.id, docSnap.data());
    });

    querySnapshot.forEach(docSnap => {
      const data = docSnap.data();
      const senderUid = data.userId;
      const userData = userDataMap.get(senderUid);
      const displayName = simplifyEmail(data.senderEmail || "unknown");
      const status = userData ? userData.status : "green";

      const messageData = {
        sender: displayName,
        status,
        message: data.message,
        replyToText: data.replyToText || null,
        images: data.images || [],
      };
      const msgDiv = renderMessage(docSnap.id, messageData);
      chatContainer.appendChild(msgDiv);
    });

    chatContainer.scrollTop = chatContainer.scrollHeight;
  });
}

// ========== Send message logic =============
sendBtn.addEventListener("click", sendMessage);
messageInput.addEventListener("keydown", (e) => {
  if (e.key === "Enter" && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
  }
});

async function sendMessage() {
  const text = messageInput.value.trim();
  const files = imageUploadInput.files;

  if (!text && (!files || files.length === 0)) return; // Nothing to send

  const senderEmail = currentUser.email;
  const userId = currentUser.uid;
  const userDocRef = doc(db, "Kamba_users", userId);
  const userDocSnap = await getDoc(userDocRef);
  if (!userDocSnap.exists()) {
    alert("User data missing. Contact admin.");
    return;
  }
  const userData = userDocSnap.data();

  sendBtn.disabled = true;
  sendBtn.textContent = "Sending...";

  try {
    let imageUrls = [];
    if (files && files.length > 0) {
      imageUrls = await uploadImages(files);
      if (imageUrls === null) throw new Error("Image upload failed");
    }

    await addDoc(collection(db, "Kamba_messages"), {
      userId,
      senderEmail,
      sender: simplifyEmail(senderEmail),
      message: text,
      replyTo: replyToMessageId || null,
      replyToText: replyToMessageText || null,
      timestamp: Date.now(),
      images: imageUrls,
    });

    // Reset input
    messageInput.value = "";
    imageUploadInput.value = "";
    messageInput.placeholder = "Type a message...";
    replyToMessageId = null;
    replyToMessageText = null;
    resizeTextarea();

    // Update sparks and status
    let newSparks = (userData.sparks || 0) + 1;
    let newStatus = userData.status || "green";
    if (newSparks >= 1000) newStatus = "violet";
    else if (newSparks >= 100) newStatus = "blue";
    else newStatus = "green";

    await updateDoc(userDocRef, {
      sparks: newSparks,
      status: newStatus,
    });
  } catch (err) {
    alert("Error sending message: " + err.message);
  } finally {
    sendBtn.disabled = false;
    sendBtn.textContent = "Send";
  }
}

// ========== Search logic with debounce ==========
let searchTimeout = null;
searchInput.addEventListener("input", () => {
  if (searchTimeout) clearTimeout(searchTimeout);
  searchTimeout = setTimeout(doSearch, 300);
});

searchClearBtn.addEventListener("click", () => {
  searchInput.value = "";
  searchResults.innerHTML = "";
});

async function doSearch() {
  const term = searchInput.value.trim().toLowerCase();
  if (!term) {
    searchResults.innerHTML = "";
    return;
  }
  searchResults.innerHTML = `<div class="list-item">Searching for "${term}"...</div>`;

  // Search users by email username (simplified)
  const usersRef = collection(db, "Kamba_users");
  const qUsers = query(usersRef, orderBy("email"), startAt(term), endAt(term + "\uf8ff"), limit(5));

  // Search projects
  const projectsRef = collection(db, "Kamba_projects");
  const qProjects = query(projectsRef, orderBy("name_lower"), startAt(term), endAt(term + "\uf8ff"), limit(5));

  // Search groups
  const groupsRef = collection(db, "Kamba_groups");
  const qGroups = query(groupsRef, orderBy("name_lower"), startAt(term), endAt(term + "\uf8ff"), limit(5));

  // Search sub-communities
  const subcomRef = collection(db, "Kamba_subcommunities");
  const qSubcom = query(subcomRef, orderBy("name_lower"), startAt(term), endAt(term + "\uf8ff"), limit(5));

  const results = [];

  try {
    const [usersSnap, projectsSnap, groupsSnap, subcomSnap] = await Promise.all([
      getDocs(qUsers),
      getDocs(qProjects),
      getDocs(qGroups),
      getDocs(qSubcom),
    ]);
    // Users
    usersSnap.forEach(doc => {
      const d = doc.data();
      const username = d.email.split("@")[0];
      results.push({ type: "User", name: username, id: doc.id });
    });
    // Projects
    projectsSnap.forEach(doc => {
      const d = doc.data();
      results.push({ type: "Project", name: d.name, id: doc.id });
    });
    // Groups
    groupsSnap.forEach(doc => {
      const d = doc.data();
      results.push({ type: "Group", name: d.name, id: doc.id });
    });
    // Sub-communities
    subcomSnap.forEach(doc => {
      const d = doc.data();
      results.push({ type: "Sub-Community", name: d.name, id: doc.id });
    });

    if (results.length === 0) {
      searchResults.innerHTML = `<div class="list-item">No results found</div>`;
      return;
    }
    // Show results
    searchResults.innerHTML = "";
    results.forEach(r => {
      const item = document.createElement("div");
      item.className = "list-item";
      item.textContent = `${r.type}: ${r.name}`;
      item.tabIndex = 0;
      item.addEventListener("click", () => {
        alert(`Open page for ${r.type} "${r.name}" - feature not implemented.`);
      });
      searchResults.appendChild(item);
    });
  } catch (err) {
    searchResults.innerHTML = `<div class="list-item">Error searching: ${err.message}</div>`;
  }
}

// ========== Groups sidebar toggle ==========
groupsToggleBtn.addEventListener("click", () => {
  groupsSidebar.classList.toggle("collapsed");
});
groupsToggleBtn.addEventListener("keydown", e => {
  if (e.key === "Enter") groupsToggleBtn.click();
});

// ========== Main sidebar hide/show ==========
sidebarHideBtn.addEventListener("click", () => {
  mainSidebar.classList.add("collapsed");
});
mainSidebar.addEventListener("keydown", e => {
  if (e.key === "Escape") mainSidebar.classList.add("collapsed");
});

// ========== Profile icon and redirect to settings ==========
profileIcon.addEventListener("click", () => {
  window.location.href = "settings.html";
});
profileIcon.addEventListener("keydown", e => {
  if (e.key === "Enter") profileIcon.click();
});

// ========== User Auth and UI initialization ==========
import { getDocs } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

function setProfileIconColor(status) {
  let color = "gray";
  switch (status) {
    case "red": color = "#f04747"; break;
    case "violet": color = "#9b59b6"; break;
    case "blue": color = "#5865f2"; break;
    case "green": color = "#43b581"; break;
  }
  profileIcon.style.backgroundColor = color;
  profileIcon.textContent = (currentUser.email || "U")[0].toUpperCase();
}

function loadGroups() {
  // Load groups user belongs to
  const userGroups = currentUserData?.groups || [];
  groupsList.innerHTML = "";
  userGroups.forEach(g => {
    const groupDiv = document.createElement("div");
    groupDiv.className = "group-icon";
    groupDiv.textContent = g[0].toUpperCase();
    groupsList.appendChild(groupDiv);
  });
}

// Announcements
function loadAnnouncements() {
  announcementsList.innerHTML = "";
  const announcementsRef = collection(db, "Kamba_announcements");
  onSnapshot(announcementsRef, (snapshot) => {
    announcementsList.innerHTML = "";
    snapshot.forEach(doc => {
      const data = doc.data();
      const div = document.createElement("div");
      div.className = "list-item";
      div.textContent = data.text || "Announcement";
      announcementsList.appendChild(div);
    });
  });
}
// Sub-communities
function loadSubcommunities() {
  subcommunitiesList.innerHTML = "";
  const subcomRef = collection(db, "Kamba_subcommunities");
  onSnapshot(subcomRef, (snapshot) => {
    subcommunitiesList.innerHTML = "";
    snapshot.forEach(doc => {
      const data = doc.data();
      const div = document.createElement("div");
      div.className = "list-item";
      div.textContent = data.name || "Sub-community";
      subcommunitiesList.appendChild(div);
    });
  });
}
// My projects
function loadProjects() {
  myProjectsList.innerHTML = "";
  const projectsRef = collection(db, "Kamba_projects");
  const q = query(projectsRef, where("ownerId", "==", currentUser.uid));
  onSnapshot(q, (snapshot) => {
    myProjectsList.innerHTML = "";
    snapshot.forEach(doc => {
      const data = doc.data();
      const div = document.createElement("div");
      div.className = "list-item";
      div.textContent = data.name || "Project";
      myProjectsList.appendChild(div);
    });
  });
}

// ========== No song notification dismiss control ==========
const NO_SONG_DISMISS_KEY = "no_song_dismissed_until";
function showNoSongNotification() {
  const dismissedUntil = localStorage.getItem(NO_SONG_DISMISS_KEY);
  if (dismissedUntil && Date.now() < parseInt(dismissedUntil)) {
    noSongNotification.style.display = "none";
  } else {
    noSongNotification.style.display = "flex";
  }
}
dismissNoSongBtn.addEventListener("click", () => {
  const tenHoursMs = 10 * 60 * 60 * 1000;
  localStorage.setItem(NO_SONG_DISMISS_KEY, Date.now() + tenHoursMs);
  noSongNotification.style.display = "none";
});

// ========== Check if song is set and play loop ==========
// For demo: simulate song URL stored in Firestore user doc
let audioPlayer = null;
function setupAudioPlayer(songUrl) {
  if (!songUrl) {
    showNoSongNotification();
    if (audioPlayer) {
      audioPlayer.pause();
      audioPlayer = null;
    }
    return;
  }
  noSongNotification.style.display = "none";

  if (audioPlayer) {
    audioPlayer.pause();
  }
  audioPlayer = new Audio(songUrl);
  audioPlayer.loop = true;
  audioPlayer.volume = 0.5;
  audioPlayer.play().catch(() => { /* autoplay might be blocked */ });

  // TODO: add volume & song controls in settings.html
}

// ========== Initial Auth check and UI setup ==========
onAuthStateChanged(auth, async (user) => {
  if (!user) {
    window.location.href = "sign.html"; // redirect to login if not logged in
    return;
  }
  currentUser = user;

  const userDocRef = doc(db, "Kamba_users", currentUser.uid);
  const userDocSnap = await getDoc(userDocRef);
  if (!userDocSnap.exists()) {
    alert("User profile missing, contact admin.");
    return;
  }
  currentUserData = userDocSnap.data();

  // Set profile icon color and initials
  setProfileIconColor(currentUserData.status || "green");

  // Load sidebars data
  loadGroups();
  loadAnnouncements();
  loadSubcommunities();
  loadProjects();

  // Setup chat listener
  setupMessagesListener();

  // Setup audio player (simulate song URL in userData)
  setupAudioPlayer(currentUserData.songUrl || null);

  // Show agree prompt if first time
  if (!currentUserData.agreed) {
    const agreed = confirm("Agree and Continue to KAMBA Forum?");
    if (agreed) {
      await updateDoc(userDocRef, { agreed: true });
      currentUserData.agreed = true;
    } else {
      alert("You must agree to continue.");
      auth.signOut();
    }
  }
});

// ========== Image upload input handling ==========
imageUploadInput.addEventListener("change", async (e) => {
  // Just update UI or send immediately? We send on send button click
});

// ========== Accessibility keyboard handlers ==========
groupsToggleBtn.setAttribute("tabindex", 0);
sidebarHideBtn.setAttribute("tabindex", 0);
profileIcon.setAttribute("tabindex", 0);
groupsToggleBtn.addEventListener("keydown", e => { if(e.key==="Enter") groupsToggleBtn.click(); });
sidebarHideBtn.addEventListener("keydown", e => { if(e.key==="Enter") sidebarHideBtn.click(); });
profileIcon.addEventListener("keydown", e => { if(e.key==="Enter") profileIcon.click(); });

</script>

</body>
</html>
