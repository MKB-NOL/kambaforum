<!DOCTYPE html>
<html lang="en">
<head>
  <!-- ... head content unchanged except styles ... -->
  <style>
    /* ... previous styles ... */

    /* Replace reply button text with icon */
    .reply-btn {
      display: inline-flex;
      align-items: center;
      cursor: pointer;
      color: #5865f2;
      user-select: none;
      gap: 4px;
      font-weight: 600;
      font-size: 0.9rem;
      transition: color 0.2s;
    }
    .reply-btn:hover {
      color: #4752c4;
    }
    .reply-btn svg {
      fill: currentColor;
      width: 18px;
      height: 18px;
    }

    /* Create Group icon button */
    .create-group-btn {
      background: linear-gradient(90deg,#5865f2,#6f7efc);
      border:none;
      color:white;
      padding: 6px 10px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0;
      transition: background-color 0.3s;
    }
    .create-group-btn:hover {
      background: linear-gradient(90deg,#4752c4,#5a68e0);
    }
    .create-group-btn svg {
      width: 20px;
      height: 20px;
      fill: currentColor;
    }

    /* No-song notification with icon and close icon */
    #no-song-notification {
      background-color: #f04747;
      color: white;
      text-align: center;
      padding: 0.6rem 36px 0.6rem 36px;
      font-weight: 600;
      cursor: pointer;
      display: none;
      position: relative;
      user-select:none;
      font-size: 1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    #no-song-notification svg {
      fill: white;
      width: 18px;
      height: 18px;
      flex-shrink: 0;
    }
    #no-song-notification .dismiss-btn {
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(0,0,0,0.2);
      border: none;
      color: #fff;
      padding: 4px 8px;
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 26px;
      height: 26px;
      font-size: 0;
      transition: background-color 0.2s;
    }
    #no-song-notification .dismiss-btn:hover {
      background: rgba(0,0,0,0.4);
    }
    #no-song-notification .dismiss-btn svg {
      width: 14px;
      height: 14px;
      stroke: white;
      stroke-width: 2;
      stroke-linecap: round;
      stroke-linejoin: round;
      fill: none;
    }

    /* Message input area: icon style buttons */
    #message-input-area {
      background-color: #40444b;
      padding: 0.6rem;
      display: flex;
      gap: 8px;
      align-items: center;
      border-top: 1px solid rgba(0,0,0,0.4);
    }
    #message-input {
      flex: 1;
      padding: 0.5rem 0.75rem;
      border-radius: 8px;
      border: none;
      font-size: 1rem;
      color: #fff;
      background-color: #2f3136;
      min-height: 38px;
      max-height: 120px;
      resize: vertical;
    }
    #message-input:focus {
      outline: 2px solid #5865f2;
    }

    #emoji-btn, #send-btn {
      background: transparent;
      border: none;
      cursor: pointer;
      color: #b9bbbe;
      font-size: 20px;
      padding: 6px;
      border-radius: 6px;
      transition: background-color 0.2s, color 0.2s;
    }
    #emoji-btn:hover, #send-btn:hover {
      background-color: #5865f2;
      color: white;
    }
    #send-btn {
      font-weight: 700;
      font-size: 16px;
      color: white;
      background-color: #5865f2;
      padding: 6px 14px;
      border-radius: 8px;
      transition: background-color 0.3s;
    }
    #send-btn:hover {
      background-color: #4752c4;
    }
    #cancel-reply {
      background: transparent;
      border: none;
      color: #ffb0b0;
      cursor: pointer;
      font-size: 0.85rem;
      display: none;
    }

    /* Image input hidden, replaced with icon */
    #image-input {
      display: none;
    }
    #attach-image-label {
      color: #b9bbbe;
      cursor: pointer;
      font-size: 20px;
      user-select:none;
      padding: 6px;
      border-radius: 6px;
      transition: background-color 0.2s, color 0.2s;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    #attach-image-label:hover {
      background-color: #5865f2;
      color: white;
    }

    /* Sidebar groups: improved */
    #sidebar {
      width: 88px;
      min-width: 72px;
      max-width: 420px;
      resize: horizontal;
      overflow-y: auto;
      background: linear-gradient(180deg, #2b2f33, #232428);
      border-left: 1px solid rgba(0, 0, 0, 0.5);
      padding: 12px 8px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      transition: width 0.25s ease;
      user-select:none;
    }
    #sidebar.expanded {
      width: 260px;
    }

    .groups-title {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      color: #cfd3d6;
      font-weight: 700;
      font-size: 0.95rem;
      padding: 0 8px;
    }

    .groups-list {
      display: flex;
      flex-direction: column;
      gap: 14px;
      align-items: center;
    }

    .group-item {
      display: flex;
      align-items: center;
      gap: 12px;
      cursor: pointer;
      width: 100%;
      padding: 6px 8px;
      border-radius: 12px;
      transition: background 0.18s ease;
    }
    .group-item:hover {
      background: rgba(88, 101, 242, 0.15);
    }
    .group-avatar {
      width: 54px;
      height: 54px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid transparent;
      background: #111;
      flex-shrink: 0;
      transition: border-color 0.3s;
    }
    .group-item:hover .group-avatar {
      border-color: #5865f2;
    }
    .group-name {
      color: #e6e7e8;
      font-weight: 600;
      font-size: 1rem;
      display: none;
      user-select:none;
    }
    #sidebar.expanded .group-name {
      display: block;
    }

    /* Create group button replaced with icon plus */
    #groups-actions {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      min-width: 40px;
    }

  </style>
</head>
<body>
  <header>
    <h1>KAMBA Forum</h1>
    <div class="header-actions">
      <button id="open-settings" class="secondary" title="Open settings">‚öôÔ∏è</button>
      <!-- Removed Sign out -->
    </div>
  </header>

  <div class="app-row">
    <div class="chat-column">
      <div id="chat-wrap">
        <div id="chat-container" aria-live="polite" aria-atomic="false"></div>

        <div id="no-song-notification" role="region" aria-label="Song notification" title="No song set. Click here to set your song in Settings.">
          <!-- Music icon -->
          <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
            <path d="M12 3v10.55A4 4 0 1014 17V7h4V3h-6z"></path>
          </svg>
          <span id="no-song-text">No song set. Click here to set your song in Settings.</span>
          <button class="dismiss-btn" id="dismiss-song-btn" aria-label="Dismiss notification" title="Dismiss notification">
            <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
              <path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
            </svg>
          </button>
        </div>

        <div id="message-input-area">
          <button id="emoji-btn" title="Emoji picker" aria-haspopup="list" aria-label="Emoji picker">üòÄ</button>
          <label for="image-input" id="attach-image-label" title="Attach image">üìé</label>
          <input id="image-input" type="file" accept="image/*" title="Attach image" />

          <input id="message-input" type="text" placeholder="Type a message..." autocomplete="off" />
          <button id="cancel-reply" title="Cancel reply">‚úñ</button>
          <button id="send-btn" title="Send message">‚û§</button>
        </div>
      </div>
    </div>

    <!-- Sidebar: groups -->
    <aside id="sidebar" title="Groups">
      <div class="groups-title">
        <div>GROUPS</div>
        <div id="groups-actions" aria-label="Groups actions"></div>
      </div>

      <div class="groups-list" id="groups-list" aria-live="polite"></div>

      <!-- create group modal (hidden) -->
      <div id="create-group-modal" style="display:none; margin-top:6px;">
        <input id="group-name-input" placeholder="Group name" style="width:100%; padding:8px; border-radius:6px; border:none; margin-bottom:8px;" />
        <input id="group-image-input" type="file" accept="image/*" style="width:100%; margin-bottom:8px;" />
        <div style="display:flex; gap:8px;">
          <button id="create-group-confirm" class="create-group-btn" style="flex:1;" title="Create Group">
            <!-- plus icon -->
            <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
              <path d="M19 11h-6V5h-2v6H5v2h6v6h2v-6h6z"/>
            </svg>
          </button>
          <button id="create-group-cancel" class="secondary" style="flex:1;">Cancel</button>
        </div>
      </div>
    </aside>
  </div>

  <audio id="background-audio" loop crossorigin="anonymous"></audio>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
    } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import {
      getFirestore,
      collection,
      query,
      orderBy,
      onSnapshot,
      addDoc,
      doc,
      getDoc,
      updateDoc,
      serverTimestamp,
      getDocs
    } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    // Config + API key unchanged
    const firebaseConfig = {
      apiKey: "AIzaSyCW2RJIku0JLJZTUu0YA9yKO8zjtX29fAo",
      authDomain: "muah-feed.firebaseapp.com",
      databaseURL: "https://muah-feed-default-rtdb.firebaseio.com",
      projectId: "muah-feed",
      storageBucket: "muah-feed.firebasestorage.app",
      messagingSenderId: "442314397706",
      appId: "1:442314397706:web:a69e3958257fb13b3667f3",
      measurementId: "G-S86S229F1T",
    };

    const IMGBB_KEY = "0f248e70fc4e7dffde307dd772823379";
    const IMGBB_UPLOAD_URL = "https://api.imgbb.com/1/upload";

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const chatContainer = document.getElementById("chat-container");
    const messageInput = document.getElementById("message-input");
    const sendBtn = document.getElementById("send-btn");
    const emojiBtn = document.getElementById("emoji-btn");
    const emojiPicker = document.getElementById("emoji-picker");
    const noSongNotification = document.getElementById("no-song-notification");
    const dismissSongBtn = document.getElementById("dismiss-song-btn");
    const imageInput = document.getElementById("image-input");
    const cancelReplyBtn = document.getElementById("cancel-reply");
    const openSettingsBtn = document.getElementById("open-settings");
    const backgroundAudio = document.getElementById("background-audio");

    const sidebar = document.getElementById("sidebar");
    const groupsList = document.getElementById("groups-list");
    const groupsActions = document.getElementById("groups-actions");
    const createGroupModal = document.getElementById("create-group-modal");
    const groupNameInput = document.getElementById("group-name-input");
    const groupImageInput = document.getElementById("group-image-input");
    const createGroupConfirm = document.getElementById("create-group-confirm");
    const createGroupCancel = document.getElementById("create-group-cancel");

    let currentUser = null;
    let currentUserData = null;
    let replyToMessageId = null;
    let replyToMessageText = null;

    // Helpers same as before
    function simplifyEmail(email = "") {
      return (email.split("@")[0] || "unknown").replace(/\.[0-9]+$/,'');
    }
    function getStatusClass(status) {
      switch (status) {
        case "green": return "green";
        case "blue": return "blue";
        case "violet": return "violet";
        case "red": return "red";
        default: return "green";
      }
    }
    function formatTimestamp(ts) {
      if (!ts) return "";
      let d;
      if (typeof ts.toDate === "function") d = ts.toDate();
      else if (typeof ts === "number") d = new Date(ts);
      else d = new Date(ts);
      return d.toLocaleString();
    }

    // Clean chat
    function clearChat() {
      chatContainer.innerHTML = "";
    }

    // Show message in chat container
    function showMessage(msgData) {
      const { id, userEmail, userName, userStatus, message, replyTo } = msgData;

      const msgDiv = document.createElement("div");
      msgDiv.className = "message";
      msgDiv.dataset.id = id;

      // message header with avatar + name + timestamp
      const avatarDiv = document.createElement("div");
      avatarDiv.className = "avatar " + getStatusClass(userStatus);
      avatarDiv.title = userName || userEmail;
      avatarDiv.textContent = (userName || simplifyEmail(userEmail)).charAt(0).toUpperCase();

      const contentDiv = document.createElement("div");
      contentDiv.className = "message-content";

      // Reply section if any
      if (replyTo) {
        const replyDiv = document.createElement("div");
        replyDiv.className = "message-reply";
        replyDiv.textContent = "‚Ü™ " + (replyTo.message || "Unknown message");
        contentDiv.appendChild(replyDiv);
      }

      // main message text
      const messageTextDiv = document.createElement("div");
      messageTextDiv.className = "message-text";
      messageTextDiv.textContent = message;
      contentDiv.appendChild(messageTextDiv);

      // footer: timestamp + reply button with icon
      const footerDiv = document.createElement("div");
      footerDiv.className = "message-footer";

      const timeSpan = document.createElement("span");
      timeSpan.className = "message-time";
      timeSpan.textContent = formatTimestamp(msgData.timestamp);
      footerDiv.appendChild(timeSpan);

      const replyBtn = document.createElement("button");
      replyBtn.className = "reply-btn";
      replyBtn.title = "Reply to message";
      replyBtn.innerHTML = `
        <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false"><path d="M10 9V5l-7 7 7 7v-4.1c4.55 0 7.72 1.95 9 5.1-1-5-4-10-9-10z"></path></svg>
      `;
      replyBtn.onclick = () => startReply(msgData);
      footerDiv.appendChild(replyBtn);

      contentDiv.appendChild(footerDiv);

      msgDiv.appendChild(avatarDiv);
      msgDiv.appendChild(contentDiv);

      chatContainer.appendChild(msgDiv);
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    // Start reply to a message
    function startReply(msg) {
      replyToMessageId = msg.id;
      replyToMessageText = msg.message;
      cancelReplyBtn.style.display = "inline-block";
      messageInput.placeholder = `Replying to: ${replyToMessageText.slice(0, 50)}...`;
      messageInput.focus();
    }

    // Cancel reply
    cancelReplyBtn.onclick = () => {
      replyToMessageId = null;
      replyToMessageText = null;
      cancelReplyBtn.style.display = "none";
      messageInput.placeholder = "Type a message...";
      messageInput.value = "";
      messageInput.focus();
    };

    // Dismiss no-song notification
    dismissSongBtn.onclick = () => {
      noSongNotification.style.display = "none";
    };

    // Send message handler
    async function sendMessage() {
      const text = messageInput.value.trim();
      if (!text) return;

      const msgObj = {
        userEmail: currentUser.email,
        userName: currentUser.displayName || simplifyEmail(currentUser.email),
        userStatus: "green",
        message: text,
        timestamp: serverTimestamp(),
      };

      if (replyToMessageId) {
        msgObj.replyTo = replyToMessageId;
      }

      try {
        await addDoc(collection(db, "messages"), msgObj);
        messageInput.value = "";
        cancelReplyBtn.style.display = "none";
        replyToMessageId = null;
        replyToMessageText = null;
      } catch (err) {
        alert("Error sending message: " + err.message);
      }
    }

    sendBtn.addEventListener("click", sendMessage);
    messageInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    // Setup message listener
    function setupMessagesListener() {
      const q = query(collection(db, "messages"), orderBy("timestamp", "asc"));
      onSnapshot(q, (snapshot) => {
        clearChat();
        snapshot.docs.forEach((docSnap) => {
          const data = docSnap.data();
          showMessage({ id: docSnap.id, ...data });
        });
      });
    }

    // Load groups (mock example)
    function loadGroups() {
      // Example groups - replace with Firestore groups collection in real app
      const groups = [
        { id: "1", name: "Friends", avatar: "https://i.pravatar.cc/54?img=1" },
        { id: "2", name: "Work", avatar: "https://i.pravatar.cc/54?img=2" },
        { id: "3", name: "Gaming", avatar: "https://i.pravatar.cc/54?img=3" },
      ];

      groupsList.innerHTML = "";
      groups.forEach(g => {
        const groupDiv = document.createElement("div");
        groupDiv.className = "group-item";
        groupDiv.title = g.name;

        const avatar = document.createElement("img");
        avatar.className = "group-avatar";
        avatar.src = g.avatar;
        avatar.alt = g.name;

        const name = document.createElement("span");
        name.className = "group-name";
        name.textContent = g.name;

        groupDiv.appendChild(avatar);
        groupDiv.appendChild(name);

        groupsList.appendChild(groupDiv);
      });
    }

    // Add create group button with icon
    function setupCreateGroupButton() {
      const btn = document.createElement("button");
      btn.className = "create-group-btn";
      btn.title = "Create New Group";
      btn.innerHTML = `
        <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
          <path d="M19 11h-6V5h-2v6H5v2h6v6h2v-6h6z"/>
        </svg>
      `;
      btn.onclick = () => {
        createGroupModal.style.display = "block";
        groupNameInput.focus();
      };
      groupsActions.appendChild(btn);
    }

    // Initialization
    onAuthStateChanged(auth, (user) => {
      if (user) {
        currentUser = user;
        setupMessagesListener();
        loadGroups();
        setupCreateGroupButton();
        noSongNotification.style.display = "flex"; // Example
      } else {
        window.location.href = "/login.html";
      }
    });

    // Create group modal logic
    createGroupCancel.onclick = () => {
      createGroupModal.style.display = "none";
      groupNameInput.value = "";
      groupImageInput.value = "";
    };

    createGroupConfirm.onclick = async () => {
      const groupName = groupNameInput.value.trim();
      if (!groupName) {
        alert("Group name cannot be empty");
        return;
      }
      // Add your logic to upload image and create group in Firestore here
      alert(`Group "${groupName}" created (mock)`);
      createGroupModal.style.display = "none";
      groupNameInput.value = "";
      groupImageInput.value = "";
      loadGroups();
    };
  </script>
</body>
</html>
