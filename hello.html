<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KAMBA Forum - General Chat</title>
  
  <!-- Favicon -->
  <link rel="icon" type="image/x-icon" href="favicon.ico" />

  <!-- Open Graph Meta Tags -->
  <meta property="og:title" content="KAMBA Forum - Connect & Share Ideas" />
  <meta property="og:description" content="Join KAMBA Forum to connect, share tech projects, and collaborate with people around Africa." />
  <meta property="og:image" content="https://i.ibb.co/TRXscBP/KAMBA-Logo-2.png" />
  <meta property="og:url" content="https://kamba-forum.com/" />
  <meta property="og:type" content="website" />

  <!-- Twitter Card Meta Tags -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="KAMBA Forum - Connect & Share Ideas" />
  <meta name="twitter:description" content="Join KAMBA Forum to connect, share tech projects, and collaborate with people around Africa." />
  <meta name="twitter:image" content="https://i.ibb.co/TRXscBP/KAMBA-Logo-2.png" />

  <style>
    /* [Keep all the existing CSS styles from your original code] */
  </style>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>

<!-- Welcome Modal -->
<div id="welcome-modal">
  <div id="welcome-modal-content">
    <h3>Welcome to KAMBA Forum!</h3>
    <p>By continuing, you agree to our Terms of Service and Privacy Policy. We'll set up your account with default settings.</p>
    <button id="agree-btn">Agree & Continue</button>
  </div>
</div>

<!-- Create Modal -->
<div id="create-modal">
  <div id="create-modal-content">
    <h3>Create Content</h3>
    
    <div class="create-tabs">
      <div class="create-tab active" data-tab="project">Project</div>
      <div class="create-tab" data-tab="post" id="post-tab-btn">Post</div>
      <div class="create-tab" data-tab="group" id="group-tab-btn">Group</div>
      <div class="create-tab" data-tab="community" id="community-tab-btn">Community</div>
    </div>
    
    <!-- Project Tab -->
    <div class="create-tab-content active" id="project-tab">
      <!-- [Keep all project form fields from original] -->
    </div>
    
    <!-- Post Tab -->
    <div class="create-tab-content" id="post-tab">
      <!-- [Keep all post form fields from original] -->
    </div>
    
    <!-- Group Tab -->
    <div class="create-tab-content" id="group-tab">
      <!-- [Keep all group form fields from original] -->
    </div>
    
    <!-- Community Tab -->
    <div class="create-tab-content" id="community-tab">
      <!-- [Keep all community form fields from original] -->
    </div>
  </div>
</div>

<header>
  <h1>KAMBA Forum</h1>
</header>

<div id="main-content">
  <!-- Left Sidebar -->
  <div id="left-sidebar">
    <div class="sidebar-item" id="home-btn">
      <div class="icon"><i class="fas fa-home"></i></div>
      <span>Home</span>
    </div>
    
    <div class="sidebar-item" id="profile-btn">
      <div class="icon"><i class="fas fa-user"></i></div>
      <span>Profile</span>
    </div>
    
    <div class="sidebar-item active" id="create-btn">
      <div class="icon"><i class="fas fa-plus"></i></div>
      <span>Create</span>
    </div>
    
    <div class="sidebar-item" id="notifications-btn">
      <div class="icon"><i class="fas fa-bell"></i></div>
      <span>Notifications</span>
    </div>
    
    <div class="sidebar-section">
      <div class="search-container">
        <input type="text" id="search-bar" placeholder="Search..." autocomplete="off" />
        <div id="search-results"></div>
      </div>
    </div>
    
    <div class="sidebar-section">
      <div class="sidebar-title">Channels</div>
      <div class="sidebar-item active" data-channel="general">
        <div class="dot"></div>
        <span>#General</span>
      </div>
      <div class="sidebar-item" onclick="window.location.href='announcements.html'">
        <div class="dot"></div>
        <span>#Announcements</span>
      </div>
      <div class="sidebar-item" onclick="window.location.href='communities.html'">
        <div class="dot"></div>
        <span>#Communities</span>
      </div>
      <div class="sidebar-item" onclick="window.location.href='posts.html'">
        <div class="dot"></div>
        <span>#Posts</span>
      </div>
      <div class="sidebar-item" onclick="window.location.href='projects.html'">
        <div class="dot"></div>
        <span>#Projects</span>
      </div>
    </div>
    
    <!-- User Profile Section -->
    <div id="user-profile">
      <div id="profile-pic"></div>
      <div id="profile-name"></div>
      <div id="profile-status">
        <div id="status-dot"></div>
        <span id="status-text"></span>
        <i class="fas fa-lightbulb" id="status-info-btn" style="margin-left: 5px; cursor: pointer;"></i>
      </div>
    </div>
  </div>
  
  <!-- Main Chat Area -->
  <div id="chat-area">
    <div id="chat-header">
      <div style="display: flex; align-items: center;">
        <i class="fas fa-hashtag"></i>
        <h2 id="channel-title">General</h2>
      </div>
      <div id="sparks-count">
        <i class="fas fa-clover"></i>
        <span id="sparks-value">0</span>
      </div>
    </div>
    
    <div id="messages-container"></div>
    
    <div id="message-input-area">
      <button id="upload-btn" title="Upload image"><i class="fas fa-image"></i></button>
      <input type="file" id="file-input" accept="image/*" multiple />
      <button id="emoji-btn" title="Emoji picker">ðŸ˜€</button>
      <textarea id="message-input" placeholder="Type a message..." autocomplete="off" rows="1"></textarea>
      <button id="send-btn">Send</button>
    </div>
  </div>

  <!-- Right Sidebar -->
  <div id="right-sidebar">
    <div class="right-sidebar-title">GROUPS</div>
  </div>
</div>

<!-- [Keep all other HTML elements from original] -->

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
  import {
    getAuth,
    signOut,
    onAuthStateChanged,
  } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
  import {
    getFirestore,
    collection,
    query,
    orderBy,
    where,
    onSnapshot,
    addDoc,
    doc,
    getDoc,
    updateDoc,
    deleteDoc,
    getDocs,
    increment,
    setDoc,
    arrayUnion,
    arrayRemove,
  } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
  import {
    getStorage,
    ref,
    uploadBytes,
    getDownloadURL,
  } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-storage.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCW2RJIku0JLJZTUu0YA9yKO8zjtX29fAo",
    authDomain: "muah-feed.firebaseapp.com",
    databaseURL: "https://muah-feed-default-rtdb.firebaseio.com",
    projectId: "muah-feed",
    storageBucket: "muah-feed.firebasestorage.app",
    messagingSenderId: "442314397706",
    appId: "1:442314397706:web:a69e3958257fb13b3667f3",
    measurementId: "G-S86S229F1T",
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const storage = getStorage(app);

  // [Keep all DOM elements from original]

  // App State
  let currentUser = null;
  let currentUserData = null;
  let currentChannel = "general";
  let likedMessages = new Set();

  // Initialize the app
  function init() {
    setupEventListeners();
    loadGroups();
    checkAuthState();
  }

  function setupEventListeners() {
    // [Keep all existing event listeners but modify create button to check permissions]
    
    createBtn.addEventListener("click", () => {
      // Check user permissions before showing create modal
      if (!currentUserData) return;
      
      const status = getUserStatus(currentUserData);
      
      // Enable/disable tabs based on user status
      document.getElementById('post-tab-btn').style.display = 
        (status === 'blue' || status === 'violet' || status === 'red') ? 'block' : 'none';
      document.getElementById('group-tab-btn').style.display = 
        (status === 'blue' || status === 'violet' || status === 'red') ? 'block' : 'none';
      document.getElementById('community-tab-btn').style.display = 
        (status === 'violet' || status === 'red') ? 'block' : 'none';
      
      createModal.style.display = "flex";
    });

    // [Keep all other existing event listeners]
  }

  // [Keep all helper functions from original]

  // Load messages for general channel
  function loadChannelMessages() {
    messagesContainer.innerHTML = "";
    
    const messagesQuery = query(
      collection(db, "Kamba_messages"),
      where("isAnnouncement", "==", false),
      where("isPost", "==", false),
      orderBy("timestamp", "asc")
    );
    
    setupMessagesListener(messagesQuery);
  }

  // [Keep all other functions from original but modify like handling]
  async function likeMessage(messageId, senderUid) {
    if (likedMessages.has(messageId)) return;
    
    try {
      likedMessages.add(messageId);
      
      // Update sender's sparks (+1 for general messages)
      const senderRef = doc(db, "Kamba_users", senderUid);
      await updateDoc(senderRef, {
        sparks: increment(1)
      });
      
      loadChannelMessages();
    } catch (error) {
      console.error("Error liking message:", error);
    }
  }

  // [Keep all other existing code]
  
  init();
</script>
</body>
</html>
