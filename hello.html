<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>KAMBA Forum - Chat</title>
<style>
  /* Basic reset and Discord style */
  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
    font-family: 'Poppins', sans-serif;
  }
  body, html {
    height: 100%;
    background-color: #36393f;
    color: #dcddde;
    display: flex;
    flex-direction: column;
  }
  @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
  @import url('https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500&display=swap');
  
  header {
    background-color: #2f3136;
    padding: 1rem 2rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    color: white;
    border-bottom: 1px solid #202225;
  }
  header h1 {
    margin: 0;
    font-size: 1.5rem;
  }
  #main-content {
    display: flex;
    flex: 1;
    overflow: hidden;
  }
  
  /* Left sidebar */
  #left-sidebar {
    width: 250px;
    background-color: #2f3136;
    border-right: 1px solid #202225;
    padding: 1rem;
    display: flex;
    flex-direction: column;
    overflow-y: auto;
  }
  .sidebar-section {
    margin-bottom: 1.5rem;
  }
  .sidebar-title {
    color: #b9bbbe;
    font-size: 0.8rem;
    text-transform: uppercase;
    margin-bottom: 0.5rem;
    padding-left: 0.5rem;
  }
  .sidebar-item {
    display: flex;
    align-items: center;
    padding: 0.5rem;
    border-radius: 4px;
    cursor: pointer;
    margin-bottom: 0.3rem;
    transition: background-color 0.2s;
  }
  .sidebar-item:hover {
    background-color: #3a3d44;
  }
  .sidebar-item.active {
    background-color: #40444b;
  }
  .sidebar-item .dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    margin-right: 0.8rem;
    background-color: #b9bbbe;
  }
  .sidebar-item.active .dot {
    background-color: #5865f2;
  }
  .sidebar-item .icon {
    margin-right: 0.8rem;
    font-size: 1.1rem;
    width: 20px;
    text-align: center;
  }
  #search-bar {
    width: 100%;
    padding: 0.5rem;
    border-radius: 4px;
    border: none;
    background-color: #202225;
    color: white;
    margin-bottom: 1rem;
  }
  #search-bar:focus {
    outline: 2px solid #5865f2;
  }
  #search-results {
    position: absolute;
    top: 100%;
    left: 0;
    width: 100%;
    background-color: #2f3136;
    border-radius: 4px;
    box-shadow: 0 0 10px rgba(0,0,0,0.5);
    z-index: 100;
    max-height: 300px;
    overflow-y: auto;
    display: none;
  }
  .search-result-item {
    padding: 0.8rem;
    border-bottom: 1px solid #40444b;
    cursor: pointer;
  }
  .search-result-item:hover {
    background-color: #3a3d44;
  }
  .search-result-type {
    font-size: 0.7rem;
    color: #b9bbbe;
    margin-top: 0.2rem;
  }
  .search-container {
    position: relative;
    margin-bottom: 1.5rem;
  }
  
  /* User profile section */
  #user-profile {
    margin-top: auto;
    padding: 1rem;
    background-color: #292b2f;
    border-radius: 8px;
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  #profile-pic {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background-color: #5865f2;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 1.5rem;
    font-weight: bold;
    color: white;
    margin-bottom: 0.5rem;
    background-size: cover;
    background-position: center;
  }
  #profile-name {
    font-weight: 600;
    margin-bottom: 0.3rem;
  }
  #profile-status {
    display: flex;
    align-items: center;
    font-size: 0.8rem;
    color: #b9bbbe;
  }
  #status-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    margin-right: 0.5rem;
  }
  #status-info {
    position: absolute;
    bottom: 100px;
    left: 20px;
    background-color: #202225;
    padding: 1rem;
    border-radius: 8px;
    box-shadow: 0 0 10px rgba(0,0,0,0.7);
    z-index: 100;
    display: none;
    width: 200px;
  }
  #status-info h4 {
    margin-bottom: 0.5rem;
  }
  .status-level {
    display: flex;
    align-items: center;
    margin-bottom: 0.3rem;
  }
  .status-level-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    margin-right: 0.5rem;
  }
  
  /* Chat area */
  #chat-area {
    flex: 1;
    display: flex;
    flex-direction: column;
    height: 100%;
    background-color: #36393f;
  }
  #chat-header {
    padding: 1rem;
    border-bottom: 1px solid #202225;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  #chat-header h2 {
    font-size: 1.2rem;
    margin-left: 0.5rem;
  }
  #sparks-count {
    display: flex;
    align-items: center;
    font-size: 0.9rem;
    background-color: #2f3136;
    padding: 0.3rem 0.8rem;
    border-radius: 20px;
    color: #faa61a;
  }
  #sparks-count i {
    color: #faa61a;
    margin-right: 0.3rem;
  }
  #messages-container {
    flex: 1;
    padding: 1rem;
    overflow-y: auto;
  }
  .message {
    background-color: #2f3136;
    padding: 1rem;
    border-radius: 8px;
    margin-bottom: 1rem;
    position: relative;
    max-width: 80%;
    word-break: break-word;
  }
  .message:hover {
    background-color: #34373c;
  }
  .message-header {
    display: flex;
    align-items: center;
    margin-bottom: 0.5rem;
  }
  .username {
    font-weight: 700;
    cursor: default;
  }
  .message-time {
    font-size: 0.7rem;
    color: #b9bbbe;
    margin-left: 0.8rem;
  }
  .message-text {
    white-space: pre-wrap;
    margin-bottom: 0.5rem;
  }
  .message-actions {
    display: flex;
    gap: 1rem;
    margin-top: 0.5rem;
  }
  .message-action {
    font-size: 0.8rem;
    color: #b9bbbe;
    cursor: pointer;
  }
  .message-action:hover {
    color: white;
    text-decoration: underline;
  }
  .reply-to {
    font-size: 0.75rem;
    color: #b9bbbe;
    margin-bottom: 0.5rem;
    padding-left: 0.5rem;
    border-left: 2px solid #5865f2;
  }
  .mention {
    color: #5865f2;
    font-weight: bold;
  }
  .announcement-badge, .post-badge {
    font-size: 0.7rem;
    padding: 0.2rem 0.4rem;
    border-radius: 4px;
    margin-left: 0.5rem;
  }
  .announcement-badge {
    background-color: #f04747;
    color: white;
  }
  .post-badge {
    background-color: #43b581;
    color: white;
  }
  
  /* Right sidebar */
  #right-sidebar {
    width: 80px;
    background-color: #2f3136;
    border-left: 1px solid #202225;
    padding: 1rem 0.5rem;
    overflow-y: auto;
    transition: width 0.3s ease;
    resize: horizontal;
    min-width: 80px;
    max-width: 300px;
  }
  #right-sidebar:hover {
    width: 200px;
  }
  #right-sidebar.expanded {
    width: 200px;
  }
  .right-sidebar-title {
    color: #b9bbbe;
    font-size: 0.8rem;
    text-transform: uppercase;
    margin-bottom: 1rem;
    padding-left: 0.5rem;
    display: none;
  }
  #right-sidebar:hover .right-sidebar-title,
  #right-sidebar.expanded .right-sidebar-title {
    display: block;
  }
  .group-item {
    display: flex;
    align-items: center;
    margin-bottom: 1rem;
    cursor: pointer;
    padding: 0.3rem;
    border-radius: 4px;
  }
  .group-item:hover {
    background-color: #3a3d44;
  }
  .group-avatar {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    object-fit: cover;
    margin-right: 0;
  }
  #right-sidebar:hover .group-avatar,
  #right-sidebar.expanded .group-avatar {
    margin-right: 10px;
  }
  .group-name {
    display: none;
    font-size: 0.9rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  #right-sidebar:hover .group-name,
  #right-sidebar.expanded .group-name {
    display: block;
  }
  
  /* Message input area */
  #message-input-area {
    background-color: #40444b;
    padding: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  #message-input {
    flex: 1;
    padding: 0.8rem;
    border-radius: 5px;
    border: none;
    font-size: 1rem;
    color: white;
    background-color: #2f3136;
    resize: none;
    height: auto;
    min-height: 40px;
    max-height: 150px;
  }
  #message-input:focus {
    outline: 2px solid #5865f2;
  }
  #send-btn {
    background-color: #5865f2;
    border: none;
    color: white;
    padding: 0.55rem 1.2rem;
    font-weight: 700;
    border-radius: 5px;
    cursor: pointer;
    transition: background-color 0.2s ease;
  }
  #send-btn:hover {
    background-color: #4752c4;
  }
  #emoji-btn {
    background: transparent;
    border: none;
    font-size: 1.4rem;
    cursor: pointer;
    color: #b9bbbe;
    user-select: none;
  }
  #emoji-picker {
    position: absolute;
    bottom: 5rem;
    right: 2rem;
    background-color: #202225;
    border-radius: 8px;
    padding: 0.5rem;
    display: none;
    box-shadow: 0 0 10px rgba(0,0,0,0.7);
    z-index: 1000;
  }
  #emoji-picker span {
    font-size: 1.6rem;
    margin: 0 6px;
    cursor: pointer;
    user-select: none;
    transition: transform 0.15s ease;
  }
  #emoji-picker span:hover {
    transform: scale(1.3);
  }
  
  /* Image in messages */
  .message-image {
    max-width: 100%;
    max-height: 300px;
    border-radius: 4px;
    margin-top: 0.5rem;
    cursor: pointer;
    transition: transform 0.2s;
  }
  .message-image:hover {
    transform: scale(1.02);
  }
  .image-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.9);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 10000;
  }
  .full-image {
    max-width: 90%;
    max-height: 90%;
  }
  .close-image {
    position: absolute;
    top: 20px;
    right: 20px;
    color: white;
    font-size: 2rem;
    cursor: pointer;
  }
  .download-image {
    position: absolute;
    top: 20px;
    right: 70px;
    color: white;
    font-size: 1.5rem;
    cursor: pointer;
  }
  
  /* File upload button */
  #file-input {
    display: none;
  }
  #upload-btn {
    background: transparent;
    border: none;
    font-size: 1.4rem;
    cursor: pointer;
    color: #b9bbbe;
    user-select: none;
  }
  
  /* Status colors */
  .username.green { color: #43b581; }
  .username.blue { color: #5865f2; }
  .username.violet { color: #9b59b6; }
  .username.red { color: #f04747; }
  
  .status-dot.green { background-color: #43b581; }
  .status-dot.blue { background-color: #5865f2; }
  .status-dot.violet { background-color: #9b59b6; }
  .status-dot.red { background-color: #f04747; }
  
  /* Scrollbar styling */
  ::-webkit-scrollbar {
    width: 8px;
  }
  ::-webkit-scrollbar-thumb {
    background-color: #5865f2;
    border-radius: 5px;
  }
  
  /* No song notification */
  #no-song-notification {
    background-color: #f04747;
    color: white;
    text-align: center;
    padding: 0.7rem 1rem;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .dismiss-btn {
    background: rgba(255,255,255,0.2);
    border: none;
    color: white;
    padding: 0.3rem 0.6rem;
    border-radius: 4px;
    cursor: pointer;
  }
  
  /* Edit message modal */
  .modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.7);
    z-index: 1000;
    justify-content: center;
    align-items: center;
  }
  .modal-content {
    background-color: #2f3136;
    padding: 1.5rem;
    border-radius: 8px;
    width: 80%;
    max-width: 500px;
  }
  .modal-title {
    margin-bottom: 1rem;
  }
  .modal-input {
    width: 100%;
    padding: 0.8rem;
    margin-bottom: 1rem;
    border-radius: 4px;
    border: none;
    background-color: #40444b;
    color: white;
  }
  .modal-buttons {
    display: flex;
    justify-content: flex-end;
    gap: 0.5rem;
  }
  .modal-btn {
    padding: 0.5rem 1rem;
    border-radius: 4px;
    border: none;
    cursor: pointer;
  }
  .modal-btn.cancel {
    background-color: #72767d;
    color: white;
  }
  .modal-btn.save {
    background-color: #5865f2;
    color: white;
  }

  /* Welcome modal */
  #welcome-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.7);
    z-index: 10000;
    justify-content: center;
    align-items: center;
  }
  #welcome-modal-content {
    background-color: #2f3136;
    padding: 2rem;
    border-radius: 8px;
    width: 90%;
    max-width: 400px;
    text-align: center;
  }
  #welcome-modal h3 {
    margin-bottom: 1rem;
    color: white;
  }
  #welcome-modal p {
    color: #b9bbbe;
    margin-bottom: 1.5rem;
    line-height: 1.5;
  }
  #agree-btn {
    background-color: #5865f2;
    color: white;
    border: none;
    padding: 0.7rem 1.5rem;
    border-radius: 4px;
    font-weight: bold;
    cursor: pointer;
    font-size: 1rem;
  }
  #agree-btn:hover {
    background-color: #4752c4;
  }

  /* Create modal */
  #create-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.7);
    z-index: 1000;
    justify-content: center;
    align-items: center;
    overflow-y: auto;
  }
  #create-modal-content {
    background-color: #2f3136;
    padding: 2rem;
    border-radius: 8px;
    width: 90%;
    max-width: 800px;
    max-height: 90vh;
    overflow-y: auto;
  }
  #create-modal h3 {
    margin-bottom: 1.5rem;
    color: white;
    text-align: center;
  }
  .create-tabs {
    display: flex;
    margin-bottom: 1.5rem;
    border-bottom: 1px solid #40444b;
  }
  .create-tab {
    padding: 0.7rem 1.5rem;
    cursor: pointer;
    border-bottom: 2px solid transparent;
  }
  .create-tab.active {
    border-bottom: 2px solid #5865f2;
    color: white;
    font-weight: bold;
  }
  .create-tab-content {
    display: none;
  }
  .create-tab-content.active {
    display: block;
  }
  .form-row {
    margin-bottom: 1.2rem;
  }
  .form-row label {
    display: block;
    margin-bottom: 0.5rem;
    color: #b9bbbe;
  }
  .form-row input[type="text"],
  .form-row input[type="url"],
  .form-row textarea,
  .form-row select {
    width: 100%;
    padding: 0.7rem;
    border-radius: 4px;
    border: none;
    background-color: #40444b;
    color: white;
  }
  .form-row textarea {
    min-height: 100px;
    resize: vertical;
  }
  .required-field::after {
    content: " *";
    color: #f04747;
  }
  .code-snippet {
    margin-bottom: 1rem;
    border: 1px solid #40444b;
    border-radius: 4px;
    overflow: hidden;
  }
  .code-header {
    background-color: #40444b;
    padding: 0.5rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .code-language {
    font-family: 'Fira Code', monospace;
    font-size: 0.8rem;
  }
  .remove-code {
    color: #f04747;
    cursor: pointer;
  }
  .code-content {
    font-family: 'Fira Code', monospace;
    padding: 0.8rem;
    background-color: #2f3136;
    white-space: pre-wrap;
    overflow-x: auto;
  }
  .add-code-btn {
    background-color: #5865f2;
    color: white;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 4px;
    cursor: pointer;
    margin-bottom: 1rem;
  }
  .add-code-btn:hover {
    background-color: #4752c4;
  }
  .add-rule-btn {
    background-color: #43b581;
    color: white;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 4px;
    cursor: pointer;
    margin-bottom: 1rem;
  }
  .add-rule-btn:hover {
    background-color: #3a9e70;
  }
  .rule-item {
    background-color: #40444b;
    padding: 0.8rem;
    border-radius: 4px;
    margin-bottom: 0.5rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .remove-rule {
    color: #f04747;
    cursor: pointer;
  }
  .create-actions {
    display: flex;
    justify-content: flex-end;
    margin-top: 1.5rem;
    gap: 1rem;
  }
  .create-btn {
    padding: 0.7rem 1.5rem;
    border-radius: 4px;
    border: none;
    cursor: pointer;
    font-weight: bold;
  }
  .create-btn.cancel {
    background-color: #72767d;
    color: white;
  }
  .create-btn.submit {
    background-color: #5865f2;
    color: white;
  }
  .font-style-controls {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 0.5rem;
  }
  .font-style-btn {
    background-color: #40444b;
    color: white;
    border: none;
    padding: 0.3rem 0.6rem;
    border-radius: 4px;
    cursor: pointer;
  }
  .font-style-btn.active {
    background-color: #5865f2;
  }
  .font-family-select {
    margin-bottom: 0.5rem;
  }
  .preview-area {
    border: 1px solid #40444b;
    border-radius: 4px;
    padding: 1rem;
    min-height: 100px;
    background-color: #2f3136;
    margin-bottom: 1rem;
  }
  .collaborator-input {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 0.5rem;
  }
  .collaborator-input input {
    flex: 1;
  }
  .collaborator-list {
    margin-bottom: 1rem;
  }
  .collaborator-item {
    background-color: #40444b;
    padding: 0.5rem;
    border-radius: 4px;
    margin-bottom: 0.3rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .remove-collaborator {
    color: #f04747;
    cursor: pointer;
  }
  .music-preview {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-top: 0.5rem;
  }
  .music-preview-btn {
    background-color: #40444b;
    color: white;
    border: none;
    width: 30px;
    height: 30px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
  }
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>

<!-- Welcome Modal -->
<div id="welcome-modal">
  <div id="welcome-modal-content">
    <h3>Welcome to KAMBA Forum!</h3>
    <p>By continuing, you agree to our Terms of Service and Privacy Policy. We'll set up your account with default settings.</p>
    <button id="agree-btn">Agree & Continue</button>
  </div>
</div>

<!-- Create Modal -->
<div id="create-modal">
  <div id="create-modal-content">
    <h3>Create Content</h3>
    
    <div class="create-tabs">
      <div class="create-tab active" data-tab="project">Project</div>
      <div class="create-tab" data-tab="post">Post</div>
      <div class="create-tab" data-tab="group">Group</div>
      <div class="create-tab" data-tab="community">Community</div>
    </div>
    
    <!-- Project Tab -->
    <div class="create-tab-content active" id="project-tab">
      <div class="form-row">
        <label class="required-field">Project Name</label>
        <input type="text" id="project-name" placeholder="Enter project name">
      </div>
      
      <div class="form-row">
        <label class="required-field">Short Description</label>
        <input type="text" id="project-description" placeholder="Brief description of your project">
      </div>
      
      <div class="form-row">
        <label class="required-field">Project Banner URL</label>
        <input type="url" id="project-banner" placeholder="Enter image URL for your project banner">
      </div>
      
      <div class="form-row">
        <label class="required-field">Project Overview</label>
        <textarea id="project-overview" placeholder="Detailed overview of your project (you can add images with Markdown)"></textarea>
      </div>
      
      <div class="form-row">
        <label>Steps Taken</label>
        <textarea id="project-steps" placeholder="Describe the steps you took to complete the project"></textarea>
      </div>
      
      <div class="form-row">
        <label>Code Snippets</label>
        <button class="add-code-btn" id="add-code-btn">Add Code Snippet</button>
        <div id="code-snippets-container"></div>
      </div>
      
      <div class="form-row">
        <label class="required-field">Main Importance</label>
        <textarea id="project-importance" placeholder="Why is this project important?"></textarea>
      </div>
      
      <div class="form-row">
        <label class="required-field">Profitability</label>
        <textarea id="project-profitability" placeholder="How can this project be profitable?"></textarea>
      </div>
      
      <div class="form-row">
        <label class="required-field">Obstacles/Risks</label>
        <textarea id="project-obstacles" placeholder="What challenges did you face or might others face?"></textarea>
      </div>
      
      <div class="create-actions">
        <button class="create-btn cancel" id="cancel-project">Cancel</button>
        <button class="create-btn submit" id="submit-project">Create Project</button>
      </div>
    </div>
    
    <!-- Post Tab -->
    <div class="create-tab-content" id="post-tab">
      <div class="form-row">
        <label>Font Family</label>
        <select class="font-family-select" id="post-font">
          <option value="Poppins">Poppins</option>
          <option value="Arial">Arial</option>
          <option value="Georgia">Georgia</option>
        </select>
      </div>
      
      <div class="form-row">
        <label>Font Style</label>
        <div class="font-style-controls">
          <button class="font-style-btn" id="bold-btn" title="Bold"><i class="fas fa-bold"></i></button>
          <button class="font-style-btn" id="italic-btn" title="Italic"><i class="fas fa-italic"></i></button>
          <button class="font-style-btn" id="underline-btn" title="Underline"><i class="fas fa-underline"></i></button>
        </div>
      </div>
      
      <div class="form-row">
        <label class="required-field">Post Content</label>
        <textarea id="post-content" placeholder="Write your post here"></textarea>
      </div>
      
      <div class="form-row">
        <label>Preview</label>
        <div class="preview-area" id="post-preview"></div>
      </div>
      
      <div class="create-actions">
        <button class="create-btn cancel" id="cancel-post">Cancel</button>
        <button class="create-btn submit" id="submit-post">Create Post</button>
      </div>
    </div>
    
    <!-- Group Tab -->
    <div class="create-tab-content" id="group-tab">
      <div class="form-row">
        <label class="required-field">Group Name</label>
        <input type="text" id="group-name" placeholder="Enter group name">
      </div>
      
      <div class="form-row">
        <label class="required-field">Group Image URL</label>
        <input type="url" id="group-image" placeholder="Enter image URL for your group">
      </div>
      
      <div class="form-row">
        <label>Group Banner URL</label>
        <input type="url" id="group-banner" placeholder="Enter banner URL for your group">
      </div>
      
      <div class="form-row">
        <label class="required-field">Description</label>
        <textarea id="group-description" placeholder="Describe your group"></textarea>
      </div>
      
      <div class="form-row">
        <label>Rules</label>
        <button class="add-rule-btn" id="add-rule-btn">Add Rule</button>
        <div id="rules-container"></div>
      </div>
      
      <div class="create-actions">
        <button class="create-btn cancel" id="cancel-group">Cancel</button>
        <button class="create-btn submit" id="submit-group">Create Group</button>
      </div>
    </div>
    
    <!-- Community Tab -->
    <div class="create-tab-content" id="community-tab">
      <div class="form-row">
        <label class="required-field">Community Name</label>
        <input type="text" id="community-name" placeholder="Enter community name">
      </div>
      
      <div class="form-row">
        <label class="required-field">Community Image URL</label>
        <input type="url" id="community-image" placeholder="Enter image URL for your community">
      </div>
      
      <div class="form-row">
        <label>Community Banner URL</label>
        <input type="url" id="community-banner" placeholder="Enter banner URL for your community">
      </div>
      
      <div class="form-row">
        <label class="required-field">Description</label>
        <textarea id="community-description" placeholder="Describe your community"></textarea>
      </div>
      
      <div class="form-row">
        <label>Collaborators (Community Leaders)</label>
        <div class="collaborator-input">
          <input type="text" id="collaborator-email" placeholder="Enter collaborator email">
          <button id="add-collaborator-btn">Add</button>
        </div>
        <div class="collaborator-list" id="collaborators-list"></div>
      </div>
      
      <div class="create-actions">
        <button class="create-btn cancel" id="cancel-community">Cancel</button>
        <button class="create-btn submit" id="submit-community">Create Community</button>
      </div>
    </div>
  </div>
</div>

<header>
  <h1>KAMBA Forum</h1>
</header>

<div id="main-content">
  <!-- Left Sidebar -->
  <div id="left-sidebar">
    <div class="sidebar-item" id="home-btn">
      <div class="icon"><i class="fas fa-home"></i></div>
      <span>Home</span>
    </div>
    
    <div class="sidebar-item" id="profile-btn">
      <div class="icon"><i class="fas fa-user"></i></div>
      <span>Profile</span>
    </div>
    
    <div class="sidebar-item active" id="create-btn">
      <div class="icon"><i class="fas fa-plus"></i></div>
      <span>Create</span>
    </div>
    
    <div class="sidebar-item" id="notifications-btn">
      <div class="icon"><i class="fas fa-bell"></i></div>
      <span>Notifications</span>
    </div>
    
    <div class="sidebar-section">
      <div class="search-container">
        <input type="text" id="search-bar" placeholder="Search..." autocomplete="off" />
        <div id="search-results"></div>
      </div>
    </div>
    
    <div class="sidebar-section">
      <div class="sidebar-title">Channels</div>
      <div class="sidebar-item active" data-channel="general">
        <div class="dot"></div>
        <span>#General</span>
      </div>
      <div class="sidebar-item" data-channel="announcements">
        <div class="dot"></div>
        <span>#Announcements</span>
      </div>
      <div class="sidebar-item" data-channel="communities">
        <div class="dot"></div>
        <span>#Communities</span>
      </div>
      <div class="sidebar-item" data-channel="posts">
        <div class="dot"></div>
        <span>#Posts</span>
      </div>
      <div class="sidebar-item" data-channel="projects">
        <div class="dot"></div>
        <span>#Projects</span>
      </div>
      <div class="sidebar-item" data-channel="mentions">
        <div class="dot"></div>
        <span>#Mentions</span>
      </div>
    </div>
    
    <!-- User Profile Section -->
    <div id="user-profile">
      <div id="profile-pic"></div>
      <div id="profile-name"></div>
      <div id="profile-status">
        <div id="status-dot"></div>
        <span id="status-text"></span>
        <i class="fas fa-lightbulb" id="status-info-btn" style="margin-left: 5px; cursor: pointer;"></i>
      </div>
    </div>
    
    <!-- Status Info Tooltip -->
    <div id="status-info">
      <h4>Account Status</h4>
      <div class="status-level">
        <div class="status-level-dot green"></div>
        <span>Green: 0-99 Sparks</span>
      </div>
      <div class="status-level">
        <div class="status-level-dot blue"></div>
        <span>Blue: 100-999 Sparks</span>
      </div>
      <div class="status-level">
        <div class="status-level-dot violet"></div>
        <span>Violet: 1000+ Sparks</span>
      </div>
      <div class="status-level">
        <div class="status-level-dot red"></div>
        <span>Red: Admin (special)</span>
      </div>
    </div>
  </div>
  
  <!-- Main Chat Area -->
  <div id="chat-area">
    <div id="chat-header">
      <div style="display: flex; align-items: center;">
        <i class="fas fa-hashtag"></i>
        <h2 id="channel-title">General</h2>
      </div>
      <div id="sparks-count">
        <i class="fas fa-clover"></i>
        <span id="sparks-value">0</span>
      </div>
    </div>
    
    <div id="messages-container"></div>
    
    <div id="no-song-notification" style="display:none;">
      <span>No song set. Click here to set your song in Settings.</span>
      <button class="dismiss-btn">Dismiss</button>
    </div>

    <div id="message-input-area">
      <button id="upload-btn" title="Upload image"><i class="fas fa-image"></i></button>
      <input type="file" id="file-input" accept="image/*" multiple />
      <button id="emoji-btn" title="Emoji picker">😀</button>
      <textarea id="message-input" placeholder="Type a message..." autocomplete="off" rows="1"></textarea>
      <button id="send-btn">Send</button>
    </div>
  </div>

  <!-- Right Sidebar -->
  <div id="right-sidebar">
    <div class="right-sidebar-title">GROUPS</div>
    <!-- Groups will be added dynamically -->
  </div>
</div>

<!-- Emoji Picker -->
<div id="emoji-picker" aria-label="Emoji picker" role="list">
  <span>😀</span>
  <span>😂</span>
  <span>😎</span>
  <span>❤️</span>
  <span>🔥</span>
  <span>👍</span>
  <span>👎</span>
  <span>🎉</span>
  <span>🤔</span>
  <span>😢</span>
</div>

<!-- Background Audio -->
<audio id="background-audio" loop></audio>

<!-- Edit Message Modal -->
<div id="edit-message-modal" class="modal">
  <div class="modal-content">
    <h3 class="modal-title">Edit Message</h3>
    <textarea id="edit-message-input" class="modal-input" rows="4"></textarea>
    <div class="modal-buttons">
      <button class="modal-btn cancel" id="cancel-edit-btn">Cancel</button>
      <button class="modal-btn save" id="save-edit-btn">Save</button>
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
  import {
    getAuth,
    signOut,
    onAuthStateChanged,
  } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
  import {
    getFirestore,
    collection,
    query,
    orderBy,
    where,
    onSnapshot,
    addDoc,
    doc,
    getDoc,
    updateDoc,
    deleteDoc,
    getDocs,
    increment,
    setDoc,
    arrayUnion,
    arrayRemove,
  } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
  import {
    getStorage,
    ref,
    uploadBytes,
    getDownloadURL,
  } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-storage.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCW2RJIku0JLJZTUu0YA9yKO8zjtX29fAo",
    authDomain: "muah-feed.firebaseapp.com",
    databaseURL: "https://muah-feed-default-rtdb.firebaseio.com",
    projectId: "muah-feed",
    storageBucket: "muah-feed.firebasestorage.app",
    messagingSenderId: "442314397706",
    appId: "1:442314397706:web:a69e3958257fb13b3667f3",
    measurementId: "G-S86S229F1T",
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const storage = getStorage(app);

  // DOM Elements
  const messagesContainer = document.getElementById("messages-container");
  const messageInput = document.getElementById("message-input");
  const sendBtn = document.getElementById("send-btn");
  const emojiBtn = document.getElementById("emoji-btn");
  const emojiPicker = document.getElementById("emoji-picker");
  const noSongNotification = document.getElementById("no-song-notification");
  const dismissBtn = noSongNotification.querySelector(".dismiss-btn");
  const backgroundAudio = document.getElementById("background-audio");
  const rightSidebar = document.getElementById("right-sidebar");
  const uploadBtn = document.getElementById("upload-btn");
  const fileInput = document.getElementById("file-input");
  const searchBar = document.getElementById("search-bar");
  const searchResults = document.getElementById("search-results");
  const channelItems = document.querySelectorAll(".sidebar-item[data-channel]");
  const homeBtn = document.getElementById("home-btn");
  const profileBtn = document.getElementById("profile-btn");
  const createBtn = document.getElementById("create-btn");
  const notificationsBtn = document.getElementById("notifications-btn");
  const channelTitle = document.getElementById("channel-title");
  const editMessageModal = document.getElementById("edit-message-modal");
  const editMessageInput = document.getElementById("edit-message-input");
  const cancelEditBtn = document.getElementById("cancel-edit-btn");
  const saveEditBtn = document.getElementById("save-edit-btn");
  const profilePic = document.getElementById("profile-pic");
  const profileName = document.getElementById("profile-name");
  const statusDot = document.getElementById("status-dot");
  const statusText = document.getElementById("status-text");
  const statusInfoBtn = document.getElementById("status-info-btn");
  const statusInfo = document.getElementById("status-info");
  const sparksValue = document.getElementById("sparks-value");
  const welcomeModal = document.getElementById("welcome-modal");
  const agreeBtn = document.getElementById("agree-btn");
  const createModal = document.getElementById("create-modal");
  const createTabs = document.querySelectorAll(".create-tab");
  const createTabContents = document.querySelectorAll(".create-tab-content");
  const addCodeBtn = document.getElementById("add-code-btn");
  const codeSnippetsContainer = document.getElementById("code-snippets-container");
  const addRuleBtn = document.getElementById("add-rule-btn");
  const rulesContainer = document.getElementById("rules-container");
  const addCollaboratorBtn = document.getElementById("add-collaborator-btn");
  const collaboratorEmailInput = document.getElementById("collaborator-email");
  const collaboratorsList = document.getElementById("collaborators-list");
  const boldBtn = document.getElementById("bold-btn");
  const italicBtn = document.getElementById("italic-btn");
  const underlineBtn = document.getElementById("underline-btn");
  const postContent = document.getElementById("post-content");
  const postPreview = document.getElementById("post-preview");
  const postFontSelect = document.getElementById("post-font");
  const cancelProjectBtn = document.getElementById("cancel-project");
  const submitProjectBtn = document.getElementById("submit-project");
  const cancelPostBtn = document.getElementById("cancel-post");
  const submitPostBtn = document.getElementById("submit-post");
  const cancelGroupBtn = document.getElementById("cancel-group");
  const submitGroupBtn = document.getElementById("submit-group");
  const cancelCommunityBtn = document.getElementById("cancel-community");
  const submitCommunityBtn = document.getElementById("submit-community");

  // App State
  let currentUser = null;
  let currentUserData = null;
  let replyToMessageId = null;
  let replyToMessageText = null;
  let currentChannel = "general";
  let messageBeingEdited = null;
  let searchTimeout = null;
  let likedMessages = new Set();
  let likedPosts = new Set();
  let likedProjects = new Set();
  let hasInteracted = false;
  let currentActiveTab = "project";
  let collaborators = [];

  // Initialize the app
  function init() {
    setupEventListeners();
    loadGroups();
    checkSongNotificationDismissed();
    checkAuthState();
  }

  // Set up all event listeners
  function setupEventListeners() {
    // Agree button for welcome modal
    agreeBtn.addEventListener("click", async () => {
      try {
        // Create user document with default values
        await setDoc(doc(db, "Kamba_users", currentUser.uid), {
          email: currentUser.email,
          phone: "",
          status: "green",
          sparks: 0,
          song: "",
          volume: 0.5,
          createdAt: new Date(),
          profilePic: "",
          notifications: [],
          groups: [],
          communities: [],
          projects: []
        });
        
        // Hide welcome modal
        welcomeModal.style.display = "none";
        
        // Reload user data
        const userDocSnap = await getDoc(doc(db, "Kamba_users", currentUser.uid));
        currentUserData = userDocSnap.data();
        updateUserProfile(currentUserData);
        setupUserEnvironment();
      } catch (error) {
        console.error("Error setting up user:", error);
        alert("Error setting up your account. Please try again.");
      }
    });

    // Navigation buttons
    homeBtn.addEventListener("click", () => {
      window.location.href = "hello.html";
    });
    
    profileBtn.addEventListener("click", () => {
      window.location.href = "settings.html";
    });
    
    createBtn.addEventListener("click", () => {
      createModal.style.display = "flex";
    });
    
    notificationsBtn.addEventListener("click", () => {
      alert("Notifications feature will be implemented in the next update");
      // In a real app, this would show notifications panel
    });

    // Create modal tabs
    createTabs.forEach(tab => {
      tab.addEventListener("click", () => {
        createTabs.forEach(t => t.classList.remove("active"));
        tab.classList.add("active");
        currentActiveTab = tab.dataset.tab;
        
        createTabContents.forEach(content => {
          content.classList.remove("active");
          if (content.id === `${currentActiveTab}-tab`) {
            content.classList.add("active");
          }
        });
      });
    });

    // Code snippet handling
    addCodeBtn.addEventListener("click", addCodeSnippet);

    // Rule handling
    addRuleBtn.addEventListener("click", addRuleInput);

    // Collaborator handling
    addCollaboratorBtn.addEventListener("click", addCollaborator);

    // Post formatting
    boldBtn.addEventListener("click", () => {
      boldBtn.classList.toggle("active");
      updatePostPreview();
    });
    
    italicBtn.addEventListener("click", () => {
      italicBtn.classList.toggle("active");
      updatePostPreview();
    });
    
    underlineBtn.addEventListener("click", () => {
      underlineBtn.classList.toggle("active");
      updatePostPreview();
    });
    
    postFontSelect.addEventListener("change", updatePostPreview);
    postContent.addEventListener("input", updatePostPreview);

    // Create form cancel buttons
    cancelProjectBtn.addEventListener("click", () => {
      createModal.style.display = "none";
      resetCreateForms();
    });
    
    cancelPostBtn.addEventListener("click", () => {
      createModal.style.display = "none";
      resetCreateForms();
    });
    
    cancelGroupBtn.addEventListener("click", () => {
      createModal.style.display = "none";
      resetCreateForms();
    });
    
    cancelCommunityBtn.addEventListener("click", () => {
      createModal.style.display = "none";
      resetCreateForms();
    });

    // Create form submit buttons
    submitProjectBtn.addEventListener("click", submitProject);
    submitPostBtn.addEventListener("click", submitPost);
    submitGroupBtn.addEventListener("click", submitGroup);
    submitCommunityBtn.addEventListener("click", submitCommunity);

    // Emoji picker toggle
    emojiBtn.addEventListener("click", (e) => {
      e.stopPropagation();
      emojiPicker.style.display = emojiPicker.style.display === "block" ? "none" : "block";
    });

    // Add emoji to input
    emojiPicker.querySelectorAll("span").forEach((emojiSpan) => {
      emojiSpan.addEventListener("click", () => {
        messageInput.value += emojiSpan.textContent;
        emojiPicker.style.display = "none";
        messageInput.focus();
      });
    });

    // Close emoji picker if clicking outside
    document.addEventListener("click", (e) => {
      if (!emojiPicker.contains(e.target) && e.target !== emojiBtn) {
        emojiPicker.style.display = "none";
      }
    });

    // Redirect user to settings on notification click
    noSongNotification.querySelector("span").addEventListener("click", () => {
      window.location.href = "settings.html";
    });

    // Dismiss notification
    dismissBtn.addEventListener("click", (e) => {
      e.stopPropagation();
      dismissSongNotification();
    });

    // Image upload
    uploadBtn.addEventListener("click", () => {
      fileInput.click();
    });

    fileInput.addEventListener("change", handleImageUpload);

    // Channel switching
    channelItems.forEach(item => {
      item.addEventListener("click", () => {
        channelItems.forEach(i => i.classList.remove("active"));
        item.classList.add("active");
        currentChannel = item.dataset.channel;
        channelTitle.textContent = item.querySelector("span").textContent.slice(1);
        loadChannelMessages();
      });
    });

    // Search functionality
    searchBar.addEventListener("input", handleSearch);
    searchBar.addEventListener("focus", () => {
      if (searchBar.value.trim() !== "") {
        searchResults.style.display = "block";
      }
    });
    searchBar.addEventListener("blur", () => {
      setTimeout(() => {
        searchResults.style.display = "none";
      }, 200);
    });

    // Edit message modal
    cancelEditBtn.addEventListener("click", () => {
      editMessageModal.style.display = "none";
    });
    saveEditBtn.addEventListener("click", saveEditedMessage);

    // Status info button
    statusInfoBtn.addEventListener("click", (e) => {
      e.stopPropagation();
      statusInfo.style.display = statusInfo.style.display === "block" ? "none" : "block";
    });

    // Close status info when clicking outside
    document.addEventListener("click", () => {
      statusInfo.style.display = "none";
    });
  }

  // Add code snippet to project form
  function addCodeSnippet() {
    const snippetId = Date.now();
    const snippetDiv = document.createElement("div");
    snippetDiv.className = "code-snippet";
    snippetDiv.innerHTML = `
      <div class="code-header">
        <select class="code-language" data-id="${snippetId}">
          <option value="html">HTML</option>
          <option value="css">CSS</option>
          <option value="javascript">JavaScript</option>
          <option value="python">Python</option>
          <option value="java">Java</option>
          <option value="csharp">C#</option>
          <option value="php">PHP</option>
          <option value="ruby">Ruby</option>
          <option value="swift">Swift</option>
          <option value="kotlin">Kotlin</option>
          <option value="go">Go</option>
          <option value="rust">Rust</option>
          <option value="typescript">TypeScript</option>
          <option value="bash">Bash</option>
          <option value="sql">SQL</option>
        </select>
        <span class="remove-code" data-id="${snippetId}">Remove</span>
      </div>
      <textarea class="code-content" data-id="${snippetId}" placeholder="Enter your code here"></textarea>
    `;
    
    codeSnippetsContainer.appendChild(snippetDiv);
    
    // Add event listener for remove button
    snippetDiv.querySelector(".remove-code").addEventListener("click", (e) => {
      const id = e.target.dataset.id;
      document.querySelector(`.code-snippet [data-id="${id}"]`).parentNode.parentNode.remove();
    });
  }

  // Add rule input to group form
  function addRuleInput() {
    const ruleId = Date.now();
    const ruleDiv = document.createElement("div");
    ruleDiv.className = "rule-item";
    ruleDiv.innerHTML = `
      <input type="text" data-id="${ruleId}" placeholder="Enter rule text">
      <span class="remove-rule" data-id="${ruleId}">Remove</span>
    `;
    
    rulesContainer.appendChild(ruleDiv);
    
    // Add event listener for remove button
    ruleDiv.querySelector(".remove-rule").addEventListener("click", (e) => {
      const id = e.target.dataset.id;
      document.querySelector(`.rule-item [data-id="${id}"]`).parentNode.remove();
    });
  }

  // Add collaborator to community form
  function addCollaborator() {
    const email = collaboratorEmailInput.value.trim();
    if (!email) return;
    
    if (!email.includes("@")) {
      alert("Please enter a valid email address");
      return;
    }
    
    if (collaborators.includes(email)) {
      alert("This collaborator has already been added");
      return;
    }
    
    collaborators.push(email);
    updateCollaboratorsList();
    collaboratorEmailInput.value = "";
  }

  // Update collaborators list display
  function updateCollaboratorsList() {
    collaboratorsList.innerHTML = "";
    collaborators.forEach(email => {
      const item = document.createElement("div");
      item.className = "collaborator-item";
      item.innerHTML = `
        <span>${email}</span>
        <span class="remove-collaborator" data-email="${email}">Remove</span>
      `;
      
      item.querySelector(".remove-collaborator").addEventListener("click", (e) => {
        const emailToRemove = e.target.dataset.email;
        collaborators = collaborators.filter(e => e !== emailToRemove);
        updateCollaboratorsList();
      });
      
      collaboratorsList.appendChild(item);
    });
  }

  // Update post preview based on formatting
  function updatePostPreview() {
    let content = postContent.value;
    
    // Apply formatting
    if (boldBtn.classList.contains("active")) {
      content = `<strong>${content}</strong>`;
    }
    if (italicBtn.classList.contains("active")) {
      content = `<em>${content}</em>`;
    }
    if (underlineBtn.classList.contains("active")) {
      content = `<u>${content}</u>`;
    }
    
    // Set font family
    const fontFamily = postFontSelect.value;
    postPreview.style.fontFamily = fontFamily;
    postPreview.innerHTML = content;
  }

  // Submit project form
  async function submitProject() {
    const name = document.getElementById("project-name").value.trim();
    const description = document.getElementById("project-description").value.trim();
    const banner = document.getElementById("project-banner").value.trim();
    const overview = document.getElementById("project-overview").value.trim();
    const steps = document.getElementById("project-steps").value.trim();
    const importance = document.getElementById("project-importance").value.trim();
    const profitability = document.getElementById("project-profitability").value.trim();
    const obstacles = document.getElementById("project-obstacles").value.trim();
    
    // Validate required fields
    if (!name || !description || !banner || !overview || !importance || !profitability || !obstacles) {
      alert("Please fill in all required fields");
      return;
    }
    
    // Collect code snippets
    const codeSnippets = [];
    document.querySelectorAll(".code-snippet").forEach(snippet => {
      const language = snippet.querySelector(".code-language").value;
      const content = snippet.querySelector(".code-content").value.trim();
      if (content) {
        codeSnippets.push({ language, content });
      }
    });
    
    try {
      // Add project to Firestore
      const projectRef = await addDoc(collection(db, "Kamba_projects"), {
        name,
        description,
        banner,
        overview,
        steps,
        importance,
        profitability,
        obstacles,
        codeSnippets,
        creatorId: currentUser.uid,
        creatorEmail: currentUser.email,
        createdAt: new Date(),
        likes: 0,
        shares: 0,
        comments: 0,
        views: 0
      });
      
      // Update user's projects list
      await updateDoc(doc(db, "Kamba_users", currentUser.uid), {
        projects: arrayUnion(projectRef.id)
      });
      
      // Close modal and reset form
      createModal.style.display = "none";
      resetCreateForms();
      alert("Project created successfully!");
      
      // Reload projects channel if active
      if (currentChannel === "projects") {
        loadChannelMessages();
      }
    } catch (error) {
      console.error("Error creating project:", error);
      alert("Failed to create project");
    }
  }

  // Submit post form
  async function submitPost() {
    const content = postContent.value.trim();
    if (!content) {
      alert("Please enter post content");
      return;
    }
    
    const isBold = boldBtn.classList.contains("active");
    const isItalic = italicBtn.classList.contains("active");
    const isUnderline = underlineBtn.classList.contains("active");
    const fontFamily = postFontSelect.value;
    
    try {
      // Add post to Firestore
      await addDoc(collection(db, "Kamba_posts"), {
        content,
        isBold,
        isItalic,
        isUnderline,
        fontFamily,
        creatorId: currentUser.uid,
        creatorEmail: currentUser.email,
        createdAt: new Date(),
        likes: 0,
        shares: 0,
        comments: 0
      });
      
      // Close modal and reset form
      createModal.style.display = "none";
      resetCreateForms();
      alert("Post created successfully!");
      
      // Reload posts channel if active
      if (currentChannel === "posts") {
        loadChannelMessages();
      }
    } catch (error) {
      console.error("Error creating post:", error);
      alert("Failed to create post");
    }
  }

  // Submit group form
  async function submitGroup() {
    const name = document.getElementById("group-name").value.trim();
    const image = document.getElementById("group-image").value.trim();
    const banner = document.getElementById("group-banner").value.trim();
    const description = document.getElementById("group-description").value.trim();
    
    // Validate required fields
    if (!name || !image || !description) {
      alert("Please fill in all required fields");
      return;
    }
    
    // Collect rules
    const rules = [];
    document.querySelectorAll(".rule-item input").forEach(input => {
      const rule = input.value.trim();
      if (rule) {
        rules.push(rule);
      }
    });
    
    try {
      // Add group to Firestore
      const groupRef = await addDoc(collection(db, "Kamba_groups"), {
        name,
        image,
        banner,
        description,
        rules,
        creatorId: currentUser.uid,
        creatorEmail: currentUser.email,
        createdAt: new Date(),
        members: [currentUser.uid],
        maxMembers: 20,
        isPrivate: true
      });
      
      // Update user's groups list
      await updateDoc(doc(db, "Kamba_users", currentUser.uid), {
        groups: arrayUnion(groupRef.id)
      });
      
      // Close modal and reset form
      createModal.style.display = "none";
      resetCreateForms();
      alert("Group created successfully!");
      
      // Reload groups in sidebar
      loadGroups();
    } catch (error) {
      console.error("Error creating group:", error);
      alert("Failed to create group");
    }
  }

  // Submit community form
  async function submitCommunity() {
    const name = document.getElementById("community-name").value.trim();
    const image = document.getElementById("community-image").value.trim();
    const banner = document.getElementById("community-banner").value.trim();
    const description = document.getElementById("community-description").value.trim();
    
    // Validate required fields
    if (!name || !image || !description) {
      alert("Please fill in all required fields");
      return;
    }
    
    // Validate collaborators
    const validCollaborators = [];
    for (const email of collaborators) {
      // Check if user exists
      const usersQuery = query(collection(db, "Kamba_users"), where("email", "==", email));
      const querySnapshot = await getDocs(usersQuery);
      
      if (!querySnapshot.empty) {
        const userDoc = querySnapshot.docs[0];
        validCollaborators.push({
          email,
          userId: userDoc.id
        });
      }
    }
    
    try {
      // Add community to Firestore
      const communityRef = await addDoc(collection(db, "Kamba_communities"), {
        name,
        image,
        banner,
        description,
        collaborators: validCollaborators,
        creatorId: currentUser.uid,
        creatorEmail: currentUser.email,
        createdAt: new Date(),
        members: [currentUser.uid],
        isPublic: true,
        announcements: [],
        rules: []
      });
      
      // Update user's communities list
      await updateDoc(doc(db, "Kamba_users", currentUser.uid), {
        communities: arrayUnion(communityRef.id)
      });
      
      // Close modal and reset form
      createModal.style.display = "none";
      resetCreateForms();
      alert("Community created successfully!");
      
      // Reload communities channel if active
      if (currentChannel === "communities") {
        loadChannelMessages();
      }
    } catch (error) {
      console.error("Error creating community:", error);
      alert("Failed to create community");
    }
  }

  // Reset all create forms
  function resetCreateForms() {
    // Project form
    document.getElementById("project-name").value = "";
    document.getElementById("project-description").value = "";
    document.getElementById("project-banner").value = "";
    document.getElementById("project-overview").value = "";
    document.getElementById("project-steps").value = "";
    document.getElementById("project-importance").value = "";
    document.getElementById("project-profitability").value = "";
    document.getElementById("project-obstacles").value = "";
    codeSnippetsContainer.innerHTML = "";
    
    // Post form
    postContent.value = "";
    boldBtn.classList.remove("active");
    italicBtn.classList.remove("active");
    underlineBtn.classList.remove("active");
    postFontSelect.value = "Poppins";
    postPreview.innerHTML = "";
    postPreview.style.fontFamily = "Poppins";
    
    // Group form
    document.getElementById("group-name").value = "";
    document.getElementById("group-image").value = "";
    document.getElementById("group-banner").value = "";
    document.getElementById("group-description").value = "";
    rulesContainer.innerHTML = "";
    
    // Community form
    document.getElementById("community-name").value = "";
    document.getElementById("community-image").value = "";
    document.getElementById("community-banner").value = "";
    document.getElementById("community-description").value = "";
    collaborators = [];
    collaboratorsList.innerHTML = "";
    collaboratorEmailInput.value = "";
    
    // Reset to project tab
    createTabs.forEach(t => t.classList.remove("active"));
    createTabs[0].classList.add("active");
    createTabContents.forEach(c => c.classList.remove("active"));
    createTabContents[0].classList.add("active");
    currentActiveTab = "project";
  }

  // Update user profile section
  function updateUserProfile(userData) {
    if (!userData) return;
    
    // Set profile picture
    if (userData.profilePic) {
      profilePic.style.backgroundImage = `url(${userData.profilePic})`;
      profilePic.textContent = "";
    } else {
      const displayName = simplifyEmail(userData.email);
      profilePic.textContent = displayName.charAt(0).toUpperCase();
      profilePic.style.backgroundImage = "none";
      
      // Set random color for profile pic
      const colors = ['#5865f2', '#57f287', '#f04747', '#eb459e', '#ed4245', '#faa61a'];
      const randomColor = colors[Math.floor(Math.random() * colors.length)];
      profilePic.style.backgroundColor = randomColor;
    }
    
    // Set username
    profileName.textContent = simplifyEmail(userData.email);
    
    // Set status based on sparks
    let status, statusColor;
    if (userData.isAdmin) {
      status = "Admin";
      statusColor = "red";
    } else {
      const sparks = userData.sparks || 0;
      if (sparks >= 1000) {
        status = "Violet";
        statusColor = "violet";
      } else if (sparks >= 100) {
        status = "Blue";
        statusColor = "blue";
      } else {
        status = "Green";
        statusColor = "green";
      }
    }
    
    statusDot.className = "status-dot " + statusColor;
    statusText.textContent = status;
    
    // Update sparks count
    sparksValue.textContent = userData.sparks || 0;
  }

  // Load random groups into sidebar from Firestore
  async function loadGroups() {
    rightSidebar.innerHTML = '<div class="right-sidebar-title">GROUPS</div>';
    
    try {
      const groupsQuery = query(collection(db, "Kamba_groups"));
      const querySnapshot = await getDocs(groupsQuery);
      
      if (querySnapshot.empty) {
        console.log("No groups found");
        return;
      }
      
      // Convert to array and shuffle
      const groups = [];
      querySnapshot.forEach(doc => {
        groups.push({ id: doc.id, ...doc.data() });
      });
      
      const shuffledGroups = [...groups].sort(() => 0.5 - Math.random()).slice(0, 4);
      
      shuffledGroups.forEach(group => {
        const groupItem = document.createElement("div");
        groupItem.className = "group-item";
        groupItem.dataset.groupId = group.id;
        
        const avatar = document.createElement("img");
        avatar.className = "group-avatar";
        avatar.src = group.image || "https://i.imgur.com/J6l19aF.png";
        avatar.alt = group.name;
        
        const name = document.createElement("div");
        name.className = "group-name";
        name.textContent = group.name;
        
        groupItem.appendChild(avatar);
        groupItem.appendChild(name);
        rightSidebar.appendChild(groupItem);
        
        // Add click event to view group
        groupItem.addEventListener("click", () => {
          // In a real app, this would navigate to the group
          alert(`Viewing group: ${group.name}`);
        });
      });
    } catch (error) {
      console.error("Error loading groups:", error);
    }
  }

  // Check if song notification was dismissed
  function checkSongNotificationDismissed() {
    const dismissedUntil = localStorage.getItem('songNotificationDismissed');
    if (dismissedUntil && Date.now() < parseInt(dismissedUntil)) {
      noSongNotification.style.display = "none";
    }
  }

  // Dismiss song notification for 5 hours
  function dismissSongNotification() {
    const fiveHours = 5 * 60 * 60 * 1000;
    const dismissedUntil = Date.now() + fiveHours;
    localStorage.setItem('songNotificationDismissed', dismissedUntil.toString());
    noSongNotification.style.display = "none";
  }

  // Handle image upload to ImgBB
  async function handleImageUpload(e) {
    const files = e.target.files;
    if (!files || files.length === 0) return;

    // Check if user can upload images
    if (getUserStatus(currentUserData) === "green") {
      alert("Your account level (Green) doesn't allow image uploads. Reach Blue status to unlock this feature.");
      fileInput.value = "";
      return;
    }

    try {
      // For multiple images, we'll upload them one by one
      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        if (file.size > 6 * 1024 * 1024) {
          alert("Image is too large (max 6MB)");
          continue;
        }

        const formData = new FormData();
        formData.append("image", file);
        
        // Upload to ImgBB
        const response = await fetch(`https://api.imgbb.com/1/upload?key=0f248e70fc4e7dffde307dd772823379`, {
          method: "POST",
          body: formData
        });
        
        const result = await response.json();
        if (result.success) {
          // Send message with image
          await sendMessage(null, result.data.url);
        } else {
          alert("Failed to upload image");
        }
      }
    } catch (error) {
      console.error("Image upload error:", error);
      alert("Error uploading image");
    } finally {
      fileInput.value = ""; // Reset file input
    }
  }

  // Handle search with 300ms debounce
  function handleSearch() {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(async () => {
      const searchTerm = searchBar.value.trim();
      if (searchTerm === "") {
        searchResults.innerHTML = "";
        searchResults.style.display = "none";
        return;
      }
      
      try {
        searchResults.innerHTML = "<div style='padding: 1rem; text-align: center;'>Searching...</div>";
        searchResults.style.display = "block";
        
        // Search users
        const usersQuery = query(
          collection(db, "Kamba_users"),
          where("email", ">=", searchTerm),
          where("email", "<=", searchTerm + "\uf8ff")
        );
        const usersSnapshot = await getDocs(usersQuery);
        
        // Search groups
        const groupsQuery = query(
          collection(db, "Kamba_groups"),
          where("name", ">=", searchTerm),
          where("name", "<=", searchTerm + "\uf8ff")
        );
        const groupsSnapshot = await getDocs(groupsQuery);
        
        // Search announcements
        const announcementsQuery = query(
          collection(db, "Kamba_messages"),
          where("isAnnouncement", "==", true),
          where("message", ">=", searchTerm),
          where("message", "<=", searchTerm + "\uf8ff")
        );
        const announcementsSnapshot = await getDocs(announcementsQuery);
        
        // Search posts
        const postsQuery = query(
          collection(db, "Kamba_messages"),
          where("isPost", "==", true),
          where("message", ">=", searchTerm),
          where("message", "<=", searchTerm + "\uf8ff")
        );
        const postsSnapshot = await getDocs(postsQuery);
        
        // Combine and display results
        searchResults.innerHTML = "";
        
        // Users
        usersSnapshot.forEach(doc => {
          const data = doc.data();
          const item = document.createElement("div");
          item.className = "search-result-item";
          item.innerHTML = `
            <div>${simplifyEmail(data.email)}</div>
            <div class="search-result-type">User</div>
          `;
          item.addEventListener("click", () => {
            // In a real app, this would navigate to the user's profile
            alert(`Viewing user: ${simplifyEmail(data.email)}`);
          });
          searchResults.appendChild(item);
        });
        
        // Groups
        groupsSnapshot.forEach(doc => {
          const data = doc.data();
          const item = document.createElement("div");
          item.className = "search-result-item";
          item.innerHTML = `
            <div>${data.name}</div>
            <div class="search-result-type">Group</div>
          `;
          item.addEventListener("click", () => {
            // In a real app, this would navigate to the group
            alert(`Viewing group: ${data.name}`);
          });
          searchResults.appendChild(item);
        });
        
        // Announcements
        announcementsSnapshot.forEach(doc => {
          const data = doc.data();
          const item = document.createElement("div");
          item.className = "search-result-item";
          item.innerHTML = `
            <div>${data.message.slice(0, 50)}${data.message.length > 50 ? '...' : ''}</div>
            <div class="search-result-type">Announcement by ${simplifyEmail(data.senderEmail)}</div>
          `;
          item.addEventListener("click", () => {
            // In a real app, this would scroll to the announcement
            alert(`Viewing announcement: ${data.message.slice(0, 100)}...`);
          });
          searchResults.appendChild(item);
        });
        
        // Posts
        postsSnapshot.forEach(doc => {
          const data = doc.data();
          const item = document.createElement("div");
          item.className = "search-result-item";
          item.innerHTML = `
            <div>${data.message.slice(0, 50)}${data.message.length > 50 ? '...' : ''}</div>
            <div class="search-result-type">Post by ${simplifyEmail(data.senderEmail)}</div>
          `;
          item.addEventListener("click", () => {
            // In a real app, this would scroll to the post
            alert(`Viewing post: ${data.message.slice(0, 100)}...`);
          });
          searchResults.appendChild(item);
        });
        
        if (searchResults.children.length === 0) {
          searchResults.innerHTML = "<div style='padding: 1rem; text-align: center;'>No results found</div>";
        }
      } catch (error) {
        console.error("Search error:", error);
        searchResults.innerHTML = "<div style='padding: 1rem; text-align: center; color: #f04747;'>Error searching</div>";
      }
    }, 300);
  }

  // Helper: remove @gmail.com and similar domains
  function simplifyEmail(email) {
    if (!email) return "unknown";
    return email.split("@")[0];
  }

  // Get user status based on sparks
  function getUserStatus(userData) {
    if (!userData) return "green";
    if (userData.isAdmin) return "red";
    const sparks = userData.sparks || 0;
    if (sparks >= 1000) return "violet";
    if (sparks >= 100) return "blue";
    return "green";
  }

  // Get status class for styling
  function getStatusClass(status) {
    return status.toLowerCase();
  }

  // Render a message
  function renderMessage(id, msgData) {
    const div = document.createElement("div");
    div.className = "message";
    div.dataset.id = id;

    const headerDiv = document.createElement("div");
    headerDiv.className = "message-header";

    const usernameSpan = document.createElement("span");
    usernameSpan.className = "username " + getStatusClass(msgData.status);
    usernameSpan.textContent = msgData.sender;
    headerDiv.appendChild(usernameSpan);

    if (msgData.isAnnouncement) {
      const badge = document.createElement("span");
      badge.className = "announcement-badge";
      badge.textContent = "ANNOUNCEMENT";
      headerDiv.appendChild(badge);
    } else if (msgData.isPost) {
      const badge = document.createElement("span");
      badge.className = "post-badge";
      badge.textContent = "POST";
      headerDiv.appendChild(badge);
    }

    const timeSpan = document.createElement("span");
    timeSpan.className = "message-time";
    timeSpan.textContent = formatTime(msgData.timestamp);
    headerDiv.appendChild(timeSpan);

    div.appendChild(headerDiv);

    if (msgData.replyToText) {
      const replyDiv = document.createElement("div");
      replyDiv.className = "reply-to";
      replyDiv.textContent = "Replying to: " + msgData.replyToText;
      div.appendChild(replyDiv);
    }

    const textDiv = document.createElement("div");
    textDiv.className = "message-text";
    
    // Process mentions and posts/announcements
    let messageText = msgData.message;
    if (messageText) {
      // Replace @mentions with styled spans
      messageText = messageText.replace(/@(\w+)/g, '<span class="mention">@$1</span>');
      textDiv.innerHTML = messageText;
    } else {
      textDiv.textContent = "";
    }
    
    div.appendChild(textDiv);

    if (msgData.imageUrl) {
      const imgContainer = document.createElement("div");
      const img = document.createElement("img");
      img.src = msgData.imageUrl;
      img.className = "message-image";
      img.alt = "Uploaded image";
      
      img.addEventListener("click", () => showFullImage(msgData.imageUrl));
      imgContainer.appendChild(img);
      div.appendChild(imgContainer);
    }

    // Message actions (like, reply, etc.)
    const actionsDiv = document.createElement("div");
    actionsDiv.className = "message-actions";
    
    // Reply button (all users)
    const replyBtn = document.createElement("span");
    replyBtn.className = "message-action";
    replyBtn.textContent = "Reply";
    replyBtn.addEventListener("click", () => {
      replyToMessageId = id;
      replyToMessageText = msgData.message;
      messageInput.focus();
      messageInput.placeholder = "Replying: " + replyToMessageText.slice(0, 30) + "... (click send)";
    });
    actionsDiv.appendChild(replyBtn);
    
    // Like button (all users)
    const likeBtn = document.createElement("span");
    likeBtn.className = "message-action";
    likeBtn.textContent = "Like";
    
    // Check if user already liked this
    const hasLiked = likedMessages.has(id) || 
                    (msgData.isPost && likedPosts.has(id)) || 
                    (msgData.isProject && likedProjects.has(id));
    
    if (hasLiked) {
      likeBtn.textContent = "Liked";
      likeBtn.style.color = "#43b581";
    } else {
      likeBtn.addEventListener("click", () => {
        if (msgData.isPost) {
          likePost(id, msgData.userId);
        } else if (msgData.isProject) {
          likeProject(id, msgData.userId);
        } else {
          likeMessage(id, msgData.userId);
        }
      });
    }
    
    actionsDiv.appendChild(likeBtn);
    
    // Dislike button (all users)
    const dislikeBtn = document.createElement("span");
    dislikeBtn.className = "message-action";
    dislikeBtn.textContent = "Dislike";
    dislikeBtn.addEventListener("click", () => {
      if (msgData.isPost) {
        dislikePost(id, msgData.userId);
      } else if (msgData.isProject) {
        dislikeProject(id, msgData.userId);
      }
    });
    
    if (msgData.isPost || msgData.isProject) {
      actionsDiv.appendChild(dislikeBtn);
    }
    
    // Edit button (only for own messages)
    if (msgData.userId === currentUser?.uid) {
      const editBtn = document.createElement("span");
      editBtn.className = "message-action";
      editBtn.textContent = "Edit";
      editBtn.addEventListener("click", () => editMessage(id, msgData.message));
      actionsDiv.appendChild(editBtn);
    }
    
    // Delete button (own messages for blue+, any for red)
    if ((msgData.userId === currentUser?.uid && getUserStatus(currentUserData) !== "green") || 
        getUserStatus(currentUserData) === "red") {
      const deleteBtn = document.createElement("span");
      deleteBtn.className = "message-action";
      deleteBtn.textContent = "Delete";
      deleteBtn.addEventListener("click", () => deleteMessage(id));
      actionsDiv.appendChild(deleteBtn);
    }
    
    // Report button (for others' messages)
    if (msgData.userId !== currentUser?.uid) {
      const reportBtn = document.createElement("span");
      reportBtn.className = "message-action";
      reportBtn.textContent = "Report";
      reportBtn.addEventListener("click", () => reportMessage(id));
      actionsDiv.appendChild(reportBtn);
    }
    
    div.appendChild(actionsDiv);

    return div;
  }

  // Format timestamp
  function formatTime(timestamp) {
    if (!timestamp) return "";
    const date = new Date(timestamp);
    return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  }

  // Show full screen image
  function showFullImage(url) {
    const container = document.createElement("div");
    container.className = "image-container";
    
    const img = document.createElement("img");
    img.src = url;
    img.className = "full-image";
    
    const closeBtn = document.createElement("span");
    closeBtn.className = "close-image";
    closeBtn.innerHTML = "&times;";
    closeBtn.addEventListener("click", () => {
      document.body.removeChild(container);
    });
    
    const downloadBtn = document.createElement("span");
    downloadBtn.className = "download-image";
    downloadBtn.innerHTML = "&#x2193;";
    downloadBtn.addEventListener("click", () => {
      const a = document.createElement("a");
      a.href = url;
      a.download = "kamba-image-" + Date.now();
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    });
    
    container.appendChild(img);
    container.appendChild(closeBtn);
    container.appendChild(downloadBtn);
    document.body.appendChild(container);
  }

  // Load messages for current channel
  function loadChannelMessages() {
    // Clear existing messages
    messagesContainer.innerHTML = "";
    
    let messagesQuery;
    if (currentChannel === "general") {
      messagesQuery = query(
        collection(db, "Kamba_messages"),
        where("isAnnouncement", "==", false),
        where("isPost", "==", false),
        orderBy("timestamp", "asc")
      );
    } else if (currentChannel === "announcements") {
      messagesQuery = query(
        collection(db, "Kamba_messages"),
        where("isAnnouncement", "==", true),
        orderBy("timestamp", "asc")
      );
    } else if (currentChannel === "posts") {
      messagesQuery = query(
        collection(db, "Kamba_messages"),
        where("isPost", "==", true),
        orderBy("timestamp", "asc")
      );
    } else if (currentChannel === "projects") {
      messagesQuery = query(
        collection(db, "Kamba_projects"),
        orderBy("createdAt", "asc")
      );
    } else {
      // For other channels, show empty state
      messagesContainer.innerHTML = `<div style="text-align: center; padding: 2rem; color: #b9bbbe;">
        ${currentChannel.charAt(0).toUpperCase() + currentChannel.slice(1)} content will appear here
      </div>`;
      return;
    }
    
    if (messagesQuery) {
      setupMessagesListener(messagesQuery);
    }
  }

  // Setup Firestore real-time listener for messages
  function setupMessagesListener(messagesQuery) {
    const unsubscribe = onSnapshot(messagesQuery, async (querySnapshot) => {
      messagesContainer.innerHTML = ""; // Clear chat on update

      // We want to show username colored by status, so fetch user statuses:
      const userIds = new Set();
      querySnapshot.forEach((doc) => {
        if (doc.data().userId) {
          userIds.add(doc.data().userId);
        }
        if (doc.data().creatorId) {
          userIds.add(doc.data().creatorId);
        }
      });
      
      // Preload user data for all message senders:
      const userDataMap = new Map();
      const userDocsPromises = [];
      userIds.forEach((uid) => {
        userDocsPromises.push(getDoc(doc(db, "Kamba_users", uid)));
      });
      
      try {
        const userDocs = await Promise.all(userDocsPromises);
        userDocs.forEach((docSnap) => {
          if (docSnap.exists()) {
            userDataMap.set(docSnap.id, docSnap.data());
          }
        });

        // Render messages
        querySnapshot.forEach((docSnap) => {
          const data = docSnap.data();
          let senderUid, displayName, status, messageData;
          
          if (currentChannel === "projects") {
            // Handle projects differently
            senderUid = data.creatorId;
            const userData = userDataMap.get(senderUid) || {};
            displayName = simplifyEmail(data.creatorEmail || "unknown");
            status = getUserStatus(userData);

            messageData = {
              sender: displayName,
              status: status,
              message: `${data.name}: ${data.description}`,
              isProject: true,
              timestamp: data.createdAt,
              userId: senderUid
            };
          } else {
            // Regular messages
            senderUid = data.userId;
            const userData = userDataMap.get(senderUid) || {};
            displayName = simplifyEmail(data.senderEmail || "unknown");
            status = getUserStatus(userData);

            messageData = {
              sender: displayName,
              status: status,
              message: data.message,
              replyToText: data.replyToText || null,
              imageUrl: data.imageUrl || null,
              isAnnouncement: data.isAnnouncement || false,
              isPost: data.isPost || false,
              timestamp: data.timestamp,
              userId: data.userId
            };
          }
          
          const msgDiv = renderMessage(docSnap.id, messageData);
          messagesContainer.appendChild(msgDiv);
        });

        // Scroll to bottom on new messages
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      } catch (error) {
        console.error("Error loading user data:", error);
      }
    });
    
    return unsubscribe;
  }

  // Like a message
  async function likeMessage(messageId, senderUid) {
    if (likedMessages.has(messageId)) {
      alert("You've already liked this message");
      return;
    }
    
    try {
      likedMessages.add(messageId);
      
      // Update sender's sparks (2 sparks per like)
      const senderRef = doc(db, "Kamba_users", senderUid);
      await updateDoc(senderRef, {
        sparks: increment(2)
      });
      
      // Reload messages to show updated like status
      loadChannelMessages();
    } catch (error) {
      console.error("Error liking message:", error);
      alert("Failed to like message");
    }
  }

  // Like a post
  async function likePost(postId, senderUid) {
    if (likedPosts.has(postId)) {
      alert("You've already liked this post");
      return;
    }
    
    try {
      likedPosts.add(postId);
      
      // Update sender's sparks (2 sparks per post like)
      const senderRef = doc(db, "Kamba_users", senderUid);
      await updateDoc(senderRef, {
        sparks: increment(2)
      });
      
      // Reload messages to show updated like status
      loadChannelMessages();
    } catch (error) {
      console.error("Error liking post:", error);
      alert("Failed to like post");
    }
  }

  // Dislike a post
  async function dislikePost(postId, senderUid) {
    try {
      // Update sender's sparks (-1 spark per dislike)
      const senderRef = doc(db, "Kamba_users", senderUid);
      await updateDoc(senderRef, {
        sparks: increment(-1)
      });
      
      // Reload messages to show updated status
      loadChannelMessages();
    } catch (error) {
      console.error("Error disliking post:", error);
      alert("Failed to dislike post");
    }
  }

  // Like a project
  async function likeProject(projectId, senderUid) {
    if (likedProjects.has(projectId)) {
      alert("You've already liked this project");
      return;
    }
    
    try {
      likedProjects.add(projectId);
      
      // Update sender's sparks (5 sparks per project like)
      const senderRef = doc(db, "Kamba_users", senderUid);
      await updateDoc(senderRef, {
        sparks: increment(5)
      });
      
      // Reload messages to show updated like status
      loadChannelMessages();
    } catch (error) {
      console.error("Error liking project:", error);
      alert("Failed to like project");
    }
  }

  // Dislike a project
  async function dislikeProject(projectId, senderUid) {
    try {
      // Update sender's sparks (-3 sparks per dislike)
      const senderRef = doc(db, "Kamba_users", senderUid);
      await updateDoc(senderRef, {
        sparks: increment(-3)
      });
      
      // Reload messages to show updated status
      loadChannelMessages();
    } catch (error) {
      console.error("Error disliking project:", error);
      alert("Failed to dislike project");
    }
  }

  // Edit a message
  function editMessage(messageId, currentText) {
    messageBeingEdited = messageId;
    editMessageInput.value = currentText;
    editMessageModal.style.display = "flex";
    editMessageInput.focus();
  }

  // Save edited message
  async function saveEditedMessage() {
    if (!messageBeingEdited) return;
    
    const newText = editMessageInput.value.trim();
    if (!newText) {
      alert("Message cannot be empty");
      return;
    }
    
    try {
      const messageRef = doc(db, "Kamba_messages", messageBeingEdited);
      await updateDoc(messageRef, {
        message: newText,
        edited: true
      });
      
      editMessageModal.style.display = "none";
      messageBeingEdited = null;
    } catch (error) {
      console.error("Error editing message:", error);
      alert("Failed to edit message");
    }
  }

  // Delete a message
  async function deleteMessage(messageId) {
    if (!confirm("Are you sure you want to delete this message?")) return;
    
    try {
      await deleteDoc(doc(db, "Kamba_messages", messageId));
    } catch (error) {
      console.error("Error deleting message:", error);
      alert("Failed to delete message");
    }
  }

  // Report a message
  function reportMessage(messageId) {
    alert(`Message ${messageId} reported to admins. Thank you!`);
    // In a real app, this would create a report in Firestore
  }

  // Send message handler
  sendBtn.addEventListener("click", () => sendMessage());
  messageInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });

  // Auto-resize textarea
  messageInput.addEventListener("input", function() {
    this.style.height = "auto";
    this.style.height = (this.scrollHeight) + "px";
  });

  async function sendMessage(text = null, imageUrl = null) {
    const messageText = text || messageInput.value.trim();
    
    // Check if this is a special command (announcement or post)
    let isAnnouncement = false;
    let isPost = false;
    let processedText = messageText;
    
    if (getUserStatus(currentUserData) === "red" && messageText.startsWith("#announcement")) {
      isAnnouncement = true;
      processedText = messageText.replace("#announcement", "").trim();
    } else if ((getUserStatus(currentUserData) === "violet" || getUserStatus(currentUserData) === "red") && 
               messageText.startsWith("&post")) {
      isPost = true;
      processedText = messageText.replace("&post", "").trim();
    }
    
    if (!processedText && !imageUrl) return;

    try {
      // Add message doc
      await addDoc(collection(db, "Kamba_messages"), {
        userId: currentUser.uid,
        senderEmail: currentUser.email,
        sender: simplifyEmail(currentUser.email),
        message: processedText || "",
        replyTo: replyToMessageId || null,
        replyToText: replyToMessageText || null,
        imageUrl: imageUrl || null,
        isAnnouncement: isAnnouncement,
        isPost: isPost,
        timestamp: Date.now(),
      });

      // Reset input & reply if this was a text message
      if (!text) {
        messageInput.value = "";
        messageInput.style.height = "auto";
        messageInput.placeholder = "Type a message...";
        replyToMessageId = null;
        replyToMessageText = null;
      }

      // Update sparks for regular messages (not posts/announcements)
      if (!isAnnouncement && !isPost) {
        const userDocRef = doc(db, "Kamba_users", currentUser.uid);
        await updateDoc(userDocRef, {
          sparks: increment(1)
        });
      }
    } catch (err) {
      alert("Error sending message: " + err.message);
    }
  }

  // Set up user environment after authentication
  function setupUserEnvironment() {
    // Set background audio if available
    if (currentUserData.song && currentUserData.song.trim() !== "") {
      // Check if song exists in Music folder
      const songName = currentUserData.song.split('/').pop().split('.')[0];
      const songPath = `Music/${songName}.mp3`;
      
      // Try to play the song (in a real app, you would check if the file exists)
      backgroundAudio.src = songPath;
      backgroundAudio.volume = currentUserData.volume ?? 0.5;
      
      // Play audio on first interaction
      document.addEventListener('click', function firstInteraction() {
        if (!hasInteracted) {
          backgroundAudio.play().catch(e => console.log("Audio play failed:", e));
          hasInteracted = true;
          document.removeEventListener('click', firstInteraction);
        }
      });
      
      noSongNotification.style.display = "none";
    } else {
      noSongNotification.style.display = "flex";
    }

    loadChannelMessages();
  }

  // Check authentication state
  function checkAuthState() {
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = "sign.html";
        return;
      }
      currentUser = user;

      // Load user data from Firestore
      const userDocRef = doc(db, "Kamba_users", user.uid);
      const userDocSnap = await getDoc(userDocRef);
      
      if (!userDocSnap.exists()) {
        // Show welcome modal for new users
        welcomeModal.style.display = "flex";
        return;
      }
      
      currentUserData = userDocSnap.data();
      updateUserProfile(currentUserData);
      setupUserEnvironment();
    });
  }

  // Initialize the app
  init();
</script>
</body>
</html>
