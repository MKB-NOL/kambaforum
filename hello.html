<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KAMBA Forum - Chat</title>
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    /* RESET & BASE STYLES */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body, html {
      height: 100%;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #36393f;
      color: #dcddde;
      overflow: hidden;
    }

    /* APP LAYOUT */
    #app {
      display: flex;
      height: 100vh;
      width: 100vw;
    }

    /* SERVER SIDEBAR */
    #sidebar-servers {
      width: 72px;
      background: #202225;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 12px 0 0;
      gap: 8px;
      overflow-y: auto;
      z-index: 3;
    }
    #sidebar-servers .server-icon {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: #36393f;
      color: #dcddde;
      font-weight: 500;
      font-size: 16px;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      transition: all 0.2s ease;
      position: relative;
    }
    #sidebar-servers .server-icon:hover {
      border-radius: 30%;
      background: #5865f2;
    }
    #sidebar-servers .server-icon.active {
      background: #5865f2;
      border-radius: 30%;
    }
    #sidebar-servers .server-icon.active::before {
      content: '';
      position: absolute;
      left: -8px;
      top: 50%;
      transform: translateY(-50%);
      height: 20px;
      width: 4px;
      background: white;
      border-radius: 0 4px 4px 0;
    }
    #sidebar-servers .divider {
      width: 32px;
      height: 2px;
      background: rgba(79, 84, 92, 0.48);
      margin: 8px 0;
    }

    /* CHANNELS SIDEBAR */
    #sidebar-channels {
      width: 240px;
      background: #2f3136;
      display: flex;
      flex-direction: column;
      color: #96989d;
      overflow: hidden;
    }
    #sidebar-channels .server-header {
      padding: 16px;
      border-bottom: 1px solid rgba(0, 0, 0, 0.2);
      box-shadow: 0 1px 0 rgba(0, 0, 0, 0.2);
      font-weight: 600;
      font-size: 16px;
      color: white;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    #sidebar-channels .category {
      margin-top: 16px;
      padding: 0 8px 0 16px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.02em;
      color: #96989d;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    #sidebar-channels .category .add-icon {
      opacity: 0;
      cursor: pointer;
    }
    #sidebar-channels .category:hover .add-icon {
      opacity: 1;
    }
    #sidebar-channels .list-item {
      padding: 6px 8px 6px 30px;
      margin: 1px 8px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      user-select: none;
      transition: background 0.1s, color 0.1s;
      display: flex;
      align-items: center;
      position: relative;
    }
    #sidebar-channels .list-item::before {
      content: '#';
      position: absolute;
      left: 10px;
      opacity: 0.6;
    }
    #sidebar-channels .list-item:hover {
      background: rgba(79, 84, 92, 0.4);
      color: #dcddde;
    }
    #sidebar-channels .list-item.active {
      background: rgba(79, 84, 92, 0.6);
      color: white;
    }
    #sidebar-channels .list-item.voice::before {
      content: '\f027';
      font-family: 'Font Awesome 6 Free';
      font-weight: 900;
    }
    #sidebar-channels .user-section {
      margin-top: auto;
      background: #292b2f;
      padding: 10px;
      display: flex;
      align-items: center;
    }
    #sidebar-channels .user-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: #5865f2;
      margin-right: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 600;
      color: white;
    }
    #sidebar-channels .user-info {
      flex-grow: 1;
    }
    #sidebar-channels .user-name {
      font-size: 14px;
      font-weight: 600;
      color: white;
    }
    #sidebar-channels .user-status {
      font-size: 12px;
      color: #b9bbbe;
    }
    #sidebar-channels .user-controls {
      display: flex;
      gap: 6px;
    }
    #sidebar-channels .user-controls i {
      color: #b9bbbe;
      cursor: pointer;
      font-size: 16px;
    }

    /* MAIN CONTENT AREA */
    #main-content {
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      background: #36393f;
    }

    /* HEADER */
    #header {
      height: 48px;
      background: #36393f;
      display: flex;
      align-items: center;
      padding: 0 16px;
      border-bottom: 1px solid rgba(0, 0, 0, 0.2);
      box-shadow: 0 1px 1px rgba(0, 0, 0, 0.1);
      z-index: 2;
    }
    #header .channel-info {
      display: flex;
      align-items: center;
    }
    #header .channel-name {
      font-weight: 700;
      font-size: 16px;
      color: white;
    }
    #header .channel-topic {
      margin-left: 8px;
      font-size: 12px;
      color: #b9bbbe;
    }
    #header .divider {
      height: 24px;
      width: 1px;
      background: rgba(79, 84, 92, 0.48);
      margin: 0 16px;
    }
    #header .search-container {
      position: relative;
      flex-grow: 1;
      max-width: 144px;
    }
    #header input[type="search"] {
      width: 100%;
      padding: 6px 26px 6px 8px;
      border-radius: 4px;
      border: none;
      font-size: 14px;
      outline: none;
      background: #202225;
      color: #dcddde;
    }
    #header .search-icon {
      position: absolute;
      right: 6px;
      top: 50%;
      transform: translateY(-50%);
      color: #b9bbbe;
      font-size: 14px;
    }
    #header .header-icons {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-left: 16px;
    }
    #header .header-icon {
      color: #b9bbbe;
      font-size: 18px;
      cursor: pointer;
    }
    #header .header-icon:hover {
      color: #dcddde;
    }

    /* CHAT AREA */
    #chat-container {
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      position: relative;
    }

    /* MESSAGES CONTAINER */
    #chat-messages {
      flex-grow: 1;
      overflow-y: auto;
      padding: 20px;
      scrollbar-width: thin;
      scrollbar-color: #202225 #2f3136;
    }
    #chat-messages::-webkit-scrollbar {
      width: 8px;
    }
    #chat-messages::-webkit-scrollbar-track {
      background: #2f3136;
    }
    #chat-messages::-webkit-scrollbar-thumb {
      background-color: #202225;
      border-radius: 4px;
    }

    /* MESSAGE STYLES */
    .message-group {
      margin-bottom: 20px;
      position: relative;
    }
    .message-group:hover .message-timestamp {
      opacity: 1;
    }
    .message {
      display: flex;
      padding: 2px 48px 2px 72px;
      position: relative;
      min-height: 44px;
    }
    .message:hover {
      background: rgba(4, 4, 5, 0.07);
    }
    .message-avatar {
      position: absolute;
      left: 16px;
      top: 2px;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      overflow: hidden;
      cursor: pointer;
    }
    .message-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .message-avatar .avatar-placeholder {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      color: white;
    }
    .message-avatar.green { background: #43b581; }
    .message-avatar.blue { background: #5865f2; }
    .message-avatar.violet { background: #8a2be2; }
    .message-avatar.red { background: #f04747; }
    .message-content {
      flex-grow: 1;
    }
    .message-header {
      display: flex;
      align-items: baseline;
      margin-bottom: 2px;
    }
    .message-username {
      font-weight: 500;
      font-size: 16px;
      color: white;
      margin-right: 8px;
      cursor: pointer;
    }
    .message-username:hover {
      text-decoration: underline;
    }
    .message-username.green { color: #43b581; }
    .message-username.blue { color: #5865f2; }
    .message-username.violet { color: #8a2be2; }
    .message-username.red { color: #f04747; }
    .message-timestamp {
      font-size: 12px;
      color: #72767d;
      opacity: 0;
      transition: opacity 0.2s;
    }
    .message-bot-tag {
      background: #5865f2;
      color: white;
      font-size: 10px;
      font-weight: 500;
      padding: 2px 4px;
      border-radius: 3px;
      margin-left: 4px;
      text-transform: uppercase;
      line-height: 1;
    }
    .message-text {
      font-size: 16px;
      line-height: 1.375;
      word-wrap: break-word;
      white-space: pre-wrap;
    }
    .message-reply {
      font-size: 14px;
      color: #b9bbbe;
      margin-bottom: 6px;
      display: flex;
      align-items: center;
    }
    .message-reply::before {
      content: '';
      display: inline-block;
      width: 36px;
      height: 12px;
      border-left: 2px solid #4f545c;
      border-bottom: 2px solid #4f545c;
      border-bottom-left-radius: 6px;
      margin-right: 8px;
    }
    .message-reply-username {
      color: white;
      font-weight: 500;
      margin-right: 4px;
    }
    .message-reply-content {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .message-actions {
      position: absolute;
      right: 16px;
      top: 2px;
      display: flex;
      background: #36393f;
      border-radius: 4px;
      box-shadow: 0 0 0 1px rgba(32, 34, 37, 0.6), 0 2px 10px 0 rgba(0, 0, 0, 0.2);
      opacity: 0;
      transition: opacity 0.2s;
    }
    .message:hover .message-actions {
      opacity: 1;
    }
    .message-action {
      color: #b9bbbe;
      padding: 4px 6px;
      cursor: pointer;
      font-size: 16px;
    }
    .message-action:hover {
      color: #dcddde;
    }
    .message-edited {
      font-size: 10px;
      color: #72767d;
      margin-left: 4px;
    }
    .message-attachments {
      margin-top: 8px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .message-attachment {
      max-width: 400px;
      border-radius: 4px;
      overflow: hidden;
      cursor: pointer;
    }
    .message-attachment img {
      max-width: 100%;
      max-height: 300px;
      object-fit: contain;
    }
    .message-attachment-download {
      position: absolute;
      top: 8px;
      right: 8px;
      background: rgba(0, 0, 0, 0.5);
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      opacity: 0;
      transition: opacity 0.2s;
    }
    .message-attachment:hover .message-attachment-download {
      opacity: 1;
    }

    /* INPUT AREA */
    #input-area {
      padding: 12px 16px;
      background: #484b52;
      display: flex;
      align-items: center;
      gap: 8px;
      position: relative;
    }
    #message-input-container {
      flex-grow: 1;
      position: relative;
      background: #40444b;
      border-radius: 8px;
    }
    #message-input {
      width: 100%;
      padding: 10px 12px;
      border: none;
      background: transparent;
      color: #dcddde;
      font-size: 15px;
      resize: none;
      outline: none;
      min-height: 20px;
      max-height: 200px;
      overflow-y: auto;
      scrollbar-width: thin;
    }
    #message-input::placeholder {
      color: #72767d;
    }
    #input-area .input-buttons {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 0 8px;
    }
    #input-area .input-button {
      color: #b9bbbe;
      font-size: 18px;
      cursor: pointer;
      transition: color 0.2s;
    }
    #input-area .input-button:hover {
      color: #dcddde;
    }
    #upload-image-input {
      display: none;
    }

    /* EMOJI PICKER */
    .emoji-picker {
      position: absolute;
      bottom: 70px;
      right: 20px;
      background: #2f3136;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      padding: 8px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      width: 240px;
      z-index: 1000;
    }
    .emoji-picker button {
      background: transparent;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #dcddde;
      transition: transform 0.2s;
      border-radius: 4px;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .emoji-picker button:hover {
      transform: scale(1.2);
      background: #40444b;
    }

    /* FULLSCREEN IMAGE VIEWER */
    #fullscreen-image-viewer {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.9);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }
    #fullscreen-image-viewer img {
      max-width: 90vw;
      max-height: 90vh;
      border-radius: 8px;
    }
    #fullscreen-image-viewer .close-btn {
      position: absolute;
      top: 20px;
      right: 20px;
      color: white;
      font-size: 30px;
      cursor: pointer;
      background: rgba(0, 0, 0, 0.5);
      width: 50px;
      height: 50px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* NO SONG NOTIFICATION */
    #no-song-notification {
      background: #f04747;
      color: white;
      padding: 10px 20px;
      font-weight: 600;
      text-align: center;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 20px;
      font-size: 15px;
    }
    #no-song-notification a {
      color: #fff;
      text-decoration: underline;
      cursor: pointer;
    }
    #dismiss-no-song-btn {
      background: transparent;
      border: none;
      font-size: 18px;
      color: white;
      cursor: pointer;
      font-weight: 700;
      line-height: 1;
    }

    /* LOADING OVERLAY */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 10000;
    }
    .loading-spinner {
      border: 5px solid #f3f3f3;
      border-top: 5px solid #5865f2;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* ERROR MESSAGE */
    .error-message {
      color: #f04747;
      background: rgba(240, 71, 71, 0.1);
      padding: 8px;
      border-radius: 4px;
      margin: 8px 0;
      font-size: 14px;
    }

    /* RESPONSIVE DESIGN */
    @media (max-width: 768px) {
      #sidebar-servers {
        width: 60px;
      }
      #sidebar-channels {
        display: none;
      }
      #header .search-container {
        display: none;
      }
      #header .header-icons {
        display: none;
      }
      .message {
        padding-left: 60px;
      }
      .message-avatar {
        left: 10px;
        width: 36px;
        height: 36px;
      }
      #input-area {
        padding: 8px 12px;
      }
    }
  </style>
</head>
<body>
  <div id="app">
    <!-- Left Sidebar (Servers / Groups) -->
    <nav id="sidebar-servers" aria-label="Servers">
      <div class="server-icon active" tabindex="0" title="Home">
        <i class="fas fa-home"></i>
      </div>
      <div class="divider"></div>
      <div class="server-icon" tabindex="0" title="KAMBA">
        <span>K</span>
      </div>
      <div class="server-icon" tabindex="0" title="Gaming">
        <i class="fas fa-gamepad"></i>
      </div>
      <div class="server-icon" tabindex="0" title="Music">
        <i class="fas fa-music"></i>
      </div>
      <div class="server-icon" tabindex="0" title="Study">
        <i class="fas fa-book"></i>
      </div>
      <div class="divider"></div>
      <div class="server-icon" tabindex="0" title="Add Server">
        <i class="fas fa-plus"></i>
      </div>
    </nav>

    <!-- Secondary Sidebar -->
    <aside id="sidebar-channels" aria-label="Channels and Groups">
      <div class="server-header">
        <span>KAMBA Community</span>
        <i class="fas fa-chevron-down"></i>
      </div>
      
      <div class="category">
        <span>Text Channels</span>
        <i class="fas fa-plus add-icon"></i>
      </div>
      <div class="list-item active">general</div>
      <div class="list-item">announcements</div>
      <div class="list-item">welcome</div>
      <div class="list-item">help</div>
      
      <div class="category">
        <span>Voice Channels</span>
        <i class="fas fa-plus add-icon"></i>
      </div>
      <div class="list-item voice">General</div>
      <div class="list-item voice">Gaming</div>
      <div class="list-item voice">Music</div>
      
      <div class="category">
        <span>Direct Messages</span>
        <i class="fas fa-plus add-icon"></i>
      </div>
      <div class="list-item">JohnDoe</div>
      <div class="list-item">JaneSmith</div>
      <div class="list-item">MikeJohnson</div>
      
      <div class="user-section">
        <div class="user-avatar">
          <span>U</span>
        </div>
        <div class="user-info">
          <div class="user-name">Username</div>
          <div class="user-status">Online</div>
        </div>
        <div class="user-controls">
          <i class="fas fa-microphone"></i>
          <i class="fas fa-headphones"></i>
          <i class="fas fa-cog"></i>
        </div>
      </div>
    </aside>

    <!-- Main Content -->
    <main id="main-content" role="main" aria-label="Chat">
      <!-- Header -->
      <header id="header">
        <div class="channel-info">
          <div class="channel-name">#general</div>
          <div class="channel-topic">Welcome to the general chat!</div>
        </div>
        <div class="divider"></div>
        <div class="search-container">
          <input
            type="search"
            placeholder="Search"
            aria-label="Search"
          />
          <i class="fas fa-search search-icon"></i>
        </div>
        <div class="header-icons">
          <i class="fas fa-user-friends header-icon"></i>
          <i class="fas fa-bell header-icon"></i>
          <i class="fas fa-pin header-icon"></i>
          <i class="fas fa-inbox header-icon"></i>
          <i class="fas fa-question-circle header-icon"></i>
        </div>
      </header>

      <!-- No song notification -->
      <div id="no-song-notification" role="alert" style="display:none;">
        No song set. <a href="#" id="set-song-link">Click here to set your song in Settings.</a>
        <button id="dismiss-no-song-btn" aria-label="Dismiss notification">&times;</button>
      </div>

      <!-- Chat Container -->
      <section id="chat-container">
        <div id="chat-messages" aria-live="polite" aria-relevant="additions">
          <!-- Messages will be added here dynamically -->
        </div>

        <!-- Input Area -->
        <div id="input-area">
          <div id="message-input-container">
            <textarea
              id="message-input"
              placeholder="Message #general"
              rows="1"
              aria-label="Message input"
            ></textarea>
          </div>
          <div class="input-buttons">
            <button id="emoji-btn" class="input-button" aria-label="Toggle emoji picker">
              <i class="far fa-smile"></i>
            </button>
            <button id="upload-image-btn" class="input-button" aria-label="Upload image(s)">
              <i class="fas fa-image"></i>
            </button>
            <input
              type="file"
              id="upload-image-input"
              accept="image/*"
              multiple
              aria-label="Upload images"
              hidden
            />
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- Emoji picker container (dynamic) -->
  <div class="emoji-picker" style="display:none;"></div>

  <!-- Fullscreen Image Viewer -->
  <div id="fullscreen-image-viewer" tabindex="0" role="dialog" aria-modal="true" aria-label="Fullscreen image viewer">
    <img src="" alt="Fullscreen Image" />
    <div class="close-btn">&times;</div>
  </div>

  <!-- Loading overlay -->
  <div id="loading-overlay" class="loading-overlay" style="display: none;">
    <div class="loading-spinner"></div>
  </div>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { 
      getAuth, 
      onAuthStateChanged, 
      signOut,
      updateProfile
    } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import { 
      getFirestore, 
      doc, 
      getDoc, 
      setDoc, 
      updateDoc, 
      collection, 
      onSnapshot, 
      query, 
      orderBy, 
      addDoc,
      serverTimestamp,
      getDocs,
      where
    } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
    import { 
      getStorage,
      ref,
      uploadBytes,
      getDownloadURL
    } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-storage.js";

    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyCW2RJIku0JLJZTUu0YA9yKO8zjtX29fAo",
      authDomain: "muah-feed.firebaseapp.com",
      databaseURL: "https://muah-feed-default-rtdb.firebaseio.com",
      projectId: "muah-feed",
      storageBucket: "muah-feed.appspot.com",
      messagingSenderId: "442314397706",
      appId: "1:442314397706:web:a69e3958257fb13b3667f3",
      measurementId: "G-S86S229F1T"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // DOM elements
    const chatMessages = document.getElementById('chat-messages');
    const messageInput = document.getElementById('message-input');
    const emojiBtn = document.getElementById('emoji-btn');
    const emojiPicker = document.querySelector('.emoji-picker');
    const uploadImageBtn = document.getElementById('upload-image-btn');
    const uploadImageInput = document.getElementById('upload-image-input');
    const loadingOverlay = document.getElementById('loading-overlay');
    const fullscreenViewer = document.getElementById('fullscreen-image-viewer');
    const fullscreenImg = fullscreenViewer.querySelector('img');
    const fullscreenCloseBtn = fullscreenViewer.querySelector('.close-btn');
    const noSongNotification = document.getElementById('no-song-notification');
    const dismissNoSongBtn = document.getElementById('dismiss-no-song-btn');
    const setSongLink = document.getElementById('set-song-link');
    const settingsCog = document.querySelector('.fa-cog');
    const searchInput = document.querySelector('#header input[type="search"]');
    const serverIcons = document.querySelectorAll('.server-icon');
    const channelItems = document.querySelectorAll('.list-item');

    // User data
    let currentUser = null;
    let userData = null;
    let replyToMessageId = null;
    let currentChannel = 'general';
    let currentServer = 'KAMBA';

    // Constants
    const emojis = ['ðŸ˜€','ðŸ˜‚','ðŸ¥°','ðŸ˜Ž','ðŸ˜¢','ðŸ˜¡','ðŸ¤”','ðŸ¤¯','ðŸ¥³','ðŸ˜´','â¤ï¸','ðŸ‘','ðŸ‘Ž','ðŸ”¥','ðŸŽ‰','ðŸ’¯','ðŸ¤£','ðŸ˜','ðŸ˜­','ðŸ™„'];
    const MAX_IMAGE_SIZE_MB = 6;
    const MAX_TOTAL_UPLOAD_MB = 6;
    const NO_SONG_DISMISS_KEY = 'noSongDismissedTime';

    // Initialize audio for background song
    const backgroundAudio = new Audio();
    backgroundAudio.loop = true;

    // --- AUTH STATE MANAGEMENT ---
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = 'sign.html';
        return;
      }
      
      currentUser = user;
      showLoading();
      
      try {
        // Load or create user data
        await loadOrCreateUserData();
        
        // Update UI with user data
        updateUserUI();
        
        // Check and setup background song
        checkBackgroundSong();
        
        // Load initial data
        loadInitialData();
        
      } catch (error) {
        console.error('Initialization error:', error);
        showError('Failed to initialize. Please refresh the page.');
      } finally {
        hideLoading();
      }

      // Setup event listeners
      setupEventListeners();
    });

    // Load or create user data in Firestore
    async function loadOrCreateUserData() {
      const userDocRef = doc(db, 'Kamba_users', currentUser.email);
      const userSnap = await getDoc(userDocRef);
      
      if (userSnap.exists()) {
        userData = userSnap.data();
        
        // Migrate old data if needed
        if (!userData.sparks) {
          userData.sparks = 0;
          await updateDoc(userDocRef, { sparks: 0 });
        }
        if (!userData.accountStatus) {
          userData.accountStatus = 'green';
          await updateDoc(userDocRef, { accountStatus: 'green' });
        }
      } else {
        // Create new user document
        userData = { 
          name: currentUser.displayName || currentUser.email.split('@')[0],
          phone: '',
          accountStatus: 'green',
          sparks: 0,
          songUrl: '',
          songVolume: 50,
          agreedTerms: false,
          lastSeen: serverTimestamp(),
          createdAt: serverTimestamp()
        };
        await setDoc(userDocRef, userData);
      }
      
      // Check and prompt for terms agreement
      if (!userData.agreedTerms) {
        const agreed = confirm('Do you agree to the terms and conditions?');
        if (agreed) {
          await updateDoc(userDocRef, { agreedTerms: true });
          userData.agreedTerms = true;
        } else {
          await signOut(auth);
          return;
        }
      }
    }

    // Update UI with user data
    function updateUserUI() {
      // Update user section in sidebar
      const userSection = document.querySelector('.user-section .user-name');
      if (userSection) {
        userSection.textContent = userData.name || currentUser.email.split('@')[0];
      }
      
      // Update user avatar
      const userAvatar = document.querySelector('.user-section .user-avatar');
      if (userAvatar) {
        if (currentUser.photoURL) {
          userAvatar.innerHTML = `<img src="${currentUser.photoURL}" alt="User avatar">`;
        } else {
          const initial = (userData.name || currentUser.email[0]).toUpperCase();
          userAvatar.innerHTML = `<span>${initial}</span>`;
          userAvatar.className = `user-avatar ${userData.accountStatus || 'green'}`;
        }
      }
      
      // Update channel header
      updateChannelHeader();
    }

    // Update channel header with current channel info
    function updateChannelHeader() {
      const channelName = document.querySelector('.channel-name');
      const channelTopic = document.querySelector('.channel-topic');
      
      if (channelName) channelName.textContent = `#${currentChannel}`;
      if (channelTopic) {
        channelTopic.textContent = getChannelTopic(currentChannel);
      }
    }

    // Get channel topic based on channel name
    function getChannelTopic(channel) {
      const topics = {
        'general': 'Welcome to the general chat!',
        'announcements': 'Official announcements from KAMBA',
        'welcome': 'Introduce yourself to the community',
        'help': 'Get help with KAMBA Forum'
      };
      return topics[channel] || `Welcome to ${channel} channel`;
    }

    // Check and setup background song
    function checkBackgroundSong() {
      if (userData.songUrl) {
        backgroundAudio.src = userData.songUrl;
        backgroundAudio.volume = (userData.songVolume || 50) / 100;
        backgroundAudio.play().catch(e => console.log('Audio play failed:', e));
        noSongNotification.style.display = 'none';
      } else {
        checkNoSongNotification();
      }
    }

    // Check and show no song notification
    function checkNoSongNotification() {
      const dismissedTime = localStorage.getItem(NO_SONG_DISMISS_KEY);
      const now = Date.now();
      if (!userData.songUrl && (!dismissedTime || now - dismissedTime > 10 * 60 * 60 * 1000)) {
        noSongNotification.style.display = 'flex';
      } else {
        noSongNotification.style.display = 'none';
      }
    }

    // Load initial data
    function loadInitialData() {
      // Load messages for current channel
      loadMessages();
      
      // Load servers and channels
      loadServersAndChannels();
      
      // Load user list
      loadUserList();
    }

    // Load messages for current channel
    function loadMessages() {
      const messagesRef = collection(db, 'servers', currentServer, 'channels', currentChannel, 'messages');
      const messagesQuery = query(messagesRef, orderBy('timestamp', 'asc'));
      
      onSnapshot(messagesQuery, (snapshot) => {
        chatMessages.innerHTML = '';
        let lastUserId = null;
        let messageGroup = null;
        
        snapshot.forEach((doc) => {
          const msg = doc.data();
          const isSameUser = msg.userId === lastUserId;
          lastUserId = msg.userId;
          
          if (!isSameUser || !messageGroup) {
            messageGroup = document.createElement('div');
            messageGroup.className = 'message-group';
            chatMessages.appendChild(messageGroup);
          }
          
          const messageEl = createMessageElement(doc.id, msg);
          messageGroup.appendChild(messageEl);
        });
        
        scrollToBottom();
      }, (error) => {
        console.error('Error listening to messages:', error);
        showError('Failed to load messages. Please refresh the page.');
      });
    }

    // Load servers and channels
    async function loadServersAndChannels() {
      // In a real app, you would fetch these from Firestore
      // For demo purposes, we're using the static HTML content
      
      // Add click handlers to server icons
      serverIcons.forEach(icon => {
        icon.addEventListener('click', () => {
          serverIcons.forEach(i => i.classList.remove('active'));
          icon.classList.add('active');
          currentServer = icon.getAttribute('title') || 'KAMBA';
          loadMessages();
        });
      });
      
      // Add click handlers to channel items
      channelItems.forEach(item => {
        item.addEventListener('click', () => {
          channelItems.forEach(i => i.classList.remove('active'));
          item.classList.add('active');
          currentChannel = item.textContent.toLowerCase();
          updateChannelHeader();
          loadMessages();
        });
      });
    }

    // Load user list
    async function loadUserList() {
      // In a real app, you would fetch users from Firestore
      // For demo purposes, we're using the static HTML content
    }

    // Create message DOM element
    function createMessageElement(id, msg) {
      const username = msg.name || (msg.userId ? msg.userId.split('@')[0] : 'Unknown');
      const status = msg.accountStatus || 'green';
      
      const el = document.createElement('div');
      el.className = 'message';
      el.dataset.id = id;

      // Avatar
      const avatarEl = document.createElement('div');
      avatarEl.className = `message-avatar ${status}`;
      
      if (msg.avatarUrl) {
        avatarEl.innerHTML = `<img src="${msg.avatarUrl}" alt="${username}'s avatar">`;
      } else {
        const initial = username[0].toUpperCase();
        avatarEl.innerHTML = `<div class="avatar-placeholder">${initial}</div>`;
      }
      el.appendChild(avatarEl);

      // Message content
      const contentEl = document.createElement('div');
      contentEl.className = 'message-content';
      
      // Message header (username, timestamp)
      const headerEl = document.createElement('div');
      headerEl.className = 'message-header';
      
      const usernameEl = document.createElement('span');
      usernameEl.className = `message-username ${status}`;
      usernameEl.textContent = username;
      headerEl.appendChild(usernameEl);
      
      if (msg.isBot) {
        const botTag = document.createElement('span');
        botTag.className = 'message-bot-tag';
        botTag.textContent = 'BOT';
        headerEl.appendChild(botTag);
      }
      
      const timestampEl = document.createElement('span');
      timestampEl.className = 'message-timestamp';
      timestampEl.textContent = formatTimestamp(msg.timestamp);
      headerEl.appendChild(timestampEl);
      
      contentEl.appendChild(headerEl);

      // Reply to (if any)
      if (msg.replyTo) {
        const replyEl = document.createElement('div');
        replyEl.className = 'message-reply';
        
        const replyUsername = document.createElement('span');
        replyUsername.className = 'message-reply-username';
        replyUsername.textContent = msg.replyToName || 'Unknown';
        replyEl.appendChild(replyUsername);
        
        const replyContent = document.createElement('span');
        replyContent.className = 'message-reply-content';
        replyContent.textContent = msg.replyToText || '';
        replyEl.appendChild(replyContent);
        
        contentEl.appendChild(replyEl);
      }

      // Message text
      const textEl = document.createElement('div');
      textEl.className = 'message-text';
      textEl.textContent = msg.text || '';
      contentEl.appendChild(textEl);

      // Images
      if (msg.images && msg.images.length > 0) {
        const attachmentsEl = document.createElement('div');
        attachmentsEl.className = 'message-attachments';
        
        msg.images.forEach((imgUrl) => {
          const attachmentEl = document.createElement('div');
          attachmentEl.className = 'message-attachment';
          
          const img = document.createElement('img');
          img.src = imgUrl;
          img.alt = 'Chat image';
          img.addEventListener('click', () => openFullscreenImage(imgUrl));
          attachmentEl.appendChild(img);
          
          const downloadEl = document.createElement('div');
          downloadEl.className = 'message-attachment-download';
          downloadEl.innerHTML = '<i class="fas fa-download"></i>';
          downloadEl.addEventListener('click', (e) => {
            e.stopPropagation();
            downloadImage(imgUrl);
          });
          attachmentEl.appendChild(downloadEl);
          
          attachmentsEl.appendChild(attachmentEl);
        });
        
        contentEl.appendChild(attachmentsEl);
      }

      // Message actions
      const actionsEl = document.createElement('div');
      actionsEl.className = 'message-actions';
      
      const replyBtn = document.createElement('i');
      replyBtn.className = 'message-action fas fa-reply';
      replyBtn.title = 'Reply';
      replyBtn.addEventListener('click', () => {
        replyToMessageId = id;
        messageInput.focus();
        messageInput.value = `@${username} `;
      });
      actionsEl.appendChild(replyBtn);
      
      // Add like button for projects (only in project channels)
      if (currentChannel.includes('project-')) {
        const likeBtn = document.createElement('i');
        likeBtn.className = 'message-action fas fa-heart';
        likeBtn.title = 'Like';
        likeBtn.addEventListener('click', () => likeProject(id));
        actionsEl.appendChild(likeBtn);
        
        const likeCount = document.createElement('span');
        likeCount.className = 'like-count';
        likeCount.textContent = msg.likes ? msg.likes.length : 0;
        actionsEl.appendChild(likeCount);
      }
      
      el.appendChild(contentEl);
      el.appendChild(actionsEl);

      return el;
    }

    // Like a project (adds Sparks to the creator)
    async function likeProject(messageId) {
      if (!currentUser) return;
      
      try {
        const messageRef = doc(db, 'servers', currentServer, 'channels', currentChannel, 'messages', messageId);
        const messageSnap = await getDoc(messageRef);
        
        if (messageSnap.exists()) {
          const messageData = messageSnap.data();
          const likes = messageData.likes || [];
          
          // Check if user already liked
          if (likes.includes(currentUser.email)) {
            showError('You already liked this project');
            return;
          }
          
          // Add like
          likes.push(currentUser.email);
          await updateDoc(messageRef, { likes });
          
          // Add Sparks to creator
          if (messageData.userId && messageData.userId !== currentUser.email) {
            const creatorRef = doc(db, 'Kamba_users', messageData.userId);
            await updateDoc(creatorRef, {
              sparks: increment(2) // 2 Sparks per like
            });
            
            // Check for status upgrade
            await checkStatusUpgrade(messageData.userId);
          }
        }
      } catch (error) {
        console.error('Error liking project:', error);
        showError('Failed to like project. Please try again.');
      }
    }

    // Check if user should be upgraded to next status
    async function checkStatusUpgrade(userId) {
      const userRef = doc(db, 'Kamba_users', userId);
      const userSnap = await getDoc(userRef);
      
      if (userSnap.exists()) {
        const user = userSnap.data();
        let newStatus = user.accountStatus;
        
        if (user.sparks >= 1000 && user.accountStatus !== 'red') {
          newStatus = 'violet';
        } else if (user.sparks >= 100 && user.accountStatus === 'green') {
          newStatus = 'blue';
        }
        
        if (newStatus !== user.accountStatus) {
          await updateDoc(userRef, { accountStatus: newStatus });
        }
      }
    }

    // Firebase increment function
    function increment(value) {
      return {
        increment: value
      };
    }

    // Format timestamp
    function formatTimestamp(timestamp) {
      if (!timestamp) return 'Just now';
      
      const date = timestamp.toDate();
      const now = new Date();
      const diff = now - date;
      
      if (diff < 60000) return 'Just now';
      if (diff < 3600000) return `${Math.floor(diff / 60000)}m ago`;
      if (diff < 86400000) return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      
      return date.toLocaleDateString([], { month: 'short', day: 'numeric' });
    }

    // Open fullscreen image viewer
    function openFullscreenImage(url) {
      fullscreenImg.src = url;
      fullscreenViewer.style.display = 'flex';
    }

    // Download image
    function downloadImage(url) {
      const a = document.createElement('a');
      a.href = url;
      a.download = url.split('/').pop() || 'image';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    }

    // Send message function
    async function sendMessage() {
      const text = sanitizeInput(messageInput.value.trim());
      if (!text && !uploadImageInput.files.length) return;

      showLoading();
      
      try {
        // Prepare images uploading
        let uploadedImageUrls = [];
        if (uploadImageInput.files.length > 0) {
          uploadedImageUrls = await uploadImages(uploadImageInput.files);
          if (uploadedImageUrls.length === 0 && !text) {
            showError('Please enter a message or select valid images.');
            return;
          }
        }

        // Create message doc
        const newMsg = {
          userId: currentUser.email,
          name: userData.name,
          text: text,
          timestamp: serverTimestamp(),
          accountStatus: userData.accountStatus || 'green',
          replyTo: replyToMessageId || null,
          replyToName: null,
          replyToText: null,
          images: uploadedImageUrls,
        };

        // If replying, fetch reply message info
        if (replyToMessageId) {
          const replyDoc = await getDoc(
            doc(db, 'servers', currentServer, 'channels', currentChannel, 'messages', replyToMessageId)
          );
          if (replyDoc.exists()) {
            const replyData = replyDoc.data();
            newMsg.replyToName = replyData.name || replyData.userId.split('@')[0];
            newMsg.replyToText = replyData.text || '';
          }
        }

        // Add message to Firestore
        await addDoc(
          collection(db, 'servers', currentServer, 'channels', currentChannel, 'messages'),
          newMsg
        );

        // Reset input
        messageInput.value = '';
        uploadImageInput.value = null;
        replyToMessageId = null;
        
        // Scroll to bottom
        scrollToBottom();
      } catch (error) {
        console.error('Error sending message:', error);
        showError('Failed to send message. Please try again.');
      } finally {
        hideLoading();
      }
    }

    // Upload images to Firebase Storage
    async function uploadImages(files) {
      let totalSize = 0;
      let uploadedUrls = [];
      
      try {
        for (const file of files) {
          totalSize += file.size;
          if (file.size > MAX_IMAGE_SIZE_MB * 1024 * 1024) {
            showError(`Image "${file.name}" exceeds ${MAX_IMAGE_SIZE_MB}MB size limit.`);
            continue;
          }
          if (totalSize > MAX_TOTAL_UPLOAD_MB * 1024 * 1024) {
            showError(`Total images size exceeds ${MAX_TOTAL_UPLOAD_MB}MB limit.`);
            break;
          }
          
          // Upload to Firebase Storage
          const storageRef = ref(storage, `chat_images/${currentUser.uid}/${Date.now()}_${file.name}`);
          await uploadBytes(storageRef, file);
          const downloadURL = await getDownloadURL(storageRef);
          uploadedUrls.push(downloadURL);
        }
        return uploadedUrls;
      } catch (err) {
        console.error('Image upload error:', err);
        showError('Image upload failed. Please try again.');
        return [];
      }
    }

    // Search functionality
    async function search(query) {
      if (!query || query.length < 2) return;
      
      showLoading();
      
      try {
        // Search users
        const usersQuery = query(
          collection(db, 'Kamba_users'),
          where('name', '>=', query),
          where('name', '<=', query + '\uf8ff')
        );
        
        // Search channels
        const channelsQuery = query(
          collection(db, 'servers', currentServer, 'channels'),
          where('name', '>=', query),
          where('name', '<=', query + '\uf8ff')
        );
        
        // Execute queries in parallel
        const [usersSnapshot, channelsSnapshot] = await Promise.all([
          getDocs(usersQuery),
          getDocs(channelsQuery)
        ]);
        
        // Process results
        const results = [];
        
        usersSnapshot.forEach(doc => {
          results.push({
            type: 'user',
            id: doc.id,
            ...doc.data()
          });
        });
        
        channelsSnapshot.forEach(doc => {
          results.push({
            type: 'channel',
            id: doc.id,
            ...doc.data()
          });
        });
        
        // Display results (in a real app, you would show these in a dropdown)
        console.log('Search results:', results);
        
      } catch (error) {
        console.error('Search error:', error);
        showError('Search failed. Please try again.');
      } finally {
        hideLoading();
      }
    }

    // Sanitize input to prevent XSS
    function sanitizeInput(input) {
      const div = document.createElement('div');
      div.textContent = input;
      return div.innerHTML;
    }

    // Show error message
    function showError(message) {
      const errorEl = document.createElement('div');
      errorEl.className = 'error-message';
      errorEl.textContent = message;
      chatMessages.appendChild(errorEl);
      setTimeout(() => errorEl.remove(), 5000);
    }

    // Show loading overlay
    function showLoading() {
      loadingOverlay.style.display = 'flex';
    }

    // Hide loading overlay
    function hideLoading() {
      loadingOverlay.style.display = 'none';
    }

    // Scroll chat to bottom
    function scrollToBottom() {
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // Setup event listeners
    function setupEventListeners() {
      // Send message on Enter key
      messageInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
        
        // Auto-resize textarea
        messageInput.style.height = 'auto';
        messageInput.style.height = (messageInput.scrollHeight) + 'px';
      });

      // Upload button triggers hidden file input
      uploadImageBtn.addEventListener('click', () => uploadImageInput.click());

      // Emoji picker toggle
      emojiBtn.addEventListener('click', toggleEmojiPicker);
      document.addEventListener('click', (e) => {
        if (!emojiPicker.contains(e.target) && e.target !== emojiBtn) {
          emojiPicker.style.display = 'none';
        }
      });

      // Fullscreen image viewer
      fullscreenCloseBtn.addEventListener('click', () => {
        fullscreenViewer.style.display = 'none';
      });
      fullscreenViewer.addEventListener('click', (e) => {
        if (e.target === fullscreenViewer) {
          fullscreenViewer.style.display = 'none';
        }
      });

      // No song notification
      dismissNoSongBtn.addEventListener('click', () => {
        localStorage.setItem(NO_SONG_DISMISS_KEY, Date.now());
        noSongNotification.style.display = 'none';
      });
      setSongLink.addEventListener('click', (e) => {
        e.preventDefault();
        window.location.href = 'settings.html';
      });

      // Settings cog
      settingsCog.addEventListener('click', () => {
        window.location.href = 'settings.html';
      });

      // Search input
      searchInput.addEventListener('input', (e) => {
        const query = e.target.value.trim();
        if (query.length > 1) {
          search(query);
        }
      });
    }

    // Toggle emoji picker
    function toggleEmojiPicker() {
      if (emojiPicker.style.display === 'flex') {
        emojiPicker.style.display = 'none';
      } else {
        emojiPicker.style.display = 'flex';
        if (!emojiPicker.hasChildNodes()) {
          emojis.forEach((e) => {
            const btn = document.createElement('button');
            btn.textContent = e;
            btn.title = e;
            btn.addEventListener('click', () => {
              messageInput.value += e;
              messageInput.focus();
            });
            emojiPicker.appendChild(btn);
          });
        }
      }
    }
  </script>
</body>
</html>
