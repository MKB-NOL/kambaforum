<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>KAMBA Forum - Settings</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins&display=swap" rel="stylesheet">
<style>
  /* Basic reset and Discord style */
  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }
  body, html {
    height: 100%;
    background-color: #36393f;
    color: #dcddde;
    font-family: "Poppins", "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    display: flex;
    flex-direction: column;
  }
  header {
    background-color: #2f3136;
    padding: 1rem 2rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    color: white;
    border-bottom: 1px solid #202225;
  }
  header h1 {
    margin: 0;
    font-size: 1.5rem;
  }
  #signout-btn {
    background-color: #f04747;
    border: none;
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 4px;
    cursor: pointer;
    font-weight: bold;
  }
  #signout-btn:hover {
    background-color: #c03939;
  }
  #home-btn {
    background-color: #5865f2;
    border: none;
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 4px;
    cursor: pointer;
    font-weight: bold;
    margin-right: 1rem;
  }
  #home-btn:hover {
    background-color: #4752c4;
  }
  #main-content {
    display: flex;
    flex: 1;
    overflow: hidden;
  }
  #settings-sidebar {
    width: 250px;
    background-color: #2f3136;
    border-right: 1px solid #202225;
    padding: 1rem;
    display: flex;
    flex-direction: column;
  }
  .sidebar-item {
    display: flex;
    align-items: center;
    padding: 0.5rem;
    border-radius: 4px;
    cursor: pointer;
    margin-bottom: 0.3rem;
  }
  .sidebar-item:hover {
    background-color: #3a3d44;
  }
  .sidebar-item.active {
    background-color: #40444b;
  }
  #settings-main {
    flex: 1;
    padding: 2rem;
    overflow-y: auto;
  }
  #settings-container {
    background-color: #2f3136;
    border-radius: 8px;
    padding: 2rem;
    max-width: 800px;
    margin: 0 auto;
  }
  .settings-section {
    margin-bottom: 2rem;
    border-bottom: 1px solid #40444b;
    padding-bottom: 1.5rem;
    display: none;
  }
  .settings-section.active {
    display: block;
  }
  .settings-section:last-child {
    border-bottom: none;
  }
  .settings-title {
    font-size: 1.3rem;
    margin-bottom: 1.5rem;
    color: white;
    display: flex;
    align-items: center;
  }
  .settings-title .status-badge {
    margin-left: 0.8rem;
    font-size: 0.8rem;
    padding: 0.3rem 0.6rem;
    border-radius: 4px;
  }
  .status-badge.green {
    background-color: #43b581;
  }
  .status-badge.blue {
    background-color: #5865f2;
  }
  .status-badge.violet {
    background-color: #9b59b6;
  }
  .status-badge.red {
    background-color: #f04747;
  }
  .form-group {
    margin-bottom: 1.2rem;
  }
  .form-group label {
    display: block;
    margin-bottom: 0.5rem;
    color: #b9bbbe;
    font-size: 0.9rem;
  }
  .form-control {
    width: 100%;
    padding: 0.7rem;
    border-radius: 4px;
    border: none;
    background-color: #40444b;
    color: white;
    font-size: 1rem;
  }
  .form-control:focus {
    outline: 2px solid #5865f2;
  }
  .btn {
    padding: 0.7rem 1.2rem;
    border-radius: 4px;
    border: none;
    font-weight: bold;
    cursor: pointer;
    font-size: 1rem;
    transition: background-color 0.2s;
  }
  .btn-primary {
    background-color: #5865f2;
    color: white;
  }
  .btn-primary:hover {
    background-color: #4752c4;
  }
  .btn-danger {
    background-color: #f04747;
    color: white;
  }
  .btn-danger:hover {
    background-color: #c03939;
  }
  .permissions-list {
    margin-top: 1.5rem;
  }
  .permissions-list h4 {
    margin-bottom: 0.8rem;
    color: white;
  }
  .permission-item {
    display: flex;
    align-items: center;
    margin-bottom: 0.5rem;
    padding: 0.5rem;
    background-color: #36393f;
    border-radius: 4px;
  }
  .permission-icon {
    margin-right: 0.8rem;
    color: #43b581;
    width: 20px;
    text-align: center;
  }
  .sparks-count {
    display: flex;
    align-items: center;
    background-color: #36393f;
    padding: 1rem;
    border-radius: 8px;
    margin-bottom: 1.5rem;
  }
  .sparks-count i {
    color: #faa61a;
    font-size: 1.5rem;
    margin-right: 0.8rem;
  }
  .sparks-count span {
    font-size: 1.2rem;
    font-weight: bold;
    color: #faa61a;
  }
  .profile-pic-container {
    display: flex;
    align-items: center;
    margin-bottom: 1.5rem;
  }
  .profile-pic {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    background-color: #5865f2;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 2rem;
    font-weight: bold;
    color: white;
    margin-right: 1.5rem;
  }
  .profile-info {
    flex: 1;
  }
  .profile-name {
    font-size: 1.2rem;
    font-weight: bold;
    margin-bottom: 0.3rem;
  }
  .profile-status {
    display: flex;
    align-items: center;
  }
  .status-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    margin-right: 0.5rem;
  }
  .status-dot.green {
    background-color: #43b581;
  }
  .status-dot.blue {
    background-color: #5865f2;
  }
  .status-dot.violet {
    background-color: #9b59b6;
  }
  .status-dot.red {
    background-color: #f04747;
  }
  .volume-control {
    display: flex;
    align-items: center;
    gap: 1rem;
  }
  .volume-slider {
    flex: 1;
    -webkit-appearance: none;
    height: 6px;
    background: #40444b;
    border-radius: 3px;
    outline: none;
  }
  .volume-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 16px;
    height: 16px;
    border-radius: 50%;
    background: #5865f2;
    cursor: pointer;
  }
  .volume-value {
    width: 30px;
    text-align: center;
  }
  #file-input {
    display: none;
  }
  .btn-upload {
    background-color: #40444b;
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 4px;
    cursor: pointer;
    display: inline-block;
    margin-top: 0.5rem;
  }
  .btn-upload:hover {
    background-color: #4f545c;
  }
  .loading-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.7);
    justify-content: center;
    align-items: center;
    z-index: 1000;
  }
  .spinner {
    width: 50px;
    height: 50px;
    border: 5px solid #ccc;
    border-top-color: #5865f2;
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }
  @keyframes spin {
    to { transform: rotate(360deg); }
  }
  @media (max-width: 768px) {
    #main-content {
      flex-direction: column;
    }
    #settings-sidebar {
      width: 100%;
      border-right: none;
      border-bottom: 1px solid #202225;
    }
    #settings-main {
      padding: 1rem;
    }
    #settings-container {
      padding: 1.5rem;
    }
  }
  .analytics-list h4 {
    margin-bottom: 1rem;
  }
  .analytics-item {
    margin-bottom: 1rem;
    padding: 1rem;
    background-color: #36393f;
    border-radius: 4px;
  }
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>

<header>
  <h1>KAMBA Forum - Settings</h1>
  <button id="home-btn">Home</button>
  <button id="signout-btn">Sign Out</button>
</header>

<div id="main-content">
  <div id="settings-sidebar">
    <div class="sidebar-item active" data-section="profile">
      <span>Profile Settings</span>
    </div>
    <div class="sidebar-item" data-section="sparks">
      <span>Sparks Management</span>
    </div>
    <div class="sidebar-item" data-section="status">
      <span>Account Status & Permissions</span>
    </div>
    <div class="sidebar-item" data-section="analytics">
      <span>Analytics & Progress</span>
    </div>
    <div class="sidebar-item" data-section="danger">
      <span>Danger Zone</span>
    </div>
  </div>
  <div id="settings-main">
    <div id="settings-container">
      <div id="profile-section" class="settings-section active">
        <div class="settings-title">
          Profile Settings
          <span class="status-badge" id="status-badge">Green</span>
        </div>
        
        <div class="profile-pic-container">
          <div class="profile-pic" id="profile-pic">U</div>
          <div class="profile-info">
            <div class="profile-name" id="profile-name">Username</div>
            <div class="profile-status">
              <div class="status-dot" id="status-dot"></div>
              <span id="status-text">Green</span>
            </div>
          </div>
        </div>
      
        <div class="form-group">
          <label for="profile-picture">Profile Picture</label>
          <input type="file" id="file-input" accept="image/*" />
          <button class="btn-upload" id="upload-btn">
            <i class="fas fa-upload"></i> Upload New Picture
          </button>
        </div>
        
        <div class="form-group">
          <label for="background-song">Background Song</label>
          <select id="background-song" class="form-control">
            <option value="">No song</option>
            <option value="Music/Camila Cabello- Havana .mp3">Camila Cabello- Havana</option>
            <option value="Music/Charlie Puth- Attention .mp3">Charlie Puth- Attention</option>
            <option value="Music/Ed Sheeran- Perfect .mp3">Ed Sheeran- Perfect</option>
          </select>
          <button id="preview-btn">Preview</button>
        </div>
        
        <div class="form-group">
          <label for="volume">Volume</label>
          <div class="volume-control">
            <input type="range" id="volume" class="volume-slider" min="0" max="1" step="0.1" value="0.5" />
            <span class="volume-value" id="volume-value">50%</span>
          </div>
        </div>
        
        <button class="btn btn-primary" id="save-settings">Save Changes</button>
      </div>

      <div id="sparks-section" class="settings-section">
        <div class="settings-title">Sparks Management</div>
        <div class="sparks-count">
          <i class="fas fa-clover"></i>
          <span id="sparks-value">0</span> Sparks
        </div>
        <p>Current Sparks: <span id="current-sparks">0</span></p>
        <div class="form-group">
          <label>Send Sparks To (Username)</label>
          <input id="recipient-name" class="form-control" placeholder="Username">
        </div>
        <div class="form-group">
          <label>Amount</label>
          <input id="sparks-amount" type="number" class="form-control" min="1">
        </div>
        <button class="btn btn-primary" id="send-sparks">Send Sparks</button>
      </div>

      <div id="status-section" class="settings-section">
        <div class="settings-title">Account Status & Permissions</div>
        
        <div class="permissions-list">
          <h4>Your Current Permissions:</h4>
          <div id="permissions-container">
            <!-- Permissions will be added dynamically based on status -->
          </div>
        </div>
      </div>

      <div id="analytics-section" class="settings-section">
        <div class="settings-title">Analytics & Progress</div>
        <div class="analytics-list">
          <h4>My Projects</h4>
          <div id="projects-analytics"></div>
          <h4>My Groups</h4>
          <div id="groups-analytics"></div>
          <h4>My Communities</h4>
          <div id="communities-analytics"></div>
        </div>
      </div>

      <div id="danger-section" class="settings-section">
        <div class="settings-title">Danger Zone</div>
        
        <div class="form-group">
          <label>Delete Account</label>
          <p style="margin-bottom: 1rem; color: #b9bbbe;">This will permanently delete your account and all associated data.</p>
          <button class="btn btn-danger" id="delete-account">
            <i class="fas fa-trash"></i> Delete My Account
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="loading-overlay" id="loading">
  <div class="spinner"></div>
</div>

<audio id="preview-audio"></audio>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
  import {
    getAuth,
    signOut,
    onAuthStateChanged,
  } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
  import {
    getFirestore,
    doc,
    getDoc,
    updateDoc,
    deleteDoc,
    query,
    where,
    getDocs,
    increment,
    addDoc,
  } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
  import {
    getStorage,
    ref,
    uploadBytes,
    getDownloadURL,
  } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-storage.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCW2RJIku0JLJZTUu0YA9yKO8zjtX29fAo",
    authDomain: "muah-feed.firebaseapp.com",
    databaseURL: "https://muah-feed-default-rtdb.firebaseio.com",
    projectId: "muah-feed",
    storageBucket: "muah-feed.firebasestorage.app",
    messagingSenderId: "442314397706",
    appId: "1:442314397706:web:a69e3958257fb13b3667f3",
    measurementId: "G-S86S229F1T",
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const storage = getStorage(app);

  // DOM Elements
  const homeBtn = document.getElementById("home-btn");
  const signoutBtn = document.getElementById("signout-btn");
  const profilePic = document.getElementById("profile-pic");
  const profileName = document.getElementById("profile-name");
  const statusDot = document.getElementById("status-dot");
  const statusText = document.getElementById("status-text");
  const statusBadge = document.getElementById("status-badge");
  const sparksValue = document.getElementById("sparks-value");
  const backgroundSong = document.getElementById("background-song");
  const previewBtn = document.getElementById("preview-btn");
  const previewAudio = document.getElementById("preview-audio");
  const volumeSlider = document.getElementById("volume");
  const volumeValue = document.getElementById("volume-value");
  const saveSettingsBtn = document.getElementById("save-settings");
  const uploadBtn = document.getElementById("upload-btn");
  const fileInput = document.getElementById("file-input");
  const permissionsContainer = document.getElementById("permissions-container");
  const deleteAccountBtn = document.getElementById("delete-account");
  const loadingOverlay = document.getElementById("loading");
  const currentSparks = document.getElementById("current-sparks");
  const recipientName = document.getElementById("recipient-name");
  const sparksAmount = document.getElementById("sparks-amount");
  const sendSparksBtn = document.getElementById("send-sparks");
  const projectsAnalytics = document.getElementById("projects-analytics");
  const groupsAnalytics = document.getElementById("groups-analytics");
  const communitiesAnalytics = document.getElementById("communities-analytics");
  const sidebarItems = document.querySelectorAll("#settings-sidebar .sidebar-item");

  // App State
  let currentUser = null;
  let currentUserData = null;

  // Initialize the app
  function init() {
    setupEventListeners();
    checkAuthState();
  }

  // Set up all event listeners
  function setupEventListeners() {
    // Home button
    homeBtn.addEventListener("click", () => window.location.href = "hello.html");

    // Sign out button
    signoutBtn.addEventListener("click", () => {
      signOut(auth).then(() => {
        window.location.href = "sign.html";
      });
    });

    // Sidebar navigation
    sidebarItems.forEach(item => {
      item.addEventListener("click", () => {
        sidebarItems.forEach(i => i.classList.remove("active"));
        item.classList.add("active");
        const section = item.dataset.section;
        document.querySelectorAll(".settings-section").forEach(sec => sec.classList.remove("active"));
        document.getElementById(section + "-section").classList.add("active");
      });
    });

    // Volume slider
    volumeSlider.addEventListener("input", () => {
      const value = Math.round(volumeSlider.value * 100);
      volumeValue.textContent = `${value}%`;
    });

    // Song preview
    previewBtn.addEventListener("click", () => {
      previewAudio.src = backgroundSong.value;
      if (previewAudio.paused && backgroundSong.value) {
        previewAudio.play();
        previewBtn.textContent = "Pause";
      } else {
        previewAudio.pause();
        previewBtn.textContent = "Preview";
      }
    });

    // Save settings
    saveSettingsBtn.addEventListener("click", saveSettings);

    // Upload profile picture
    uploadBtn.addEventListener("click", () => {
      fileInput.click();
    });

    fileInput.addEventListener("change", handleProfilePicUpload);

    // Send sparks
    sendSparksBtn.addEventListener("click", sendSparks);

    // Delete account
    deleteAccountBtn.addEventListener("click", deleteAccount);
  }

  // Check authentication state
  function checkAuthState() {
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = "sign.html";
        return;
      }
      currentUser = user;

      // Load user data from Firestore
      const userDocRef = doc(db, "Kamba_users", user.uid);
      const userDocSnap = await getDoc(userDocRef);
      
      if (!userDocSnap.exists()) {
        alert("User data not found. Please contact admin.");
        return;
      }
      
      currentUserData = userDocSnap.data();
      updateUI();
      loadAnalytics();
    });
  }

  // Update UI with user data
  function updateUI() {
    // Profile info
    const displayName = currentUserData.displayName || simplifyEmail(currentUser.email);
    profilePic.textContent = displayName.charAt(0).toUpperCase();
    profileName.textContent = displayName;
    
    // Set random color for profile pic
    const colors = ['#5865f2', '#57f287', '#f04747', '#eb459e', '#ed4245', '#faa61a'];
    const randomColor = colors[Math.floor(Math.random() * colors.length)];
    profilePic.style.backgroundColor = randomColor;

    // Status and sparks
    const status = getUserStatus(currentUserData);
    statusDot.className = "status-dot " + status;
    statusText.textContent = capitalizeFirstLetter(status);
    statusBadge.className = "status-badge " + status;
    statusBadge.textContent = capitalizeFirstLetter(status);
    sparksValue.textContent = currentUserData.sparks || 0;
    currentSparks.textContent = currentUserData.sparks || 0;

    // Background song and volume
    backgroundSong.value = currentUserData.song || "";
    volumeSlider.value = currentUserData.volume || 0.5;
    volumeValue.textContent = `${Math.round((currentUserData.volume || 0.5) * 100)}%`;

    // Update permissions based on status
    updatePermissionsDisplay(status);
  }

  // Get user status based on sparks
  function getUserStatus(userData) {
    if (!userData) return "green";
    if (userData.isAdmin) return "red";
    const sparks = userData.sparks || 0;
    if (sparks >= 1000) return "violet";
    if (sparks >= 100) return "blue";
    return "green";
  }

  // Update permissions display based on status
  function updatePermissionsDisplay(status) {
    permissionsContainer.innerHTML = "";
    
    // Common permissions for all users
    addPermissionItem("Create projects", true);
    addPermissionItem("Send and receive sparks", true);

    // Status-specific permissions
    switch (status) {
      case "blue":
        addPermissionItem("Create up to 3 groups", true);
        break;
      case "violet":
        addPermissionItem("Create unlimited groups", true);
        addPermissionItem("Create up to 2 communities", true);
        break;
      case "red":
        addPermissionItem("Create unlimited groups", true);
        addPermissionItem("Create unlimited communities", true);
        addPermissionItem("Admin privileges", true);
        break;
      default: // green
        addPermissionItem("Create groups", false, "Requires Blue status (100+ Sparks)");
        addPermissionItem("Create communities", false, "Requires Violet status (1000+ Sparks)");
    }

    // Edit/delete permissions
    addPermissionItem("Edit your content", true);
    addPermissionItem("Delete your content", status !== "green");
  }

  // Helper to add a permission item
  function addPermissionItem(text, hasPermission, tooltip = "") {
    const item = document.createElement("div");
    item.className = "permission-item";
    
    const icon = document.createElement("div");
    icon.className = "permission-icon";
    icon.innerHTML = hasPermission ? '<i class="fas fa-check-circle"></i>' : '<i class="fas fa-times-circle" style="color:#f04747"></i>';
    
    const textSpan = document.createElement("span");
    textSpan.textContent = text;
    
    item.appendChild(icon);
    item.appendChild(textSpan);
    
    if (tooltip) {
      item.title = tooltip;
      item.style.opacity = "0.7";
    }
    
    permissionsContainer.appendChild(item);
  }

  // Handle profile picture upload
  async function handleProfilePicUpload(e) {
    const file = e.target.files[0];
    if (!file) return;

    try {
      showLoading();
      
      // Upload to Firebase Storage
      const storageRef = ref(storage, `profile_pics/${currentUser.uid}`);
      await uploadBytes(storageRef, file);
      
      // Get download URL
      const downloadURL = await getDownloadURL(storageRef);
      
      // Update user document with new profile pic URL
      await updateDoc(doc(db, "Kamba_users", currentUser.uid), {
        profilePic: downloadURL
      });
      
      // Update UI
      profilePic.style.backgroundImage = `url(${downloadURL})`;
      profilePic.textContent = "";
      
      hideLoading();
      alert("Profile picture updated successfully!");
    } catch (error) {
      hideLoading();
      console.error("Error uploading profile picture:", error);
      alert("Failed to upload profile picture");
    }
  }

  // Save settings
  async function saveSettings() {
    try {
      showLoading();
      
      await updateDoc(doc(db, "Kamba_users", currentUser.uid), {
        song: backgroundSong.value.trim(),
        volume: parseFloat(volumeSlider.value)
      });
      
      hideLoading();
      alert("Settings saved successfully!");
    } catch (error) {
      hideLoading();
      console.error("Error saving settings:", error);
      alert("Failed to save settings");
    }
  }

  // Send sparks
  async function sendSparks() {
    const name = recipientName.value.trim();
    const amount = parseInt(sparksAmount.value);
    if (!name || isNaN(amount) || amount < 1 || amount > currentUserData.sparks) {
      alert("Invalid amount or recipient");
      return;
    }

    try {
      showLoading();
      const q = query(collection(db, "Kamba_users"), where("displayName", "==", name));
      const snap = await getDocs(q);
      if (snap.empty) {
        alert("User not found");
        hideLoading();
        return;
      }
      const recipientDoc = snap.docs[0];
      const recipientUid = recipientDoc.id;

      if (recipientUid === currentUser.uid) {
        alert("Cannot send to self");
        hideLoading();
        return;
      }

      await updateDoc(doc(db, "Kamba_users", currentUser.uid), {sparks: increment(-amount)});
      await updateDoc(doc(db, "Kamba_users", recipientUid), {sparks: increment(amount)});

      await addDoc(collection(db, "Kamba_notifications"), {
        userId: recipientUid,
        message: `Received ${amount} sparks from ${currentUserData.displayName}`,
        type: "sparks-received",
        from: currentUserData.displayName,
        amount,
        timestamp: Date.now()
      });

      await addDoc(collection(db, "Kamba_notifications"), {
        userId: currentUser.uid,
        message: `Sent ${amount} sparks to ${name}`,
        type: "sparks-sent",
        to: name,
        amount,
        timestamp: Date.now()
      });

      // Update local
      currentUserData.sparks -= amount;
      currentSparks.textContent = currentUserData.sparks;
      sparksValue.textContent = currentUserData.sparks;

      hideLoading();
      alert("Sparks sent successfully!");
    } catch (error) {
      hideLoading();
      console.error("Error sending sparks:", error);
      alert("Failed to send sparks");
    }
  }

  // Delete account
  async function deleteAccount() {
    if (!confirm("Are you sure you want to delete your account? This cannot be undone!")) {
      return;
    }
    
    try {
      showLoading();
      
      // Delete user document
      await deleteDoc(doc(db, "Kamba_users", currentUser.uid));
      
      // Delete user from authentication
      await currentUser.delete();
      
      // Sign out and redirect
      await signOut(auth);
      window.location.href = "sign.html";
    } catch (error) {
      hideLoading();
      console.error("Error deleting account:", error);
      alert("Failed to delete account. Please contact admin.");
    }
  }

  // Load analytics
  async function loadAnalytics() {
    // Projects
    const projectsQ = query(collection(db, "Kamba_projects"), where("creatorUid", "==", currentUser.uid));
    const projectsSnap = await getDocs(projectsQ);
    projectsAnalytics.innerHTML = "";
    projectsSnap.forEach(doc => {
      const data = doc.data();
      const div = document.createElement("div");
      div.className = "analytics-item";
      div.innerHTML = `
        <p>${data.name}</p>
        <p>Likes: ${data.likes} | Views: ${data.views} | Shares: ${data.shares} | Comments: ${data.comments.length}</p>
      `;
      projectsAnalytics.appendChild(div);
    });

    // Groups
    const groupsQ = query(collection(db, "Kamba_groups"), where("creatorUid", "==", currentUser.uid));
    const groupsSnap = await getDocs(groupsQ);
    groupsAnalytics.innerHTML = "";
    groupsSnap.forEach(doc => {
      const data = doc.data();
      const div = document.createElement("div");
      div.className = "analytics-item";
      div.innerHTML = `
        <p>${data.name}</p>
        <p>Members: ${data.members.length}</p>
      `;
      groupsAnalytics.appendChild(div);
    });

    // Communities
    const communitiesQ = query(collection(db, "Kamba_communities"), where("creatorUid", "==", currentUser.uid));
    const communitiesSnap = await getDocs(communitiesQ);
    communitiesAnalytics.innerHTML = "";
    communitiesSnap.forEach(doc => {
      const data = doc.data();
      const div = document.createElement("div");
      div.className = "analytics-item";
      div.innerHTML = `
        <p>${data.name}</p>
        <p>Members: ${data.members.length}</p>
      `;
      communitiesAnalytics.appendChild(div);
    });
  }

  // Helper: simplify email
  function simplifyEmail(email) {
    if (!email) return "User";
    return email.split("@")[0];
  }

  // Helper: capitalize first letter
  function capitalizeFirstLetter(string) {
    return string.charAt(0).toUpperCase() + string.slice(1);
  }

  // Show loading spinner
  function showLoading() {
    loadingOverlay.style.display = "flex";
  }

  // Hide loading spinner
  function hideLoading() {
    loadingOverlay.style.display = "none";
  }

  // Initialize the app
  init();
</script>

</body>
</html>
