<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>KAMBA Forum - Settings</title>
<style>
  /* Basic reset and Discord style */
  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }
  body, html {
    height: 100%;
    background-color: #36393f;
    color: #dcddde;
    font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    display: flex;
    flex-direction: column;
  }
  header {
    background-color: #2f3136;
    padding: 1rem 2rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    color: white;
    border-bottom: 1px solid #202225;
  }
  header h1 {
    margin: 0;
    font-size: 1.5rem;
  }
  #signout-btn {
    background-color: #f04747;
    border: none;
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 4px;
    cursor: pointer;
    font-weight: bold;
  }
  #signout-btn:hover {
    background-color: #c03939;
  }
  #main-content {
    display: flex;
    flex: 1;
    padding: 2rem;
    gap: 2rem;
  }
  #settings-container {
    flex: 1;
    background-color: #2f3136;
    border-radius: 8px;
    padding: 2rem;
    max-width: 800px;
    margin: 0 auto;
  }
  .settings-section {
    margin-bottom: 2rem;
    border-bottom: 1px solid #40444b;
    padding-bottom: 1.5rem;
  }
  .settings-section:last-child {
    border-bottom: none;
  }
  .settings-title {
    font-size: 1.3rem;
    margin-bottom: 1.5rem;
    color: white;
    display: flex;
    align-items: center;
  }
  .settings-title .status-badge {
    margin-left: 0.8rem;
    font-size: 0.8rem;
    padding: 0.3rem 0.6rem;
    border-radius: 4px;
  }
  .status-badge.green {
    background-color: #43b581;
  }
  .status-badge.blue {
    background-color: #5865f2;
  }
  .status-badge.violet {
    background-color: #9b59b6;
  }
  .status-badge.red {
    background-color: #f04747;
  }
  .form-group {
    margin-bottom: 1.2rem;
  }
  .form-group label {
    display: block;
    margin-bottom: 0.5rem;
    color: #b9bbbe;
    font-size: 0.9rem;
  }
  .form-control {
    width: 100%;
    padding: 0.7rem;
    border-radius: 4px;
    border: none;
    background-color: #40444b;
    color: white;
    font-size: 1rem;
  }
  .form-control:focus {
    outline: 2px solid #5865f2;
  }
  .btn {
    padding: 0.7rem 1.2rem;
    border-radius: 4px;
    border: none;
    font-weight: bold;
    cursor: pointer;
    font-size: 1rem;
    transition: background-color 0.2s;
  }
  .btn-primary {
    background-color: #5865f2;
    color: white;
  }
  .btn-primary:hover {
    background-color: #4752c4;
  }
  .btn-danger {
    background-color: #f04747;
    color: white;
  }
  .btn-danger:hover {
    background-color: #c03939;
  }
  .permissions-list {
    margin-top: 1.5rem;
  }
  .permissions-list h4 {
    margin-bottom: 0.8rem;
    color: white;
  }
  .permission-item {
    display: flex;
    align-items: center;
    margin-bottom: 0.5rem;
    padding: 0.5rem;
    background-color: #36393f;
    border-radius: 4px;
  }
  .permission-icon {
    margin-right: 0.8rem;
    color: #43b581;
    width: 20px;
    text-align: center;
  }
  .sparks-count {
    display: flex;
    align-items: center;
    background-color: #36393f;
    padding: 1rem;
    border-radius: 8px;
    margin-bottom: 1.5rem;
  }
  .sparks-count i {
    color: #faa61a;
    font-size: 1.5rem;
    margin-right: 0.8rem;
  }
  .sparks-count span {
    font-size: 1.2rem;
    font-weight: bold;
    color: #faa61a;
  }
  .profile-pic-container {
    display: flex;
    align-items: center;
    margin-bottom: 1.5rem;
  }
  .profile-pic {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    background-color: #5865f2;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 2rem;
    font-weight: bold;
    color: white;
    margin-right: 1.5rem;
  }
  .profile-info {
    flex: 1;
  }
  .profile-name {
    font-size: 1.2rem;
    font-weight: bold;
    margin-bottom: 0.3rem;
  }
  .profile-status {
    display: flex;
    align-items: center;
  }
  .status-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    margin-right: 0.5rem;
  }
  .status-dot.green {
    background-color: #43b581;
  }
  .status-dot.blue {
    background-color: #5865f2;
  }
  .status-dot.violet {
    background-color: #9b59b6;
  }
  .status-dot.red {
    background-color: #f04747;
  }
  .volume-control {
    display: flex;
    align-items: center;
    gap: 1rem;
  }
  .volume-slider {
    flex: 1;
    -webkit-appearance: none;
    height: 6px;
    background: #40444b;
    border-radius: 3px;
    outline: none;
  }
  .volume-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 16px;
    height: 16px;
    border-radius: 50%;
    background: #5865f2;
    cursor: pointer;
  }
  .volume-value {
    width: 30px;
    text-align: center;
  }
  #file-input {
    display: none;
  }
  .btn-upload {
    background-color: #40444b;
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 4px;
    cursor: pointer;
    display: inline-block;
    margin-top: 0.5rem;
  }
  .btn-upload:hover {
    background-color: #4f545c;
  }
  .loading-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.7);
    justify-content: center;
    align-items: center;
    z-index: 1000;
  }
  .spinner {
    width: 50px;
    height: 50px;
    border: 5px solid #ccc;
    border-top-color: #5865f2;
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }
  @keyframes spin {
    to { transform: rotate(360deg); }
  }
  @media (max-width: 768px) {
    #main-content {
      padding: 1rem;
    }
    #settings-container {
      padding: 1.5rem;
    }
  }
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>

<header>
  <h1>KAMBA Forum - Settings</h1>
  <button id="signout-btn">Sign Out</button>
</header>

<div id="main-content">
  <div id="settings-container">
    <div class="profile-pic-container">
      <div class="profile-pic" id="profile-pic">U</div>
      <div class="profile-info">
        <div class="profile-name" id="profile-name">Username</div>
        <div class="profile-status">
          <div class="status-dot" id="status-dot"></div>
          <span id="status-text">Green</span>
        </div>
      </div>
    </div>

    <div class="sparks-count">
      <i class="fas fa-clover"></i>
      <span id="sparks-value">0</span> Sparks
    </div>

    <div class="settings-section">
      <div class="settings-title">
        Profile Settings
        <span class="status-badge" id="status-badge">Green</span>
      </div>
      
      <div class="form-group">
        <label for="profile-picture">Profile Picture</label>
        <input type="file" id="file-input" accept="image/*" />
        <button class="btn-upload" id="upload-btn">
          <i class="fas fa-upload"></i> Upload New Picture
        </button>
      </div>
      
      <div class="form-group">
        <label for="background-song">Background Song URL</label>
        <input type="text" id="background-song" class="form-control" placeholder="Enter song URL" />
      </div>
      
      <div class="form-group">
        <label for="volume">Volume</label>
        <div class="volume-control">
          <input type="range" id="volume" class="volume-slider" min="0" max="1" step="0.1" value="0.5" />
          <span class="volume-value" id="volume-value">50%</span>
        </div>
      </div>
      
      <button class="btn btn-primary" id="save-settings">Save Changes</button>
    </div>

    <div class="settings-section">
      <div class="settings-title">Account Status & Permissions</div>
      
      <div class="permissions-list">
        <h4>Your Current Permissions:</h4>
        <div id="permissions-container">
          <!-- Permissions will be added dynamically based on status -->
        </div>
      </div>
    </div>

    <div class="settings-section">
      <div class="settings-title">Danger Zone</div>
      
      <div class="form-group">
        <label>Delete Account</label>
        <p style="margin-bottom: 1rem; color: #b9bbbe;">This will permanently delete your account and all associated data.</p>
        <button class="btn btn-danger" id="delete-account">
          <i class="fas fa-trash"></i> Delete My Account
        </button>
      </div>
    </div>
  </div>
</div>

<div class="loading-overlay" id="loading">
  <div class="spinner"></div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
  import {
    getAuth,
    signOut,
    onAuthStateChanged,
  } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
  import {
    getFirestore,
    doc,
    getDoc,
    updateDoc,
    deleteDoc,
  } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
  import {
    getStorage,
    ref,
    uploadBytes,
    getDownloadURL,
  } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-storage.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCW2RJIku0JLJZTUu0YA9yKO8zjtX29fAo",
    authDomain: "muah-feed.firebaseapp.com",
    databaseURL: "https://muah-feed-default-rtdb.firebaseio.com",
    projectId: "muah-feed",
    storageBucket: "muah-feed.firebasestorage.app",
    messagingSenderId: "442314397706",
    appId: "1:442314397706:web:a69e3958257fb13b3667f3",
    measurementId: "G-S86S229F1T",
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const storage = getStorage(app);

  // DOM Elements
  const signoutBtn = document.getElementById("signout-btn");
  const profilePic = document.getElementById("profile-pic");
  const profileName = document.getElementById("profile-name");
  const statusDot = document.getElementById("status-dot");
  const statusText = document.getElementById("status-text");
  const statusBadge = document.getElementById("status-badge");
  const sparksValue = document.getElementById("sparks-value");
  const backgroundSong = document.getElementById("background-song");
  const volumeSlider = document.getElementById("volume");
  const volumeValue = document.getElementById("volume-value");
  const saveSettingsBtn = document.getElementById("save-settings");
  const uploadBtn = document.getElementById("upload-btn");
  const fileInput = document.getElementById("file-input");
  const permissionsContainer = document.getElementById("permissions-container");
  const deleteAccountBtn = document.getElementById("delete-account");
  const loadingOverlay = document.getElementById("loading");

  // App State
  let currentUser = null;
  let currentUserData = null;

  // Initialize the app
  function init() {
    setupEventListeners();
    checkAuthState();
  }

  // Set up all event listeners
  function setupEventListeners() {
    // Sign out button
    signoutBtn.addEventListener("click", () => {
      signOut(auth).then(() => {
        window.location.href = "sign.html";
      });
    });

    // Volume slider
    volumeSlider.addEventListener("input", () => {
      const value = Math.round(volumeSlider.value * 100);
      volumeValue.textContent = `${value}%`;
    });

    // Save settings
    saveSettingsBtn.addEventListener("click", saveSettings);

    // Upload profile picture
    uploadBtn.addEventListener("click", () => {
      fileInput.click();
    });

    fileInput.addEventListener("change", handleProfilePicUpload);

    // Delete account
    deleteAccountBtn.addEventListener("click", deleteAccount);
  }

  // Check authentication state
  function checkAuthState() {
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = "sign.html";
        return;
      }
      currentUser = user;

      // Load user data from Firestore
      const userDocRef = doc(db, "Kamba_users", user.uid);
      const userDocSnap = await getDoc(userDocRef);
      
      if (!userDocSnap.exists()) {
        alert("User data not found. Please contact admin.");
        return;
      }
      
      currentUserData = userDocSnap.data();
      updateUI();
    });
  }

  // Update UI with user data
  function updateUI() {
    // Profile info
    const displayName = simplifyEmail(currentUser.email);
    profilePic.textContent = displayName.charAt(0).toUpperCase();
    profileName.textContent = displayName;
    
    // Set random color for profile pic
    const colors = ['#5865f2', '#57f287', '#f04747', '#eb459e', '#ed4245', '#faa61a'];
    const randomColor = colors[Math.floor(Math.random() * colors.length)];
    profilePic.style.backgroundColor = randomColor;

    // Status and sparks
    const status = getUserStatus(currentUserData);
    statusDot.className = "status-dot " + status;
    statusText.textContent = capitalizeFirstLetter(status);
    statusBadge.className = "status-badge " + status;
    statusBadge.textContent = capitalizeFirstLetter(status);
    sparksValue.textContent = currentUserData.sparks || 0;

    // Background song and volume
    backgroundSong.value = currentUserData.song || "";
    volumeSlider.value = currentUserData.volume || 0.5;
    volumeValue.textContent = `${Math.round((currentUserData.volume || 0.5) * 100)}%`;

    // Update permissions based on status
    updatePermissionsDisplay(status);
  }

  // Get user status based on sparks
  function getUserStatus(userData) {
    if (!userData) return "green";
    if (userData.isAdmin) return "red";
    const sparks = userData.sparks || 0;
    if (sparks >= 1000) return "violet";
    if (sparks >= 100) return "blue";
    return "green";
  }

  // Update permissions display based on status
  function updatePermissionsDisplay(status) {
    permissionsContainer.innerHTML = "";
    
    // Common permissions for all users
    addPermissionItem("Create projects", true);
    addPermissionItem("Send and receive sparks", true);

    // Status-specific permissions
    switch (status) {
      case "blue":
        addPermissionItem("Create up to 3 groups", true);
        break;
      case "violet":
        addPermissionItem("Create unlimited groups", true);
        addPermissionItem("Create up to 2 communities", true);
        break;
      case "red":
        addPermissionItem("Create unlimited groups", true);
        addPermissionItem("Create unlimited communities", true);
        addPermissionItem("Admin privileges", true);
        break;
      default: // green
        addPermissionItem("Create groups", false, "Requires Blue status (100+ Sparks)");
        addPermissionItem("Create communities", false, "Requires Violet status (1000+ Sparks)");
    }

    // Edit/delete permissions
    addPermissionItem("Edit your content", true);
    addPermissionItem("Delete your content", status !== "green");
  }

  // Helper to add a permission item
  function addPermissionItem(text, hasPermission, tooltip = "") {
    const item = document.createElement("div");
    item.className = "permission-item";
    
    const icon = document.createElement("div");
    icon.className = "permission-icon";
    icon.innerHTML = hasPermission ? '<i class="fas fa-check-circle"></i>' : '<i class="fas fa-times-circle" style="color:#f04747"></i>';
    
    const textSpan = document.createElement("span");
    textSpan.textContent = text;
    
    item.appendChild(icon);
    item.appendChild(textSpan);
    
    if (tooltip) {
      item.title = tooltip;
      item.style.opacity = "0.7";
    }
    
    permissionsContainer.appendChild(item);
  }

  // Handle profile picture upload
  async function handleProfilePicUpload(e) {
    const file = e.target.files[0];
    if (!file) return;

    try {
      showLoading();
      
      // Upload to Firebase Storage
      const storageRef = ref(storage, `profile_pics/${currentUser.uid}`);
      await uploadBytes(storageRef, file);
      
      // Get download URL
      const downloadURL = await getDownloadURL(storageRef);
      
      // Update user document with new profile pic URL
      await updateDoc(doc(db, "Kamba_users", currentUser.uid), {
        profilePic: downloadURL
      });
      
      // Update UI
      profilePic.style.backgroundImage = `url(${downloadURL})`;
      profilePic.textContent = "";
      
      hideLoading();
      alert("Profile picture updated successfully!");
    } catch (error) {
      hideLoading();
      console.error("Error uploading profile picture:", error);
      alert("Failed to upload profile picture");
    }
  }

  // Save settings
  async function saveSettings() {
    try {
      showLoading();
      
      await updateDoc(doc(db, "Kamba_users", currentUser.uid), {
        song: backgroundSong.value.trim(),
        volume: parseFloat(volumeSlider.value)
      });
      
      hideLoading();
      alert("Settings saved successfully!");
    } catch (error) {
      hideLoading();
      console.error("Error saving settings:", error);
      alert("Failed to save settings");
    }
  }

  // Delete account
  async function deleteAccount() {
    if (!confirm("Are you sure you want to delete your account? This cannot be undone!")) {
      return;
    }
    
    try {
      showLoading();
      
      // Delete user document
      await deleteDoc(doc(db, "Kamba_users", currentUser.uid));
      
      // Delete user from authentication
      await currentUser.delete();
      
      // Sign out and redirect
      await signOut(auth);
      window.location.href = "sign.html";
    } catch (error) {
      hideLoading();
      console.error("Error deleting account:", error);
      alert("Failed to delete account. Please contact admin.");
    }
  }

  // Helper: simplify email
  function simplifyEmail(email) {
    if (!email) return "User";
    return email.split("@")[0];
  }

  // Helper: capitalize first letter
  function capitalizeFirstLetter(string) {
    return string.charAt(0).toUpperCase() + string.slice(1);
  }

  // Show loading spinner
  function showLoading() {
    loadingOverlay.style.display = "flex";
  }

  // Hide loading spinner
  function hideLoading() {
    loadingOverlay.style.display = "none";
  }

  // Initialize the app
  init();
</script>

</body>
</html>
